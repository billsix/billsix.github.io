<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Standard Perspective Matrix &mdash; Model View Projection 0.0.1 documentation</title>
      <link rel="stylesheet" href="static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="static/css/my_theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="static/documentation_options.js?v=d45e8c67"></script>
        <script src="static/doctools.js?v=888ff710"></script>
        <script src="static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Matrix Stacks - Demo 19" href="ch19.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Model View Projection
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch01.html">Opening a Window - Demo 01</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch02.html">Draw A Rectange - Demo 02</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch03.html">Window Resizing and Proportionality - Demo 03</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch04.html">Moving the Paddles - Keyboard Input - Demo 04</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch05.html">Add Translate Method to Vertex - Demo 05</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch06.html">Modelspace - Demo 06</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch07.html">Rotations - Demo 07</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch08.html">Rotation Fix Attempt 1 - Demo 08</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch09.html">Rotation Fixed - Sequence of Transformations - Demo 09</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch10.html">Camera Space - Demo 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch11.html">Relative Objects - Demo 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch12.html">Rotate the Square - Demo 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch13.html">Rotate the Square Around Paddle 1 - Demo 13</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch14.html">Adding Depth - Z axis Demo 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch15.html">Adding Depth - Enable Depth Buffer - Demo 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch16.html">Moving Camera in 3D Space - Demo 16</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch17.html">3D Perspective - Demo 17</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch18.html">Lambda Stack - Demo 18</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch19.html">Matrix Stacks - Demo 19</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Standard Perspective Matrix</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#purpose">Purpose</a></li>
<li class="toctree-l2"><a class="reference internal" href="#description">Description</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#matrix-form-of-perspective-projection">Matrix form of perspective projection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#scale-camera-space-x-by-camera-space-z">Scale Camera-space x by Camera-space z</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scale-camera-space-y-by-camera-space-z">Scale Camera-space y by Camera-space z</a></li>
<li class="toctree-l4"><a class="reference internal" href="#translate-rectangular-prism-s-center-to-center">Translate Rectangular Prism’s Center to Center</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scale-by-inverse-of-the-dimensions-of-the-rectangular-prism">Scale by inverse of the dimensions of the Rectangular Prism</a></li>
<li class="toctree-l4"><a class="reference internal" href="#premultiply-the-matricies">Premultiply the matricies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#clip-space">Clip Space</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#remove-z-of-camera-space-from-part-of-the-matrix">Remove Z of Camera Space from Part of the Matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="#remove-z-of-camera-space-from-the-rest-of-the-matrix">Remove Z of Camera Space from the Rest of the Matrix</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Model View Projection</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Standard Perspective Matrix</li>
      <li class="wy-breadcrumbs-aside">
            <a href="sources/perspective.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="standard-perspective-matrix">
<h1>Standard Perspective Matrix<a class="headerlink" href="#standard-perspective-matrix" title="Link to this heading">¶</a></h1>
<section id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Link to this heading">¶</a></h2>
<p>Derive the standard perspective matrix that OpenGL expects.</p>
</section>
<section id="description">
<h2>Description<a class="headerlink" href="#description" title="Link to this heading">¶</a></h2>
<figure class="align-center" id="id1">
<img alt="Demo 11" src="images/perspective.png" />
<figcaption>
<p><span class="caption-text">Turn our NDC into Clip Space</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<section id="matrix-form-of-perspective-projection">
<h3>Matrix form of perspective projection<a class="headerlink" href="#matrix-form-of-perspective-projection" title="Link to this heading">¶</a></h3>
<figure class="align-center">
<img alt="Frustum 2" src="images/frustum2.png" />
</figure>
<section id="scale-camera-space-x-by-camera-space-z">
<h4>Scale Camera-space x by Camera-space z<a class="headerlink" href="#scale-camera-space-x-by-camera-space-z" title="Link to this heading">¶</a></h4>
<div class="math">
<p><img src="images/math/b23cfb38f6931f4cf7085148ee62a840ea50116d.svg" alt="\vec{f}_{1}(\begin{bmatrix}
                          {x_c} \\
                          {y_c} \\
                          {z_c} \\
                          {w_c=1} \\
                \end{bmatrix}; nearZ_c)   = \begin{bmatrix}
           {nearZ_c \over \textcolor{red}{z_c}} &amp; 0 &amp; 0 &amp; 0 \\
           0  &amp;               1 &amp; 0 &amp; 0 \\
           0  &amp;               0 &amp; 1 &amp; 0 \\
           0, &amp;               0 &amp; 0 &amp; 1
                \end{bmatrix}  *
                 \begin{bmatrix}
                          {x_c} \\
                          {y_c} \\
                          {z_c} \\
                          {w_c=1} \\
                \end{bmatrix}"/></p>
</div><p>resulting in</p>
<figure class="align-center" id="id2">
<img alt="Frustum 3" src="images/frustum3.png" />
<figcaption>
<p><span class="caption-text">Scale the camera space x by the camera space z</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="scale-camera-space-y-by-camera-space-z">
<h4>Scale Camera-space y by Camera-space z<a class="headerlink" href="#scale-camera-space-y-by-camera-space-z" title="Link to this heading">¶</a></h4>
<div class="math">
<p><img src="images/math/94bb9d61259c65f7ead975132da5efe0331bc084.svg" alt="(\vec{f}_{2} ; nearZ_c) ( \begin{bmatrix}
                     {x_c} \\
                     {y_c} \\
                     {z_c} \\
                     {w_c=1}
           \end{bmatrix})  = \begin{bmatrix}
  1 &amp; 0 &amp;                  0 &amp; 0 \\
  0 &amp; {nearZ_c \over \textcolor{red}{z_c}}    &amp;       0 &amp; 0 \\
  0 &amp; 0 &amp;                  1 &amp; 0 \\
  0 &amp; 0 &amp;                  0 &amp; 1
           \end{bmatrix}  *
            \begin{bmatrix}
                     {x_c} \\
                     {y_c} \\
                     {z_c} \\
                     {w_c=1} \\
           \end{bmatrix}"/></p>
</div><p>resulting in</p>
<figure class="align-center" id="id3">
<img alt="Frustum 4" src="images/frustum4.png" />
<figcaption>
<p><span class="caption-text">Scale the camera space y by the cameraspace z</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="translate-rectangular-prism-s-center-to-center">
<h4>Translate Rectangular Prism’s Center to Center<a class="headerlink" href="#translate-rectangular-prism-s-center-to-center" title="Link to this heading">¶</a></h4>
<p><img class="math" src="images/math/930e808b5d82af5691d2f4dd35fdd01d2ef979ee.svg" alt="x_{midpoint} = 0"/>  // centered on x</p>
<p><img class="math" src="images/math/2b812c038c7fd10e9e9d70e00e7d0f0f9202e2a3.svg" alt="y_{midpoint} = 0"/>  // centered on y</p>
<p><img class="math" src="images/math/aad4a980fc7164f00b1da0f17458e9d2a2e7c272.svg" alt="z_{midpoint} = {{{farZ}_c + {nearZ}_c} \over 2}"/>;</p>
<div class="math">
<p><img src="images/math/c80247513d0a3db96475504b3c1e2dfe3551e96f.svg" alt="(\vec{f}_{3} ; nearZ_c) ( \begin{bmatrix}
                           {x_c} \\
                           {y_c} \\
                           {z_c} \\
                           {w_c=1}
                 \end{bmatrix})
= \begin{bmatrix}
        1 &amp; 0 &amp; 0 &amp; 0 \\
        0 &amp; 1 &amp; 0 &amp; 0 \\
        0 &amp; 0 &amp; 1 &amp; {-{{farZ_c + nearZ_c} \over 2}} \\
        0 &amp; 0 &amp; 0 &amp; 1
                 \end{bmatrix}  *
                  \begin{bmatrix}
                           {x_c} \\
                           {y_c} \\
                           {z_c} \\
                           {w_c=1} \\
                 \end{bmatrix}"/></p>
</div><figure class="align-center">
<img alt="Frustum 5" src="images/frustum5.png" />
</figure>
</section>
<section id="scale-by-inverse-of-the-dimensions-of-the-rectangular-prism">
<h4>Scale by inverse of the dimensions of the Rectangular Prism<a class="headerlink" href="#scale-by-inverse-of-the-dimensions-of-the-rectangular-prism" title="Link to this heading">¶</a></h4>
<p><img class="math" src="images/math/6c4f0433c32a9e2f1a09ddcc2853c70573b2ff43.svg" alt="x_{length} = right * 2"/>;</p>
<p><img class="math" src="images/math/2690a3d5eca4385040efadb02d30ada4afcd707c.svg" alt="y_{length} = top * 2"/>;</p>
<p><img class="math" src="images/math/b06e5a30f5649fcfb0342c582564bc6095eaccd8.svg" alt="z_{length} = {nearZ}_c - {farZ}_c"/>;</p>
<div class="math">
<p><img src="images/math/fbad485b9b4a8031fc8eeebf877767aeb7c4e7c4.svg" alt="(\vec{f}_{4} ; nearZ_c, farZ_c) ( \begin{bmatrix}
                     {x_c} \\
                     {y_c} \\
                     {z_c} \\
                     {w_c=1}
           \end{bmatrix})  = \begin{bmatrix}
 {1 \over right} &amp;     0 &amp;           0 &amp;                  0 \\
 0 &amp;           {1 \over top} &amp;       0 &amp;                  0 \\
 0 &amp;           0 &amp;           {2 \over {nearZ_c - farZ_c}} &amp;   0 \\
 0 &amp;           0 &amp;           0 &amp;                  1
           \end{bmatrix}  *
            \begin{bmatrix}
                     {x_c} \\
                     {y_c} \\
                     {z_c} \\
                     {w_c=1} \\
           \end{bmatrix}"/></p>
</div><figure class="align-center">
<img alt="Frustum 6" src="images/frustum6.png" />
</figure>
</section>
<section id="premultiply-the-matricies">
<h4>Premultiply the matricies<a class="headerlink" href="#premultiply-the-matricies" title="Link to this heading">¶</a></h4>
<div class="math">
<p><img src="images/math/19bceacdfc2f2f2259ea57aa8a75376e9f9c0fad.svg" alt="\begin{bmatrix}
  {x_{ndc}} \\
  {y_{ndc}} \\
  {z_{ndc}} \\
  {w_{ndc}=1 } \\
\end{bmatrix}  = ( \vec{f}_{4} \circ  \vec{f}_{3} \circ \vec{f}_{2} \circ \vec{f}_{1}; farZ_c, nearZ_c, top, right ) \begin{bmatrix}
                         {x_c} \\
                         {y_c} \\
                         {z_c} \\
                         {w_c=1} \\
               \end{bmatrix}"/></p>
</div><p>Multiply them all together to get the following.  The elements of this premultiplied matrix have no geometric
meaning to the author, and that’s ok.  The matricies above all of geometric meaning, and we premultiply them
together for computational efficiency, as well as being able to do the next step in clip space, which
we couldn’t do without having the premultiplied matrix.</p>
<div class="math">
<p><img src="images/math/c2d1f70b9335b291b69ea2f81452719268943567.svg" alt="\begin{bmatrix}
  {x_{ndc}} \\
  {y_{ndc}} \\
  {z_{ndc}} \\
  {w_{ndc}=1} \\
\end{bmatrix}  =          \vec{f}_{c}^{ndc}(\begin{bmatrix}
                         {x_{c}} \\
                         {y_{c}} \\
                         {z_{c}} \\
                         {w_{c}=1} \\
               \end{bmatrix}; farZ_c, nearZ_c, top, right) = \begin{bmatrix}
                  {nearZ_c \over {right * \textcolor{red}{z_c}}} &amp;             0 &amp;                      0 &amp;                0 \\
                  0 &amp;                           {nearZ_c \over {top*\textcolor{red}{z_c}}} &amp;           0 &amp;                0 \\
                  0 &amp;                           0 &amp;                       {2 \over {nearZ_c - farZ_c}} &amp; {-({farZ_c + nearZ_c}) \over {nearZ_c - farZ_c}} \\
                  0 &amp;                           0 &amp;                       0 &amp;                1
               \end{bmatrix} *
                \begin{bmatrix}
                         {x_{c}} \\
                         {y_{c}} \\
                         {z_{c}} \\
                         {w_{c}=1} \\
               \end{bmatrix}"/></p>
</div><p>As a quick smoke test to ensure that the aggregate matrix works correctly, let’s
test the bounds of the frustum and make sure that they map to the NDC cube.</p>
<p>Given that <img class="math" src="images/math/0b69e5f1055ac2f39fa744ac4c8afde4ac150613.svg" alt="nearZ_c"/> is negative, assuming <img class="math" src="images/math/405a90b2f4adf3fc7ab7ea8068286eb0f410ba10.svg" alt="z_c"/> is equal to
<img class="math" src="images/math/0b69e5f1055ac2f39fa744ac4c8afde4ac150613.svg" alt="nearZ_c"/>, <img class="math" src="images/math/0f77a21eaff96bad0e778aa583143161872b0890.svg" alt="right"/> goes to <img class="math" src="images/math/a889c8ffadb613dd6792b56d197e4856a6f3fba9.svg" alt="1"/>, <img class="math" src="images/math/6508a7b60d8b7288de7439d46fa31b466f1f8929.svg" alt="left"/> which is <img class="math" src="images/math/5e01779897f21802c4df3895a024c9fa2fbf3fad.svg" alt="-right"/>
goes to <img class="math" src="images/math/790d6d407a5e517a5b305283231d0c29476bbe44.svg" alt="-1"/>.</p>
<p>Given that <img class="math" src="images/math/0b69e5f1055ac2f39fa744ac4c8afde4ac150613.svg" alt="nearZ_c"/> is negative, assuming <img class="math" src="images/math/405a90b2f4adf3fc7ab7ea8068286eb0f410ba10.svg" alt="z_c"/> is equal to
<img class="math" src="images/math/0b69e5f1055ac2f39fa744ac4c8afde4ac150613.svg" alt="nearZ_c"/>, <img class="math" src="images/math/bdc70e28dd28e6a281e57c0ccc2bfb53e0e52d31.svg" alt="top"/> goes to <img class="math" src="images/math/a889c8ffadb613dd6792b56d197e4856a6f3fba9.svg" alt="1"/>, <img class="math" src="images/math/d025e192bbf1774ad781b3d9f2d66715c8272a07.svg" alt="bottom"/> which is <img class="math" src="images/math/c4f76e1ddf37aae2c292369b02611b9fd3edec8d.svg" alt="-top"/>
goes to <img class="math" src="images/math/790d6d407a5e517a5b305283231d0c29476bbe44.svg" alt="-1"/>.</p>
<p>Given that <img class="math" src="images/math/caa487cffda5a61e15801b78457f45bc23da79b0.svg" alt="w_c"/> is <img class="math" src="images/math/a889c8ffadb613dd6792b56d197e4856a6f3fba9.svg" alt="1"/>, if <img class="math" src="images/math/7bda46a09b6b5414a509da0461f9724e91fb5865.svg" alt="z_c = nearZ_c"/>, <img class="math" src="images/math/8e69db1a6c584f2d06a386420caf09126294c44b.svg" alt="z_{ndc} = 1"/>.
Given that <img class="math" src="images/math/caa487cffda5a61e15801b78457f45bc23da79b0.svg" alt="w_c"/> is <img class="math" src="images/math/a889c8ffadb613dd6792b56d197e4856a6f3fba9.svg" alt="1"/>, if <img class="math" src="images/math/efead1510c43f3ea9ce04b0808cb0f2ea2d014fa.svg" alt="z_c = farZ_c"/>, <img class="math" src="images/math/fa84e2d630460f18b94dcecf0f0526f91dd87ec6.svg" alt="z_{ndc} = -1"/>.</p>
</section>
</section>
<section id="clip-space">
<h3>Clip Space<a class="headerlink" href="#clip-space" title="Link to this heading">¶</a></h3>
<p>convert the data from NDC to clip-space.</p>
<p>We have never used clip-space in the class, only NDC,
because 4D space is confusing geometrically, nevermind
the fact that (NDCx NDCy NDCz) = (Clipx/Clipw, Clipy/Clipy, Clipz/Clipz)</p>
<p>The purpose of going to clip space is that eventually we will be
able to remove the camera space’s z coordinate from the matrix.
This will allow us to use one perspective projection matrix for
all vertices, independent of the z coordinate of each input vertex.</p>
<p>I assume, without any evidence to support me, that this
was done for efficiency reasons when using OpenGL’s fixed function pipeline.
(Side note, the standard perspective projection matrix,
which we will get to by demo 25, does not linearly
position the <img class="math" src="images/math/0b69e5f1055ac2f39fa744ac4c8afde4ac150613.svg" alt="nearZ_c"/> to <img class="math" src="images/math/890194c56dbc9dcb1fb78bef0ab7906e19930aac.svg" alt="farZ_c"/> data into NDC. Everything
we’ve done so far in the class does.  The standard
perspective matrix ends up having less Z-fighting
close to <img class="math" src="images/math/0b69e5f1055ac2f39fa744ac4c8afde4ac150613.svg" alt="nearZ_c"/>, and more problems with Z-fighting
near farZ_c)</p>
<p>OpenGL will automatically convert from clip space to NDC
such as follows.</p>
<div class="math">
<p><img src="images/math/ccdedc0ffea095b251ed43485932b24dccd4fe66.svg" alt="\vec{f}_{clip}^{ndc}(\begin{bmatrix}
                         {x_{ndc}} \\
                         {y_{ndc}} \\
                         {z_{ndc}} \\
                         {w_{ndc}} \\
               \end{bmatrix}) =  \begin{bmatrix}
                  {1 \over {w_{clip}}} &amp;  0 &amp; 0 &amp; 0 \\
                  0 &amp;  {1 \over {w_{clip}}} &amp; 0 &amp; 0 \\
                  0 &amp;  0 &amp; {1 \over {w_{clip}}} &amp; 0 \\
                  0 &amp;  0 &amp; 0 &amp; {1 \over {w_{clip}}}
               \end{bmatrix} *
                 \begin{bmatrix}
                         {x_{clip}} \\
                         {y_{clip}} \\
                         {z_{clip}} \\
                         {w_{clip}}
               \end{bmatrix}"/></p>
</div><p>So to put our NDC data into clip space, knowing what OpenGL is going to do in
the equation above, we need to decide what we want our clip space value, <img class="math" src="images/math/90fe2c64c92292e1ec2c013aa7a9d25bdc5939d7.svg" alt="w"/> to be,
and do the inverse of the equation above</p>
<div class="math">
<p><img src="images/math/dab49d704ab991d6ffb2932d1f6b7c89fc41eef2.svg" alt="\vec{f}_{ndc}^{clip}(\begin{bmatrix}
                         {x_{ndc}} \\
                         {y_{ndc}} \\
                         {z_{ndc}} \\
                         {w_{ndc}} \\
               \end{bmatrix}; w) =  \begin{bmatrix}
                  w &amp;  0 &amp; 0 &amp; 0 \\
                  0 &amp;  w &amp; 0 &amp; 0 \\
                  0 &amp;  0 &amp; w &amp; 0 \\
                  0 &amp;  0 &amp; 0 &amp; w
               \end{bmatrix} *
                 \begin{bmatrix}
                         {x_{ndc}} \\
                         {y_{ndc}} \\
                         {z_{ndc}} \\
                         {w_{ndc}}
               \end{bmatrix}"/></p>
</div><div class="math">
<p><img src="images/math/aaf34e467e1e448622deb6fa63f5751faf6cbe75.svg" alt="\vec{f}_{clip}^{clip}(\begin{bmatrix}
                         {x_{clip}} \\
                         {y_{clip}} \\
                         {z_{clip}} \\
                         {w_{clip}} \\
               \end{bmatrix})
                = ( \vec{f}_{clip}^{ndc} \circ \vec{f}_{ndc}^{clip}) \begin{bmatrix}
                         {x_{clip}} \\
                         {y_{clip}} \\
                         {z_{clip}} \\
                         {w} \\
               \end{bmatrix}"/></p>
</div><p>Since we want to get the <img class="math" src="images/math/405a90b2f4adf3fc7ab7ea8068286eb0f410ba10.svg" alt="z_c"/> relative to camera space out of
the premultiplie matrix above, we choose
the following</p>
<div class="math">
<p><img src="images/math/aed1a364b9532a807a4286223adc6cad1c26e510.svg" alt="\vec{f}_{ndc}^{clip}(\begin{bmatrix}
                         {x_{ndc}} \\
                         {y_{ndc}} \\
                         {z_{ndc}} \\
                         {w_{ndc}=1} \\
               \end{bmatrix}; z_c) =  \begin{bmatrix}
                  z_c &amp;  0 &amp; 0 &amp; 0 \\
                  0 &amp;  z_c &amp; 0 &amp; 0 \\
                  0 &amp;  0 &amp; z_c &amp; 0 \\
                  0 &amp;  0 &amp; 0 &amp; z_c
               \end{bmatrix} *
                 \begin{bmatrix}
                         {x_{ndc}} \\
                         {y_{ndc}} \\
                         {z_{ndc}} \\
                         {w_{ndc}}
               \end{bmatrix}"/></p>
</div><p>because multiplying by this matrix will remove the <img class="math" src="images/math/405a90b2f4adf3fc7ab7ea8068286eb0f410ba10.svg" alt="z_c"/> out of
the upper left quadrant.</p>
<section id="remove-z-of-camera-space-from-part-of-the-matrix">
<h4>Remove Z of Camera Space from Part of the Matrix<a class="headerlink" href="#remove-z-of-camera-space-from-part-of-the-matrix" title="Link to this heading">¶</a></h4>
<p>To get camera z out of the matrix, where it’s currently in two denominators, we
can use knowledge of clip space, wherein we put cameraspace’s z into W.     because cameraSpace’s z coordinate is negative, we want to scale
all dimensions without reflecting over the origin, hence the negative sign in  <img class="math" src="images/math/b11afc1c8312b204217fce9912fd9a96924c3a9b.svg" alt="-z_c"/>.</p>
<div class="math">
<p><img src="images/math/1c2ad0f6a9fb79e14e9b2356b783d5528c18c5de.svg" alt="\begin{bmatrix}
            {x_{clip}} \\
            {y_{clip}} \\
            {z_{clip}} \\
            {w_{clip}} \\
  \end{bmatrix}
  &amp; =  \vec{f}_{c}^{clip}(\begin{bmatrix}
            {x_c} \\
            {y_c} \\
            {z_c} \\
            {w_c=1} \\
  \end{bmatrix}; farZ_c, nearZ_c, top, right) \\
  &amp; =  (\vec{f}_{ndc}^{clip} \circ \vec{f}_{c}^{ndc})  *
   \begin{bmatrix}
            {x_c} \\
            {y_c} \\
            {z_c} \\
            {w_c=1} \\
  \end{bmatrix} \\
  &amp; = \begin{bmatrix}
                   \textcolor{red}{z_c} &amp;  0 &amp; 0 &amp; 0 \\
                   0 &amp;  \textcolor{red}{z_c} &amp; 0 &amp; 0 \\
                   0 &amp;  0 &amp; \textcolor{red}{z_c} &amp; 0 \\
                   0 &amp;  0 &amp; 0 &amp; \textcolor{red}{z_c}
                \end{bmatrix} * \begin{bmatrix}
                   {nearZ_c \over {right * \textcolor{red}{z_c}}} &amp;             0 &amp;                      0 &amp;                0 \\
                   0 &amp;                           {nearZ_c \over {top*\textcolor{red}{z_c}}} &amp;           0 &amp;                0 \\
                   0 &amp;                           0 &amp;                       {2 \over {nearZ_c - farZ_c}} &amp; {-({farZ_c + nearZ_c}) \over {nearZ_c - farZ_c}} \\
                   0 &amp;                           0 &amp;                       0 &amp;                1
                \end{bmatrix} *
   \begin{bmatrix}
            {x_c} \\
            {y_c} \\
            {z_c} \\
            {w_c=1} \\
  \end{bmatrix} \\
  &amp; = \begin{bmatrix}
            {nearZ_c \over right} &amp;         0 &amp;        0 &amp;                                   0 \\
            0 &amp;                  {nearZ_c \over top} &amp; 0 &amp;                                   0 \\
            0 &amp;                  0 &amp;        { \textcolor{red}{z_c}* {2 \over {nearZ_c - farZ_c}}} &amp;   { \textcolor{red}{z_c}*{-({farZ_c + nearZ_c}) \over {nearZ_c - farZ_c}}} \\
            0 &amp;                  0 &amp;        0 &amp;                                   \textcolor{red}{z_c}
  \end{bmatrix} *
   \begin{bmatrix}
            {x_c} \\
            {y_c} \\
            {z_c} \\
            {w_c=1} \\
  \end{bmatrix}"/></p>
</div><p>The result of this is in clip space, where for the first time, our w component is not 1, but <img class="math" src="images/math/405a90b2f4adf3fc7ab7ea8068286eb0f410ba10.svg" alt="z_c"/>.</p>
<p>Turning clip space back into NDC</p>
<div class="math">
<p><img src="images/math/c505b83e56ef24d97091a8e93b3b65c3e90e86f8.svg" alt="\begin{bmatrix}
                          {x_{ndc}} \\
                          {y_{ndc}} \\
                          {z_{ndc}} \\
                          {w_{ndc}} \\
                \end{bmatrix}
                &amp; =     \begin{bmatrix}
                          {x_{clip} / z_{clip}} \\
                          {y_{clip} / z_{clip}} \\
                          {z_{clip} / z_{clip}} \\
                          {w_{clip} / z_{clip}} \\
                \end{bmatrix} \\
                &amp; = \begin{bmatrix}
                   \textcolor{red}{{1 \over {z_c}}} &amp;  0 &amp; 0 &amp; 0 \\
                   0 &amp;  \textcolor{red}{{1 \over {z_c}}} &amp; 0 &amp; 0 \\
                   0 &amp;  0 &amp; \textcolor{red}{{1 \over {z_c}}} &amp; 0 \\
                   0 &amp;  0 &amp; 0 &amp; \textcolor{red}{{1 \over {z_c}}}
                \end{bmatrix} * \begin{bmatrix}
                             {{nearZ_c \over right} * x_{c}}   \\
                             {{nearZ_c \over top} * y_{c}}    \\
                             {\textcolor{red}{z_c}^2 * {2 \over {nearZ_c - farZ_c}} + {\textcolor{red}{z_c}*{-({farZ_c + nearZ_c}) \over {nearZ_c - farZ_c}}}}\\
                             {\textcolor{red}{z_c}} \\
                \end{bmatrix}"/></p>
</div><p>To test a corner of the frustum as a smoke test, say</p>
<div class="math">
<p><img src="images/math/2eee068d6b7c2f0ecfc5c422ec0deacceb4fc5e8.svg" alt="\begin{bmatrix}
  {x_{ndc}} \\
  {y_{ndc}} \\
  {z_{ndc}} \\
  {w_{ndc}=1} \\
\end{bmatrix} &amp; =               \vec{f}_{c}^{ndc}(\begin{bmatrix}
                         {x_{c} = right} \\
                         {y_{c} = top} \\
                         {z_{c} = nearZ_c} \\
                         {w_{c}=1} \\
               \end{bmatrix}; farZ_c, nearZ_c, top, right) \\
               &amp; = \begin{bmatrix}
                  \textcolor{red}{{1 \over {z_c}}} &amp;  0 &amp; 0 &amp; 0 \\
                  0 &amp;  \textcolor{red}{{1 \over {z_c}}} &amp; 0 &amp; 0 \\
                  0 &amp;  0 &amp; \textcolor{red}{{1 \over {z_c}}} &amp; 0 \\
                  0 &amp;  0 &amp; 0 &amp; \textcolor{red}{{1 \over {z_c}}}
               \end{bmatrix} * \begin{bmatrix}
                            {{nearZ_c \over right} * x_{c}}   \\
                            {{nearZ_c \over top} * y_{c}}    \\
                            {\textcolor{red}{z_c}^2 * {2 \over {nearZ_c - farZ_c}} + {\textcolor{red}{z_c}*{-({farZ_c + nearZ_c}) \over {nearZ_c - farZ_c}}}}\\
                            {\textcolor{red}{z_c}} \\
               \end{bmatrix} \\
               &amp; = \begin{bmatrix}
                            {{nearZ_c \over right} * x_{c}}   \\
                            {{nearZ_c \over top} * y_{c}}    \\
                            {\textcolor{red}{z_c} * {2 \over {nearZ_c - farZ_c}} + {-({farZ_c + nearZ_c}) \over {nearZ_c - farZ_c}}}\\
                            {1} \\
               \end{bmatrix} \\
               &amp; = \begin{bmatrix}
                            {1}  \\
                            {1}  \\
                            {1} \\
                            {1} \\
               \end{bmatrix}"/></p>
</div><p>And that’s what we’d expect and the top right corner of the near plane of the frustum
should go to the upper right corner with a z value of 1, as -1 is where the back plane must go.</p>
<p>If we had used <img class="math" src="images/math/89b4d39e6f5751c582a319e0b1494801aa72ed77.svg" alt="x_c = farZ_c"/>, then <img class="math" src="images/math/fa84e2d630460f18b94dcecf0f0526f91dd87ec6.svg" alt="z_{ndc} = -1"/>, which is what we want, as negative <img class="math" src="images/math/7165e3dbdd379281cd441e830934b272d34fd7eb.svg" alt="z"/> axis
goes into the monitor.</p>
</section>
<section id="remove-z-of-camera-space-from-the-rest-of-the-matrix">
<h4>Remove Z of Camera Space from the Rest of the Matrix<a class="headerlink" href="#remove-z-of-camera-space-from-the-rest-of-the-matrix" title="Link to this heading">¶</a></h4>
<p>We successfully moved <img class="math" src="images/math/405a90b2f4adf3fc7ab7ea8068286eb0f410ba10.svg" alt="z_c"/> out of the upper left quadrant, but in doing so, we moved it down
to the lower right. Can we get rid of it there too?  Turn out, we can.</p>
<p>Since the vector multiplied by this matrix will provide <img class="math" src="images/math/405a90b2f4adf3fc7ab7ea8068286eb0f410ba10.svg" alt="z_c"/> as it’s third element,
we can put <img class="math" src="images/math/b11afc1c8312b204217fce9912fd9a96924c3a9b.svg" alt="-z_c"/> into the <img class="math" src="images/math/90fe2c64c92292e1ec2c013aa7a9d25bdc5939d7.svg" alt="w"/> by taking the explicit vesion of it out of the fourth column,
and put <img class="math" src="images/math/790d6d407a5e517a5b305283231d0c29476bbe44.svg" alt="-1"/> into the third column’s <img class="math" src="images/math/90fe2c64c92292e1ec2c013aa7a9d25bdc5939d7.svg" alt="w"/>.</p>
<div class="math">
<p><img src="images/math/ca2f255e29326d389ad270323b2a50444d18a798.svg" alt="\begin{bmatrix}
                          x_{clip} \\
                          y_{clip} \\
                          z_{clip} \\
                          w_{clip} \\
                \end{bmatrix}
                &amp; =  \vec{f}_{c}^{clip}(\begin{bmatrix}
                          x_c \\
                          y_c \\
                          z_c \\
                          w_c=1 \\
                \end{bmatrix}; farZ_c, nearZ_c, top, right) \\
                &amp; =  (\vec{f}_{ndc}^{clip} \circ \vec{f}_{c}^{ndc})  *
                 \begin{bmatrix}
                          x_c \\
                          y_c \\
                          z_c \\
                          w_c=1 \\
                \end{bmatrix} \\
                &amp; = {1 \over {z_c}} * \begin{bmatrix}
                          nearZ_c \over right &amp;         0 &amp;        0 &amp;                                   0 \\
                          0 &amp;                  nearZ_c \over top &amp; 0 &amp;                                   0 \\
                          0 &amp;                  0 &amp;        z_c * {2 \over {nearZ_c - farZ_c}} &amp;   z_c * {-{farZ_c + nearZ_c} \over {nearZ_c - farZ_c}} \\
                          0 &amp;                  0 &amp;        \textcolor{red}{0} &amp;                                   \textcolor{red}{z_c}
                \end{bmatrix} *
                 \begin{bmatrix}
                          x_c \\
                          y_c \\
                          z_c \\
                          \textcolor{red}{w_c=1} \\
                \end{bmatrix} \\
                &amp; = {1 \over {z_c}} *  \begin{bmatrix}
                          nearZ_c \over right &amp;         0 &amp;        0 &amp;                                   0 \\
                          0 &amp;                  nearZ_c \over top &amp; 0 &amp;                                   0 \\
                          0 &amp;                  0 &amp;        z_c * {2 \over {nearZ_c - farZ_c}} &amp;  z_c*{-{farZ_c + nearZ_c} \over {nearZ_c - farZ_c}} \\
                          0 &amp;                  0 &amp;        \textcolor{red}{1} &amp;                                   \textcolor{red}{0}
                \end{bmatrix} *
                 \begin{bmatrix}
                          x_c \\
                          y_c \\
                          z_c \\
                          w_c=1 \\
                \end{bmatrix} \\
                &amp; = {1 \over {z_c}} * \begin{bmatrix}
                             {{nearZ_c \over right} * x_{c}}  \\
                             {{nearZ_c \over top} * y_{c}}    \\
                             {\textcolor{red}{z_c}^2 * {2 \over {nearZ_c - farZ_c}} + z_c * {{-({farZ_c + nearZ_c}) \over {nearZ_c - farZ_c}}}}\\
                             \textcolor{red}{z_c} \\
                \end{bmatrix}"/></p>
</div><p>To remove <img class="math" src="images/math/405a90b2f4adf3fc7ab7ea8068286eb0f410ba10.svg" alt="z_c"/> from the matrix, all that to do is remove it from row 3, somehow.  We’re about to ride dirty.</p>
<p>If we were to change row three, it would not be the same transformation.  But if we ensure the following two
properties of our changes, everything will be alright</p>
<p>We need the</p>
<ul class="simple">
<li><p><img class="math" src="images/math/b8af93d7a32bf91da729ef17a88813fd95d7e7f6.svg" alt="\begin{bmatrix} 0 \\ 0 \\ \textcolor{red}{1} \\ 0 \\ \end{bmatrix} \cdot \vec{f}_{c}^{clip} (\begin{bmatrix} {x_c} \\ {y_c} \\ \textcolor{red}{nearZ_c} \\ {w_c=1} \\ \end{bmatrix}) = \textcolor{red}{-1.0}"/></p></li>
<li><p><img class="math" src="images/math/38dc154248c1153466386e9bfd8bc951a225ddff.svg" alt="\begin{bmatrix} 0 \\ 0 \\ \textcolor{red}{1} \\ 0 \\ \end{bmatrix} \cdot \vec{f}_{c}^{clip} (\begin{bmatrix} {x_c} \\ {y_c} \\ \textcolor{red}{farZ_c} \\ {w_c=1} \\ \end{bmatrix}) = \textcolor{red}{1.0}"/></p></li>
<li><p>Ordering is preserved after the function is applied, i.e. monotonicity.  if <img class="math" src="images/math/eca9163aa2292155e01ca9c065c1b95ab86e4b55.svg" alt="z_1 &lt; z_2"/>,
then <img class="math" src="images/math/e0c93f26330700c89ca373bac1e13978b9df17ac.svg" alt="(\begin{bmatrix} 0 \\ 0 \\ \textcolor{red}{1} \\ 0 \\ \end{bmatrix} \cdot \vec{f}_{c}^{clip}(\begin{bmatrix} 0 \\ 0 \\ \textcolor{red}{z_1} \\ 0 \\ \end{bmatrix} )) &lt; (\begin{bmatrix} 0 \\ 0 \\ \textcolor{red}{1} \\ 0 \\ \end{bmatrix} \cdot  \vec{f}_{c}^{clip}(\begin{bmatrix} 0 \\ 0 \\ \textcolor{red}{z_2} \\ 0 \\ \end{bmatrix} ) )"/>.</p></li>
</ul>
<p>If we can make a function, that like the third row of the matrix, has those properties, we can replace the
third row and remove camera space’s z, <img class="math" src="images/math/405a90b2f4adf3fc7ab7ea8068286eb0f410ba10.svg" alt="z_c"/>, from the matrix.  This is desirable because, if it were to exist,
would would not need per vertex to create a custom pespective matrix.</p>
<p>Towards that, let’s look at these jibronies.</p>
<div class="math">
<p><img src="images/math/a2b118a94c3bea02ab018fecba1ed17d9e59f30f.svg" alt="\vec{f}_{c}^{clip}(\begin{bmatrix}
                          {x_c} \\
                          {y_c} \\
                          {z_c} \\
                          {w_c=1} \\
                \end{bmatrix}; farZ_c, nearZ_c, top, right) &amp; =  (\vec{f}_{ndc}^{clip} \circ \vec{f}_{4})  *
                 \begin{bmatrix}
                          {x_c} \\
                          {y_c} \\
                          {z_c} \\
                          {w_c=1} \\
                \end{bmatrix} \\
                &amp; = \begin{bmatrix}
                          {-nearZ_c \over right} &amp;         0 &amp;        0 &amp;                                   0 \\
                          0 &amp;                  {-nearZ_c \over top} &amp; 0 &amp;                                   0 \\
                          0 &amp;                  0 &amp;        {2*(-z_c) \over {nearZ_c - farZ_c}} &amp;   {-z_c*{-{farZ_c + nearZ_c} \over {nearZ_c - farZ_c}}} \\
                          0 &amp;                  0 &amp;        0 &amp;                                   -z_c
                \end{bmatrix} *
                 \begin{bmatrix}
                          {x_c} \\
                          {y_c} \\
                          {z_c} \\
                          {w_c=1} \\
                \end{bmatrix} \\
                &amp; = \begin{bmatrix}
                          {-nearZ_c \over right} &amp;         0 &amp;        0 &amp;                                   0 \\
                          0 &amp;                  {-nearZ_c \over top} &amp; 0 &amp;                                   0 \\
                          0 &amp;                  0 &amp;        \textcolor{red}{{2*(-z_c) \over {nearZ_c - farZ_c}}} &amp;   \textcolor{red}{{-z_c*{-{farZ_c + nearZ_c} \over {nearZ_c - farZ_c}}}} \\
                          0 &amp;                  0 &amp;        -1 &amp;                                   0
                \end{bmatrix} *
                 \begin{bmatrix}
                          {x_c} \\
                          {y_c} \\
                          {z_c} \\
                          {w_c=1} \\
                \end{bmatrix}

  ..
     //  clipSpace.z = A* c.z + B * 1.0  (the first column and the second column are zero because z is independent of x and y)
     //  for nearZ, which must map to -1.0,
     //    ndc.z = clipSpace.z / clipSpace.w =   (A * nearZ + B) / nearZ = -1.0
     //  for farZ, which must map to 1.0,
     //    ndc.z = clipSpace.z / clipSpace.w =   (A * farZ + B) / farZ = 1.0
     //
     //   (A * nearZ + B) = -nearZ                                           (1)
     //   (A * farZ + B)  = farZ                                             (2)
     //
     //   B = -nearZ - A * nearZ                                             (3) (from 1)
     //   (A * farZ + -nearZ - A * nearZ)  = farZ                            (4) (from 2 and 3)
     //   (farZ - nearZ)*A  + -nearZ )  = farZ                               (5)
     //   A = (farZ + nearZ)/(farZ-nearZ)                                    (6)
     //
     //   we found A, now substitute that in to get B
     //
     //  (farZ + nearZ)/(farZ-nearZ) * nearZ + B = -nearZ                    (from 1 and 6)
     //  B = -nearZ - (farZ + nearZ)/(farZ-nearZ) * nearZ
     //  B = (-1 - (farZ + nearZ)/(farZ-nearZ)) * nearZ
     //  B = -(1 + (farZ + nearZ)/(farZ-nearZ)) * nearZ
     //  B = -( (farZ-nearZ + (farZ + nearZ))/(farZ-nearZ)) * nearZ
     //  B = -( (2*farZ)/(farZ-nearZ)) * nearZ
     //  B = (-2*farZ*nearZ)/(farZ-nearZ)
     //
     // now that we have A and B, write down the function, and ensure that it is
     // monotonic from (nearZ, farZ), inclusive

     // z_ndc = ((farZ + nearZ)/(farZ-nearZ) * cameraSpace.z +  (-2*farZ*nearZ)/(farZ-nearZ)) / cameraSpace.z
     // TODO -- proof of monotonicity

     // NOW OUR PERSPECTIVE MATRIX IS INDEPENDENT OF cameraSpace.z!!!
     mat4 camera_space_to_clip_space = transpose(mat4(
          -nearZ/right,         0.0,        0.0,                           0.0,
          0.0,                  -nearZ/top, 0.0,                           0.0,
          0.0,                  0.0,        (farZ + nearZ)/(farZ-nearZ),  (-2*farZ*nearZ)/(farZ-nearZ),
          0.0,                  0.0,        -1.0,                          0.0));

     return camera_space_to_clip_space * cameraSpace;




24



    // mat4 camera_space_to_clip_space = transpose(mat4(
    //      --nearZ/right,         0.0,        0.0,                           0.0,
    //      0.0,                  --nearZ/top, 0.0,                           0.0,
    //      0.0,                  0.0,        (-farZ + -nearZ)/(-farZ--nearZ),  (-2*-farZ*-nearZ)/(-farZ--nearZ),
    //      0.0,                  0.0,        -1.0,                          0.0));
     mat4 camera_space_to_clip_space1 = transpose(mat4(
          nearZ/right,         0.0,       0.0,                           0.0,
          0.0,                 nearZ/top, 0.0,                           0.0,
          0.0,                 0.0,       -(farZ + nearZ)/(-farZ+nearZ), (-2*farZ*nearZ)/(-farZ+nearZ),
          0.0,                 0.0,       -1.0,                          0.0));

    // End (1)
    // For (2)
     mat4 reflect_z = transpose(mat4(
          1.0,  0.0, 0.0,  0.0,
          0.0,  1.0, 0.0,  0.0,
          0.0,  0.0, -1.0, 0.0,
          0.0,  0.0, 0.0,  1.0));

     // camera_space_to_clip_space2 = reflect_z * camera_space_to_clip_space1
     mat4 camera_space_to_clip_space2 = transpose(mat4(
          nearZ/right,         0.0,       0.0,                           0.0,
          0.0,                 nearZ/top, 0.0,                           0.0,
          0.0,                 0.0,       -(farZ + nearZ)/(farZ-nearZ), (-2*farZ*nearZ)/(farZ-nearZ),
          0.0,                 0.0,       -1.0,                          0.0));
    // End (2)

     return camera_space_to_clip_space2 * cameraSpace;"/></p>
</div></section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ch19.html" class="btn btn-neutral float-left" title="Matrix Stacks - Demo 19" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, William Emerison Six.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>