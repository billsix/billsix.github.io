<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html"><link rel="search" title="Search" href="search.html"><link rel="next" title="Developing Robust Programs" href="robust.html"><link rel="prev" title="All About Functions" href="functions.html">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.09.25 -->
        <title>Dealing with Files - Programming From The Ground Up 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="static/pygments.css?v=acfd86a5" />
    <link rel="stylesheet" type="text/css" href="static/styles/furo.css?v=50c23ec3" />
    <link rel="stylesheet" type="text/css" href="static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Programming From The Ground Up 0.0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <span class="sidebar-brand-text">Programming From The Ground Up 0.0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory.html">Computer Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="firstprog.html">Your First Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="functions.html">All About Functions</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Dealing with Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="robust.html">Developing Robust Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="memoryint.html">Intermediate Memory Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="linking.html">Sharing Functions with Code Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="counting.html">Counting Like a Computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="otherlang.html">High-Level Languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimization.html">Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="wherenext.html">Moving On from Here</a></li>
<li class="toctree-l1"><a class="reference internal" href="records.html">Reading and Writing Simple Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="gdpapp.html">Using the GDB Debugger</a></li>
<li class="toctree-l1"><a class="reference internal" href="asciiap.html">Table of ASCII Codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="cch.html">The C Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="ctranslationap.html">C Idioms in Assembly Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="guiap.html">GUI Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="instructionsap.html">Common x86 Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="fdlap.html">GNU Free Documentation License</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="sources/files.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="dealing-with-files">
<span id="filesch"></span><h1>Dealing with Files<a class="headerlink" href="#dealing-with-files" title="Link to this heading">¶</a></h1>
<p>A lot of computer programming deals with files. After all, when we
reboot our computers, the only thing that remains from previous sessions
are the things that have been put on disk. Data which is stored in files
is called <em>persistent</em> data, because it persists in files that remain on
the disk even when the program isn’t running..</p>
<section id="the-unix-file-concept">
<h2>The UNIX File Concept<a class="headerlink" href="#the-unix-file-concept" title="Link to this heading">¶</a></h2>
<p>Each operating system has its own way of dealing with files. However,
the UNIX method, which is used on Linux, is the simplest and most
universal. UNIX files, no matter what program created them, can all be
accessed as a sequential stream of bytes. When you access a file, you
start by opening it by name. The operating system then gives you a
number, called a <em>file descriptor</em>, which you use to refer to the file
until you are through with it. You can then read and write to the file
using its file descriptor. When you are done reading and writing, you
then close the file, which then makes the file descriptor useless.</p>
<p>In our programs we will deal with files in the following ways:</p>
<ol class="arabic simple">
<li><p>Tell Linux the name of the file to open, and in what mode you want it
opened (read, write, both read and write, create it if it doesn’t
exist, etc.). This is handled with the <code class="docutils literal notranslate"><span class="pre">open</span></code> system call,
which takes a filename, a number representing the mode, and a
permission set as its parameters. %eax; will hold the
system call number, which is 5. The address of the first character of
the filename should be stored in %ebx;. The read/write
intentions, represented as a number, should be stored in
%ecx;. For now, use 0 for files you want to read from,
and 03101 for files you want to write to (you must include the
leading zero). <a class="footnote-reference brackets" href="#id8" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> Finally, the permission set should be stored as a
number in %edx;. If you are unfamiliar with UNIX
permissions, just use 0666 for the permissions (again, you must
include the leading zero).</p></li>
<li><p>Linux will then return to you a file descriptor in
%eax;. Remember, this is a number that you use to
refer to this file throughout your program.</p></li>
<li><p>Next you will operate on the file doing reads and/or writes, each
time giving Linux the file descriptor you want to use. <code class="docutils literal notranslate"><span class="pre">read</span></code>
is system call 3, and to call it you need to have the file descriptor
in %ebx;, the address of a buffer for storing the data that is
read in %ecx;, and the size of the buffer in %edx;.
Buffers will be explained in <a class="reference external" href="#buffersbss">Buffers and</a> . <code class="docutils literal notranslate"><span class="pre">read</span></code>
will return with either the number of characters read from the file,
or an error code. Error codes can be distinguished because they are
always negative numbers (more information on negative numbers can be
found in <a class="reference internal" href="counting.html#countingchapter"><span class="std std-ref">Counting Like a Computer</span></a>). <code class="docutils literal notranslate"><span class="pre">write</span></code> is system call
4, and it requires the same parameters as the <code class="docutils literal notranslate"><span class="pre">read</span></code> system call,
except that the buffer should already be filled with the data to
write out. The <code class="docutils literal notranslate"><span class="pre">write</span></code> system call will give back the number of
bytes written in %eax; or an error code.</p></li>
<li><p>When you are through with your files, you can then tell Linux to
close them. Afterwards, your file descriptor is no longer valid. This
is done using <code class="docutils literal notranslate"><span class="pre">close</span></code>, system call 6. The only parameter to
<code class="docutils literal notranslate"><span class="pre">close</span></code> is the file descriptor, which is placed in %ebx;</p></li>
</ol>
</section>
<section id="buffers-and-bss">
<span id="buffersbss"></span><h2>Buffers and <code class="docutils literal notranslate"><span class="pre">.bss</span></code><a class="headerlink" href="#buffers-and-bss" title="Link to this heading">¶</a></h2>
<p>In the previous section we mentioned buffers without explaining what
they were. A buffer is a continuous block of bytes used for bulk data
transfer. When you request to read a file, the operating system needs to
have a place to store the data it reads. That place is called a buffer.
Usually buffers are only used to store data temporarily, and it is then
read from the buffers and converted to a form that is easier for the
programs to handle. Our programs won’t be complicated enough to need
that done. For an example, let’s say that you want to read in a single
line of text from a file but you do not know how long that line is. You
would then simply read a large number of bytes/characters from the file
into a buffer, look for the end-of-line character, and copy all of the
characters to that end-of-line character to another location. If you
didn’t find an end-of-line character, you would allocate another buffer
and continue reading. You would probably wind up with some characters
left over in your buffer in this case, which you would use as the
starting point when you next need data from the file. <a class="footnote-reference brackets" href="#id9" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></p>
<p>Another thing to note is that buffers are a fixed size, set by the
programmer. So, if you want to read in data 500 bytes at a time, you
send the <code class="docutils literal notranslate"><span class="pre">read</span></code> system call the address of a 500-byte unused location,
and send it the number 500 so it knows how big it is. You can make it
smaller or bigger, depending on your application’s needs.</p>
<p>To create a buffer, you need to either reserve static or dynamic
storage. Static storage is what we have talked about so far, storage
locations declared using <code class="docutils literal notranslate"><span class="pre">.long</span></code> or <code class="docutils literal notranslate"><span class="pre">.byte</span></code> directives. Dynamic
storage will be discussed in <a class="reference internal" href="memoryint.html#dynamicmemory"><span class="std std-ref">Getting More Memory</span></a>. There are
problems, though, with declaring buffers using <code class="docutils literal notranslate"><span class="pre">.byte</span></code>. First, it
is tedious to type. You would have to type 500 numbers after the
<code class="docutils literal notranslate"><span class="pre">.byte</span></code> declaration, and they wouldn’t be used for anything but to
take up space. Second, it uses up space in the executable. In the
examples we’ve used so far, it doesn’t use up too much, but that can
change in larger programs. If you want 500 bytes you have to type in 500
numbers and it wastes 500 bytes in the executable. There is a solution
to both of these. So far, we have discussed two program sections, the
<code class="docutils literal notranslate"><span class="pre">.text</span></code> and the <code class="docutils literal notranslate"><span class="pre">.data</span></code> sections. There is another section
called the <code class="docutils literal notranslate"><span class="pre">.bss</span></code>. This section is like the data section, except
that it doesn’t take up space in the executable. This section can
reserve storage, but it can’t initialize it. In the <code class="docutils literal notranslate"><span class="pre">.data</span></code> section,
you could reserve storage and set it to an initial value. In the
<code class="docutils literal notranslate"><span class="pre">.bss</span></code> section, you can’t set an initial value. This is useful for
buffers because we don’t need to initialize them anyway, we just need to
reserve storage. In order to do this, we do the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">section</span> <span class="o">.</span><span class="n">bss</span>
    <span class="o">.</span><span class="n">lcomm</span> <span class="n">my_buffer</span><span class="p">,</span> <span class="mi">500</span>
</pre></div>
</div>
<p>This directive, <code class="docutils literal notranslate"><span class="pre">.lcomm</span></code>, will create a symbol, <code class="docutils literal notranslate"><span class="pre">my_buffer</span></code>,
that refers to a 500-byte storage location that we can use as a buffer.
We can then do the following, assuming we have opened a file for reading
and have placed the file descriptor in %ebx;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>movl $my_buffer, %ecx
movl 500, %edx
movl 3, %eax
int  $0x80
</pre></div>
</div>
<p>This will read up to 500 bytes into our buffer. In this example, I
placed a dollar sign in front of <code class="docutils literal notranslate"><span class="pre">my_buffer</span></code>. Remember that the reason
for this is that without the dollar sign, <code class="docutils literal notranslate"><span class="pre">my_buffer</span></code> is treated as a
memory location, and is accessed in direct addressing mode. The dollar
sign switches it to immediate mode addressing, which actually loads the
number represented by <code class="docutils literal notranslate"><span class="pre">my_buffer</span></code> itself (i.e. - the address of the
start of our buffer, which is the address of <code class="docutils literal notranslate"><span class="pre">my_buffer</span></code>) into
%ecx;.</p>
</section>
<section id="standard-and-special-files">
<h2>Standard and Special Files<a class="headerlink" href="#standard-and-special-files" title="Link to this heading">¶</a></h2>
<p>You might think that programs start without any files open by default.
This is not true. Linux programs usually have at least three open file
descriptors when they begin. They are:</p>
<dl class="simple">
<dt>STDIN</dt><dd><p>This is the <em>standard input</em>. It is a read-only file, and usually
represents your keyboard. <a class="footnote-reference brackets" href="#id10" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> This is always file descriptor 0.</p>
</dd>
<dt>STDOUT</dt><dd><p>This is the <em>standard output</em>. It is a write-only file, and usually
represents your screen display. This is always file descriptor 1.</p>
</dd>
<dt>STDERR</dt><dd><p>This is your <em>standard error</em>. It is a write-only file, and usually
represents your screen display. Most regular processing output goes
to <code class="docutils literal notranslate"><span class="pre">STDOUT</span></code>, but any error messages that come up in the process go
to <code class="docutils literal notranslate"><span class="pre">STDERR</span></code>. This way, if you want to, you can split them up into
separate places. This is always file descriptor 2.</p>
</dd>
</dl>
<p>Any of these “files” can be redirected from or to a real file, rather
than a screen or a keyboard. This is outside the scope of this book, but
any good book on the UNIX command-line will describe it in detail. The
program itself does not even need to be aware of this indirection - it
can just use the standard file descriptors as usual.</p>
<p>Notice that many of the files you write to aren’t files at all.
UNIX-based operating systems treat all input/output systems as files.
Network connections are treated as files, your serial port is treated
like a file, even your audio devices are treated as files. Communication
between processes is usually done through special files called pipes.
Some of these files have different methods of opening and creating them
than regular files (i.e. - they don’t use the <code class="docutils literal notranslate"><span class="pre">open</span></code> system call), but
they can all be read from and written to using the standard <code class="docutils literal notranslate"><span class="pre">read</span></code> and
<code class="docutils literal notranslate"><span class="pre">write</span></code> system calls.</p>
</section>
<section id="using-files-in-a-program">
<h2>Using Files in a Program<a class="headerlink" href="#using-files-in-a-program" title="Link to this heading">¶</a></h2>
<p>We are going to write a simple program to illustrate these concepts. The
program will take two files, and read from one, convert all of its
lower-case letters to upper-case, and write to the other file. Before we
do so, let’s think about what we need to do to get the job done:</p>
<ul class="simple">
<li><p>Have a function that takes a block of memory and converts it to
upper-case. This function would need an address of a block of memory
and its size as parameters.</p></li>
<li><p>Have a section of code that repeatedly reads in to a buffer, calls
our conversion function on the buffer, and then writes the buffer
back out to the other file.</p></li>
<li><p>Begin the program by opening the necessary files.</p></li>
</ul>
<p>Notice that I’ve specified things in reverse order that they will be
done. That’s a useful trick in writing complex programs - first decide
the meat of what is being done. In this case, it’s converting blocks of
characters to upper-case. Then, you think about what all needs to be
setup and processed to get that to happen. In this case, you have to
open files, and continually read and write blocks to disk. One of the
keys of programming is continually breaking down problems into smaller
and smaller chunks until it’s small enough that you can easily solve the
problem. Then you can build these chunks back up until you have a
working program. <a class="footnote-reference brackets" href="#id11" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p>
<p>You may have been thinking that you will never remember all of these
numbers being thrown at you - the system call numbers, the interrupt
number, etc. In this program we will also introduce a new directive,
<code class="docutils literal notranslate"><span class="pre">.equ</span></code> which should help out. <code class="docutils literal notranslate"><span class="pre">.equ</span></code> allows you to assign names
to numbers. For example, if you did <code class="docutils literal notranslate"><span class="pre">.equ</span> <span class="pre">LINUX_SYSCALL,</span> <span class="pre">0x800x80</span></code>,
any time after that you wrote <code class="docutils literal notranslate"><span class="pre">LINUX_SYSCALL</span></code>, the assembler would
substitue <code class="docutils literal notranslate"><span class="pre">0x80</span></code> for that. So now, you can write</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>int $LINUX_SYSCALL
</pre></div>
</div>
<p>which is much easier to read, and much easier to remember. Coding is
complex, but there are a lot of things we can do like this to make it
easier.</p>
<p>Here is the program. Note that we have more labels than we actually use
for jumps, because some of them are just there for clarity. Try to trace
through the program and see what happens in various cases. An in-depth
explanation of the program will follow.</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">src/toupper-nomm-simplified.s</span><a class="headerlink" href="#id15" title="Link to this code">¶</a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">#PURPOSE:    This program converts an input file </span>
<span class="linenos">  2</span><span class="c1">#            to an output file with all letters </span>
<span class="linenos">  3</span><span class="c1">#            converted to uppercase.</span>
<span class="linenos">  4</span><span class="c1">#</span>
<span class="linenos">  5</span><span class="c1">#PROCESSING: 1) Open the input file</span>
<span class="linenos">  6</span><span class="c1">#            2) Open the output file</span>
<span class="linenos">  7</span><span class="c1">#            3) While we&#39;re not at the end of the input file</span>
<span class="linenos">  8</span><span class="c1">#               a) read part of file into our memory buffer</span>
<span class="linenos">  9</span><span class="c1">#               b) go through each byte of memory</span>
<span class="linenos"> 10</span><span class="c1">#                    if the byte is a lower-case letter, </span>
<span class="linenos"> 11</span><span class="c1">#                    convert it to uppercase</span>
<span class="linenos"> 12</span><span class="c1">#               c) write the memory buffer to output file</span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="w">	</span><span class="na">.section</span><span class="w"> </span><span class="no">.data</span>
<span class="linenos"> 15</span><span class="w">	</span>
<span class="linenos"> 16</span><span class="c1">#######CONSTANTS########</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="w">	</span><span class="c1">#system call numbers</span>
<span class="linenos"> 19</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">SYS_OPEN</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
<span class="linenos"> 20</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">SYS_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="linenos"> 21</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">SYS_READ</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
<span class="linenos"> 22</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">SYS_CLOSE</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span>
<span class="linenos"> 23</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">SYS_EXIT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="w">	</span><span class="c1">#options for open (look at </span>
<span class="linenos"> 26</span><span class="w">	</span><span class="c1">#/usr/include/asm/fcntl.h for</span>
<span class="linenos"> 27</span><span class="w">	</span><span class="c1">#various values.  You can combine them</span>
<span class="linenos"> 28</span><span class="w">	</span><span class="c1">#by adding them or ORing them)</span>
<span class="linenos"> 29</span><span class="w">	</span><span class="c1">#This is discussed at greater length</span>
<span class="linenos"> 30</span><span class="w">	</span><span class="c1">#in &quot;Counting Like a Computer&quot;</span>
<span class="linenos"> 31</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">O_RDONLY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="linenos"> 32</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">O_CREAT_WRONLY_TRUNC</span><span class="p">,</span><span class="w"> </span><span class="mi">03101</span><span class="w"> </span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="w">	</span><span class="c1">#standard file descriptors</span>
<span class="linenos"> 35</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">STDIN</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="linenos"> 36</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">STDOUT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="linenos"> 37</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">STDERR</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span><span class="w">	</span><span class="c1">#system call interrupt</span>
<span class="linenos"> 40</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">LINUX_SYSCALL</span><span class="p">,</span><span class="w"> </span><span class="mi">0x80</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">END_OF_FILE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">#This is the return value </span>
<span class="linenos"> 43</span><span class="w">	                     </span><span class="c1">#of read which means we&#39;ve </span>
<span class="linenos"> 44</span><span class="w">	                     </span><span class="c1">#hit the end of the file</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">NUMBER_ARGUMENTS</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="na">.section</span><span class="w"> </span><span class="no">.bss</span>
<span class="linenos"> 49</span><span class="w">	</span><span class="c1">#Buffer - this is where the data is loaded into </span>
<span class="linenos"> 50</span><span class="w">	</span><span class="c1">#         from the data file and written from </span>
<span class="linenos"> 51</span><span class="w">	</span><span class="c1">#         into the output file.  This should </span>
<span class="linenos"> 52</span><span class="w">	</span><span class="c1">#         never exceed 16,000 for various </span>
<span class="linenos"> 53</span><span class="w">	</span><span class="c1">#         reasons.</span>
<span class="linenos"> 54</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span>
<span class="linenos"> 55</span><span class="w">	</span><span class="na">.lcomm</span><span class="w"> </span><span class="no">BUFFER_DATA</span><span class="p">,</span><span class="w"> </span><span class="no">BUFFER_SIZE</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="w">	</span><span class="na">.section</span><span class="w"> </span><span class="no">.text</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="w">	</span><span class="c1">#STACK POSITIONS</span>
<span class="linenos"> 60</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">ST_SIZE_RESERVE</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
<span class="linenos"> 61</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">ST_FD_IN</span><span class="p">,</span><span class="w"> </span><span class="mi">-4</span>
<span class="linenos"> 62</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">ST_FD_OUT</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span>
<span class="linenos"> 63</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">ST_ARGC</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="c1">#Number of arguments</span>
<span class="linenos"> 64</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">ST_ARGV_0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w">   </span><span class="c1">#Name of program</span>
<span class="linenos"> 65</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">ST_ARGV_1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">   </span><span class="c1">#Input file name</span>
<span class="linenos"> 66</span><span class="w">	</span><span class="na">.equ</span><span class="w"> </span><span class="no">ST_ARGV_2</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w">   </span><span class="c1">#Output file name</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="w">	</span><span class="na">.globl</span><span class="w"> </span><span class="no">_start</span>
<span class="linenos"> 69</span><span class="nl">_start:</span>
<span class="linenos"> 70</span><span class="w">	</span><span class="c1">###INITIALIZE PROGRAM###</span>
<span class="linenos"> 71</span><span class="w">	</span><span class="c1">#save the stack pointer</span>
<span class="linenos"> 72</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="nv">%esp</span><span class="p">,</span><span class="w"> </span><span class="nv">%ebp</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="w">	</span><span class="c1">#Allocate space for our file descriptors </span>
<span class="linenos"> 75</span><span class="w">	</span><span class="c1">#on the stack</span>
<span class="linenos"> 76</span><span class="w">	</span><span class="nf">subl</span><span class="w">  </span><span class="no">$ST_SIZE_RESERVE</span><span class="p">,</span><span class="w"> </span><span class="nv">%esp</span><span class="w">       </span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="no">open_files</span><span class="p">:</span>
<span class="linenos"> 79</span><span class="nl">open_fd_in:</span>
<span class="linenos"> 80</span><span class="w">	</span><span class="c1">###OPEN INPUT FILE###</span>
<span class="linenos"> 81</span><span class="w">	</span><span class="c1">#open syscall</span>
<span class="linenos"> 82</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$SYS_OPEN</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span><span class="w">        </span>
<span class="linenos"> 83</span><span class="w">	</span><span class="c1">#input filename into %ebx</span>
<span class="linenos"> 84</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">ST_ARGV_1</span><span class="p">(</span><span class="nv">%ebp</span><span class="p">),</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">  </span>
<span class="linenos"> 85</span><span class="w">	</span><span class="c1">#read-only flag</span>
<span class="linenos"> 86</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$O_RDONLY</span><span class="p">,</span><span class="w"> </span><span class="nv">%ecx</span><span class="w">        </span>
<span class="linenos"> 87</span><span class="w">	</span><span class="c1">#this doesn&#39;t really matter for reading</span>
<span class="linenos"> 88</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$0666</span><span class="p">,</span><span class="w"> </span><span class="nv">%edx</span><span class="w">            </span>
<span class="linenos"> 89</span><span class="w">	</span><span class="c1">#call Linux</span>
<span class="linenos"> 90</span><span class="w">	</span><span class="nf">int</span><span class="w">   </span><span class="no">$LINUX_SYSCALL</span><span class="w">         </span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="no">store_fd_in</span><span class="p">:</span>
<span class="linenos"> 93</span><span class="w">	</span><span class="c1">#save the given file descriptor</span>
<span class="linenos"> 94</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="nv">%eax</span><span class="p">,</span><span class="w"> </span><span class="no">ST_FD_IN</span><span class="p">(</span><span class="nv">%ebp</span><span class="p">)</span><span class="w">   </span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="no">open_fd_out</span><span class="p">:</span>
<span class="linenos"> 97</span><span class="w">	</span><span class="c1">###OPEN OUTPUT FILE###</span>
<span class="linenos"> 98</span><span class="w">	</span><span class="c1">#open the file</span>
<span class="linenos"> 99</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$SYS_OPEN</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span><span class="w">              </span>
<span class="linenos">100</span><span class="w">	</span><span class="c1">#output filename into %ebx</span>
<span class="linenos">101</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">ST_ARGV_2</span><span class="p">(</span><span class="nv">%ebp</span><span class="p">),</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">        </span>
<span class="linenos">102</span><span class="w">	</span><span class="c1">#flags for writing to the file</span>
<span class="linenos">103</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$O_CREAT_WRONLY_TRUNC</span><span class="p">,</span><span class="w"> </span><span class="nv">%ecx</span><span class="w">  </span>
<span class="linenos">104</span><span class="w">	</span><span class="c1">#permission set for new file (if it&#39;s created)</span>
<span class="linenos">105</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$0666</span><span class="p">,</span><span class="w"> </span><span class="nv">%edx</span><span class="w">                  </span>
<span class="linenos">106</span><span class="w">	</span><span class="c1">#call Linux</span>
<span class="linenos">107</span><span class="w">	</span><span class="nf">int</span><span class="w">   </span><span class="no">$LINUX_SYSCALL</span><span class="w">               </span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="no">store_fd_out</span><span class="p">:</span>
<span class="linenos">110</span><span class="w">	</span><span class="c1">#store the file descriptor here</span>
<span class="linenos">111</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="nv">%eax</span><span class="p">,</span><span class="w"> </span><span class="no">ST_FD_OUT</span><span class="p">(</span><span class="nv">%ebp</span><span class="p">)</span><span class="w">       </span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="w">	</span><span class="c1">###BEGIN MAIN LOOP###	</span>
<span class="linenos">114</span><span class="nl">read_loop_begin:</span>
<span class="linenos">115</span>
<span class="linenos">116</span><span class="w">	</span><span class="c1">###READ IN A BLOCK FROM THE INPUT FILE###</span>
<span class="linenos">117</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$SYS_READ</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="linenos">118</span><span class="w">	</span><span class="c1">#get the input file descriptor</span>
<span class="linenos">119</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">ST_FD_IN</span><span class="p">(</span><span class="nv">%ebp</span><span class="p">),</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">     </span>
<span class="linenos">120</span><span class="w">	</span><span class="c1">#the location to read into</span>
<span class="linenos">121</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$BUFFER_DATA</span><span class="p">,</span><span class="w"> </span><span class="nv">%ecx</span><span class="w">       </span>
<span class="linenos">122</span><span class="w">	</span><span class="c1">#the size of the buffer</span>
<span class="linenos">123</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nv">%edx</span><span class="w">       </span>
<span class="linenos">124</span><span class="w">	</span><span class="c1">#Size of buffer read is returned in %eax</span>
<span class="linenos">125</span><span class="w">	</span><span class="nf">int</span><span class="w">   </span><span class="no">$LINUX_SYSCALL</span><span class="w">           </span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="w">	</span><span class="c1">###EXIT IF WE&#39;VE REACHED THE END###</span>
<span class="linenos">128</span><span class="w">	</span><span class="c1">#check for end of file marker</span>
<span class="linenos">129</span><span class="w">	</span><span class="nf">cmpl</span><span class="w">  </span><span class="no">$END_OF_FILE</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span><span class="w">       </span>
<span class="linenos">130</span><span class="w">	</span><span class="c1">#if found or on error, go to the end</span>
<span class="linenos">131</span><span class="w">	</span><span class="nf">jle</span><span class="w">   </span><span class="no">end_loop</span><span class="w">                 </span>
<span class="linenos">132</span>
<span class="linenos">133</span><span class="no">continue_read_loop</span><span class="p">:</span>
<span class="linenos">134</span><span class="w">	</span><span class="c1">###CONVERT THE BLOCK TO UPPER CASE###</span>
<span class="linenos">135</span><span class="w">	</span><span class="nf">pushl</span><span class="w"> </span><span class="no">$BUFFER_DATA</span><span class="w">     </span><span class="c1">#location of buffer</span>
<span class="linenos">136</span><span class="w">	</span><span class="nf">pushl</span><span class="w"> </span><span class="nv">%eax</span><span class="w">             </span><span class="c1">#size of the buffer</span>
<span class="linenos">137</span><span class="w">	</span><span class="nf">call</span><span class="w">  </span><span class="no">convert_to_upper</span>
<span class="linenos">138</span><span class="w">	</span><span class="nf">popl</span><span class="w">  </span><span class="nv">%eax</span><span class="w">             </span><span class="c1">#get the size back</span>
<span class="linenos">139</span><span class="w">	</span><span class="nf">addl</span><span class="w">  </span><span class="no">$4</span><span class="p">,</span><span class="w"> </span><span class="nv">%esp</span><span class="w">         </span><span class="c1">#restore %esp</span>
<span class="linenos">140</span>
<span class="linenos">141</span><span class="w">	</span><span class="c1">###WRITE THE BLOCK OUT TO THE OUTPUT FILE###</span>
<span class="linenos">142</span><span class="w">	</span><span class="c1">#size of the buffer</span>
<span class="linenos">143</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="nv">%eax</span><span class="p">,</span><span class="w"> </span><span class="nv">%edx</span><span class="w">               </span>
<span class="linenos">144</span><span class="w">	</span><span class="no">movl</span><span class="w">  </span><span class="no">$SYS_WRITE</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="linenos">145</span><span class="w">	</span><span class="c1">#file to use</span>
<span class="linenos">146</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">ST_FD_OUT</span><span class="p">(</span><span class="nv">%ebp</span><span class="p">),</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">    </span>
<span class="linenos">147</span><span class="w">	</span><span class="c1">#location of the buffer</span>
<span class="linenos">148</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$BUFFER_DATA</span><span class="p">,</span><span class="w"> </span><span class="nv">%ecx</span><span class="w">       </span>
<span class="linenos">149</span><span class="w">	</span><span class="no">int</span><span class="w">   </span><span class="no">$LINUX_SYSCALL</span>
<span class="linenos">150</span><span class="w">	</span>
<span class="linenos">151</span><span class="w">	</span><span class="c1">###CONTINUE THE LOOP###</span>
<span class="linenos">152</span><span class="w">	</span><span class="nf">jmp</span><span class="w">   </span><span class="no">read_loop_begin</span>
<span class="linenos">153</span>
<span class="linenos">154</span><span class="nl">end_loop:</span>
<span class="linenos">155</span><span class="w">	</span><span class="c1">###CLOSE THE FILES###</span>
<span class="linenos">156</span><span class="w">	</span><span class="c1">#NOTE - we don&#39;t need to do error checking </span>
<span class="linenos">157</span><span class="w">	</span><span class="c1">#       on these, because error conditions </span>
<span class="linenos">158</span><span class="w">	</span><span class="c1">#       don&#39;t signify anything special here</span>
<span class="linenos">159</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$SYS_CLOSE</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="linenos">160</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">ST_FD_OUT</span><span class="p">(</span><span class="nv">%ebp</span><span class="p">),</span><span class="w"> </span><span class="nv">%ebx</span>
<span class="linenos">161</span><span class="w">	</span><span class="nf">int</span><span class="w">   </span><span class="no">$LINUX_SYSCALL</span>
<span class="linenos">162</span>
<span class="linenos">163</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$SYS_CLOSE</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="linenos">164</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">ST_FD_IN</span><span class="p">(</span><span class="nv">%ebp</span><span class="p">),</span><span class="w"> </span><span class="nv">%ebx</span>
<span class="linenos">165</span><span class="w">	</span><span class="nf">int</span><span class="w">   </span><span class="no">$LINUX_SYSCALL</span>
<span class="linenos">166</span>
<span class="linenos">167</span><span class="w">	</span><span class="c1">###EXIT###</span>
<span class="linenos">168</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$SYS_EXIT</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="linenos">169</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$0</span><span class="p">,</span><span class="w"> </span><span class="nv">%ebx</span>
<span class="linenos">170</span><span class="w">	</span><span class="nf">int</span><span class="w">   </span><span class="no">$LINUX_SYSCALL</span>
<span class="linenos">171</span>
<span class="linenos">172</span>
<span class="linenos">173</span><span class="c1">#PURPOSE:   This function actually does the </span>
<span class="linenos">174</span><span class="c1">#           conversion to upper case for a block</span>
<span class="linenos">175</span><span class="c1">#</span>
<span class="linenos">176</span><span class="c1">#INPUT:     The first parameter is the length of </span>
<span class="linenos">177</span><span class="c1">#           the block of memory to convert</span>
<span class="linenos">178</span><span class="c1">#</span>
<span class="linenos">179</span><span class="c1">#           The second parameter is the starting </span>
<span class="linenos">180</span><span class="c1">#           address of that block of memory</span>
<span class="linenos">181</span><span class="c1">#</span>
<span class="linenos">182</span><span class="c1">#OUTPUT:    This function overwrites the current </span>
<span class="linenos">183</span><span class="c1">#           buffer with the upper-casified version.</span>
<span class="linenos">184</span><span class="c1">#</span>
<span class="linenos">185</span><span class="c1">#VARIABLES:</span>
<span class="linenos">186</span><span class="c1">#           %eax - beginning of buffer</span>
<span class="linenos">187</span><span class="c1">#           %ebx - length of buffer</span>
<span class="linenos">188</span><span class="c1">#           %edi - current buffer offset</span>
<span class="linenos">189</span><span class="c1">#           %cl - current byte being examined </span>
<span class="linenos">190</span><span class="c1">#                 (first part of %ecx)</span>
<span class="linenos">191</span><span class="c1">#</span>
<span class="linenos">192</span>
<span class="linenos">193</span><span class="w">	</span><span class="c1">###CONSTANTS##</span>
<span class="linenos">194</span><span class="w">	</span><span class="c1">#The lower boundary of our search</span>
<span class="linenos">195</span><span class="w">	</span><span class="na">.equ</span><span class="w">  </span><span class="no">LOWERCASE_A</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="no">a</span><span class="err">&#39;</span><span class="w">              </span>
<span class="linenos">196</span><span class="w">	</span><span class="c1">#The upper boundary of our search</span>
<span class="linenos">197</span><span class="w">	</span><span class="na">.equ</span><span class="w">  </span><span class="no">LOWERCASE_Z</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="no">z</span><span class="err">&#39;</span><span class="w">              </span>
<span class="linenos">198</span><span class="w">	</span><span class="c1">#Conversion between upper and lower case</span>
<span class="linenos">199</span><span class="w">	</span><span class="na">.equ</span><span class="w">  </span><span class="no">UPPER_CONVERSION</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="no">A</span><span class="err">&#39;</span><span class="w"> </span><span class="p">-</span><span class="w"> </span><span class="err">&#39;</span><span class="no">a</span><span class="err">&#39;</span><span class="w">   </span>
<span class="linenos">200</span>
<span class="linenos">201</span><span class="w">	</span><span class="c1">###STACK STUFF###</span>
<span class="linenos">202</span><span class="w">	</span><span class="na">.equ</span><span class="w">  </span><span class="no">ST_BUFFER_LEN</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="c1">#Length of buffer</span>
<span class="linenos">203</span><span class="w">	</span><span class="na">.equ</span><span class="w">  </span><span class="no">ST_BUFFER</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w">    </span><span class="c1">#actual buffer</span>
<span class="linenos">204</span><span class="nl">convert_to_upper:</span>
<span class="linenos">205</span><span class="w">	</span><span class="nf">pushl</span><span class="w"> </span><span class="nv">%ebp</span>
<span class="linenos">206</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="nv">%esp</span><span class="p">,</span><span class="w"> </span><span class="nv">%ebp</span>
<span class="linenos">207</span>
<span class="linenos">208</span><span class="w">	</span><span class="c1">###SET UP VARIABLES###</span>
<span class="linenos">209</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">ST_BUFFER</span><span class="p">(</span><span class="nv">%ebp</span><span class="p">),</span><span class="w"> </span><span class="nv">%eax</span>
<span class="linenos">210</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">ST_BUFFER_LEN</span><span class="p">(</span><span class="nv">%ebp</span><span class="p">),</span><span class="w"> </span><span class="nv">%ebx</span>
<span class="linenos">211</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="no">$0</span><span class="p">,</span><span class="w"> </span><span class="nv">%edi</span>
<span class="linenos">212</span>
<span class="linenos">213</span><span class="w">	</span><span class="c1">#if a buffer with zero length was given </span>
<span class="linenos">214</span><span class="w">	</span><span class="c1">#to us, just leave</span>
<span class="linenos">215</span><span class="w">	</span><span class="nf">cmpl</span><span class="w">  </span><span class="no">$0</span><span class="p">,</span><span class="w"> </span><span class="nv">%ebx</span>
<span class="linenos">216</span><span class="w">	</span><span class="nf">je</span><span class="w">    </span><span class="no">end_convert_loop</span>
<span class="linenos">217</span>
<span class="linenos">218</span><span class="nl">convert_loop:</span>
<span class="linenos">219</span><span class="w">	</span><span class="c1">#get the current byte</span>
<span class="linenos">220</span><span class="w">	</span><span class="nf">movb</span><span class="w">  </span><span class="p">(</span><span class="nv">%eax</span><span class="p">,</span><span class="nv">%edi</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nv">%cl</span>
<span class="linenos">221</span>
<span class="linenos">222</span><span class="w">	</span><span class="c1">#go to the next byte unless it is between </span>
<span class="linenos">223</span><span class="w">	</span><span class="c1">#&#39;a&#39; and &#39;z&#39;</span>
<span class="linenos">224</span><span class="w">	</span><span class="nf">cmpb</span><span class="w">  </span><span class="no">$LOWERCASE_A</span><span class="p">,</span><span class="w"> </span><span class="nv">%cl</span>
<span class="linenos">225</span><span class="w">	</span><span class="nf">jl</span><span class="w">    </span><span class="no">next_byte</span>
<span class="linenos">226</span><span class="w">	</span><span class="nf">cmpb</span><span class="w">  </span><span class="no">$LOWERCASE_Z</span><span class="p">,</span><span class="w"> </span><span class="nv">%cl</span>
<span class="linenos">227</span><span class="w">	</span><span class="nf">jg</span><span class="w">    </span><span class="no">next_byte</span>
<span class="linenos">228</span>
<span class="linenos">229</span><span class="w">	</span><span class="c1">#otherwise convert the byte to uppercase</span>
<span class="linenos">230</span><span class="w">	</span><span class="nf">addb</span><span class="w">  </span><span class="no">$UPPER_CONVERSION</span><span class="p">,</span><span class="w"> </span><span class="nv">%cl</span>
<span class="linenos">231</span><span class="w">	</span><span class="c1">#and store it back</span>
<span class="linenos">232</span><span class="w">	</span><span class="nf">movb</span><span class="w">  </span><span class="nv">%cl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nv">%eax</span><span class="p">,</span><span class="nv">%edi</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span>
<span class="linenos">233</span><span class="no">next_byte</span><span class="p">:</span>
<span class="linenos">234</span><span class="w">	</span><span class="nf">incl</span><span class="w">  </span><span class="nv">%edi</span><span class="w">              </span><span class="c1">#next byte</span>
<span class="linenos">235</span><span class="w">	</span><span class="nf">cmpl</span><span class="w">  </span><span class="nv">%edi</span><span class="p">,</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">        </span><span class="c1">#continue unless </span>
<span class="linenos">236</span><span class="w">	                        </span><span class="c1">#we&#39;ve reached the </span>
<span class="linenos">237</span><span class="w">	                        </span><span class="c1">#end</span>
<span class="linenos">238</span><span class="w">	</span><span class="nf">jne</span><span class="w">   </span><span class="no">convert_loop</span>
<span class="linenos">239</span>
<span class="linenos">240</span><span class="nl">end_convert_loop:</span>
<span class="linenos">241</span><span class="w">	</span><span class="c1">#no return value, just leave</span>
<span class="linenos">242</span><span class="w">	</span><span class="nf">movl</span><span class="w">  </span><span class="nv">%ebp</span><span class="p">,</span><span class="w"> </span><span class="nv">%esp</span>
<span class="linenos">243</span><span class="w">	</span><span class="nf">popl</span><span class="w">  </span><span class="nv">%ebp</span>
<span class="linenos">244</span><span class="w">	</span><span class="nf">ret</span>
</pre></div>
</div>
</div>
<p>Type in this program as <code class="docutils literal notranslate"><span class="pre">toupper.s</span></code>, and then enter in the following
commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">as</span> <span class="n">toupper</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span><span class="n">o</span> <span class="n">toupper</span><span class="o">.</span><span class="n">o</span>
<span class="n">ld</span> <span class="n">toupper</span><span class="o">.</span><span class="n">o</span> <span class="o">-</span><span class="n">o</span> <span class="n">toupper</span>
</pre></div>
</div>
<p>This builds a program called <code class="docutils literal notranslate"><span class="pre">toupper</span></code>, which converts all of the
lowercase characters in a file to uppercase. For example, to convert the
file <code class="docutils literal notranslate"><span class="pre">toupper.s</span></code> to uppercase, type in the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">toupper</span> <span class="n">toupper</span><span class="o">.</span><span class="n">s</span> <span class="n">toupper</span><span class="o">.</span><span class="n">uppercase</span>
</pre></div>
</div>
<p>You will now find in the file <code class="docutils literal notranslate"><span class="pre">toupper.uppercase</span></code> an uppercase version
of your original file.</p>
<p>Let’s examine how the program works.</p>
<p>The first section of the program is marked <code class="docutils literal notranslate"><span class="pre">CONSTANTS</span></code>. In
programming, a constant is a value that is assigned when a program
assembles or compiles, and is never changed. I make a habit of placing
all of my constants together at the beginning of the program. It’s only
necessary to declare them before you use them, but putting them all at
the beginning makes them easy to find. Making them all upper-case makes
it obvious in your program which values are constants and where to find
them. <a class="footnote-reference brackets" href="#id12" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> In assembly language, we declare constants with the
<code class="docutils literal notranslate"><span class="pre">.equ</span></code> directive as mentioned before. Here, we simply give names
to all of the standard numbers we’ve used so far, like system call
numbers, the syscall interrupt number, and file open options.</p>
<p>The next section is marked <code class="docutils literal notranslate"><span class="pre">BUFFERS</span></code>. We only use one buffer in this
program, which we call <code class="docutils literal notranslate"><span class="pre">BUFFER_DATA</span></code>. We also define a constant,
<code class="docutils literal notranslate"><span class="pre">BUFFER_SIZE</span></code>, which holds the size of the buffer. If we always refer
to this constant rather than typing out the number 500 whenever we need
to use the size of the buffer, if it later changes, we only need to
modify this value, rather than having to go through the entire program
and changing all of the values individually.</p>
<p>Instead of going on to the <code class="docutils literal notranslate"><span class="pre">_start</span></code> section of the program, go to the
end where we define the <code class="docutils literal notranslate"><span class="pre">convert_to_upper</span></code> function. This is the part
that actually does the conversion.</p>
<p>This section begins with a list of constants that we will use The reason
these are put here rather than at the top is that they only deal with
this one function. We have these definitions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">equ</span>  <span class="n">LOWERCASE_A</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span>
<span class="o">.</span><span class="n">equ</span>  <span class="n">LOWERCASE_Z</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span>
<span class="o">.</span><span class="n">equ</span>  <span class="n">UPPER_CONVERSION</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span> <span class="o">-</span> <span class="s1">&#39;a&#39;</span>
</pre></div>
</div>
<p>The first two simply define the letters that are the boundaries of what
we are searching for. Remember that in the computer, letters are
represented as numbers. Therefore, we can use <code class="docutils literal notranslate"><span class="pre">LOWERCASE_A</span></code> in
comparisons, additions, subtractions, or anything else we can use
numbers in. Also, notice we define the constant <code class="docutils literal notranslate"><span class="pre">UPPER_CONVERSION</span></code>.
Since letters are represented as numbers, we can subtract them.
Subtracting an upper-case letter from the same lower-case letter gives
us how much we need to add to a lower-case letter to make it upper case.
If that doesn’t make sense, look at the ASCII code tables themselves
(see <a class="reference internal" href="asciiap.html#asciilisting"><span class="std std-ref">Table of ASCII Codes</span></a>). You’ll notice that the number for the
character <code class="docutils literal notranslate"><span class="pre">A</span></code> is 65 and the character <code class="docutils literal notranslate"><span class="pre">a</span></code> is 97. The conversion
factor is then -32. For any lowercase letter if you add -32, you will
get its capital equivalent.</p>
<p>After this, we have some constants labelled <code class="docutils literal notranslate"><span class="pre">STACK</span> <span class="pre">POSITIONS</span></code>.
Remember that function parameters are pushed onto the stack before
function calls. These constants (prefixed with <code class="docutils literal notranslate"><span class="pre">ST</span></code> for clarity)
define where in the stack we should expect to find each piece of data.
The return address is at position 4 + %esp;, the length of the
buffer is at position 8 + %esp;, and the address of the buffer is
at position 12 + %esp;. Using symbols for these numbers instead
of the numbers themselves makes it easier to see what data is being used
and moved.</p>
<p>Next comes the label <code class="docutils literal notranslate"><span class="pre">convert_to_upper</span></code>. This is the entry point of
the function. The first two lines are our standard function lines to
save the stack pointer. The next two lines</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">movl</span>  <span class="n">ST_BUFFER</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span> <span class="o">%</span><span class="n">eax</span>
<span class="n">movl</span>  <span class="n">ST_BUFFER_LEN</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span> <span class="o">%</span><span class="n">ebx</span>
</pre></div>
</div>
<p>move the function parameters into the appropriate registers for use.
Then, we load zero into %edi;. What we are going to do is iterate
through each byte of the buffer by loading from the location
%eax; + %edi;, incrementing %edi;, and repeating
until %edi; is equal to the buffer length stored in %ebx;.
The lines</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cmpl  $0, %ebx
je    end_convert_loop
</pre></div>
</div>
<p>are just a sanity check to make sure that noone gave us a buffer of zero
size. If they did, we just clean up and leave. Guarding against
potential user and programming errors is an important task of a
programmer. You can always specify that your function should not take a
buffer of zero size, but it’s even better to have the function check and
have a reliable exit plan if it happens.</p>
<p>Now we start our loop. First, it moves a byte into %cl;. The code
for this is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">movb</span>  <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="o">%</span><span class="n">cl</span>
</pre></div>
</div>
<p>It is using an indexed indirect addressing mode. It says to start at
%eax; and go %edi; locations forward, with each location
being 1 byte big. It takes the value found there, and put it in
%cl;. After this it checks to see if that value is in the range
of lower-case <em>a</em> to lower-case <em>z</em>. To check the range, it simply
checks to see if the letter is smaller than <em>a</em>. If it is, it can’t be a
lower-case letter. Likewise, if it is larger than <em>z</em>, it can’t be a
lower-case letter. So, in each of these cases, it simply moves on. If it
is in the proper range, it then adds the uppercase conversion, and
stores it back into the buffer.</p>
<p>Either way, it then goes to the next value by incrementing %cl;. Next it
checks to see if we are at the end of the buffer. If we are not at the
end, we jump back to the beginning of the loop (the <code class="docutils literal notranslate"><span class="pre">convert_loop</span></code>
label). If we are at the end, it simply continues on to the end of the
function. Because we are modifying the buffer directly, we don’t need to
return anything to the calling program - the changes are already in the
buffer. The label <code class="docutils literal notranslate"><span class="pre">end_convert_loop</span></code> is not needed, but it’s there so
it’s easy to see where the parts of the program are.</p>
<p>Now we know how the conversion process works. Now we need to figure out
how to get the data in and out of the files.</p>
<p>Before reading and writing the files we must open them. The UNIX
<code class="docutils literal notranslate"><span class="pre">open</span></code> system call is what handles this. It takes the following
parameters:</p>
<ul class="simple">
<li><p>%eax; contains the system call number as usual - 5 in
this case.</p></li>
<li><p>%ebx; contains a pointer to a string that is the name
of the file to open. The string must be terminated with the null
character.</p></li>
<li><p>%ecx; contains the options used for opening the file.
These tell Linux how to open the file. They can indicate things such
as open for reading, open for writing, open for reading and writing,
create if it doesn’t exist, delete the file if it already exists,
etc. We will not go into how to create the numbers for the options
until <a class="reference internal" href="counting.html#truthbinarynumbers"><span class="std std-ref">Truth, Falsehood, and Binary Numbers</span></a>. For now, just trust the numbers
we come up with.</p></li>
<li><p>%edx; contains the permissions that are used to open
the file. This is used in case the file has to be created first, so
Linux knows what permissions to create the file with. These are
expressed in octal, just like regular UNIX permissions. <a class="footnote-reference brackets" href="#id13" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a></p></li>
</ul>
<p>After making the system call, the file descriptor of the newly-opened
file is stored in %eax;.</p>
<p>So, what files are we opening? In this example, we will be opening the
files specified on the command-line. Fortunately, command-line
parameters are already stored by Linux in an easy-to-access location,
and are already null-terminated. When a Linux program begins, all
pointers to command-line arguments are stored on the stack. The number
of arguments is stored at <code class="docutils literal notranslate"><span class="pre">(%esp)</span></code>, the name of the program is stored
at <code class="docutils literal notranslate"><span class="pre">4(%esp)</span></code>, and the arguments are stored from <code class="docutils literal notranslate"><span class="pre">8(%esp)</span></code> on. In the
C Programming language, this is referred to as the <code class="docutils literal notranslate"><span class="pre">argv</span></code> array,
so we will refer to it that way in our program.</p>
<p>The first thing our program does is save the current stack position in
%ebp; and then reserve some space on the stack to store the file
descriptors. After this, it starts opening files.</p>
<p>The first file the program opens is the input file, which is the first
command-line argument. We do this by setting up the system call. We put
the file name into %ebx;, the read-only mode number into
%ecx;, the default mode of <code class="docutils literal notranslate"><span class="pre">$0666</span></code> into
%edx;, and the system call number into
%eax; After the system call, the file is open and the
file descriptor is stored in %eax;. <a class="footnote-reference brackets" href="#id14" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a> The file
descriptor is then transferred to its appropriate place on the stack.</p>
<p>The same is then done for the output file, except that it is created
with a write-only, create-if-doesn’t-exist, truncate-if-does-exist mode.
Its file descriptor is stored as well.</p>
<p>Now we get to the main part - the read/write loop. Basically, we will
read fixed-size chunks of data from the input file, call our conversion
function on it, and write it back to the output file. Although we are
reading fixed-size chunks, the size of the chunks don’t matter for this
program - we are just operating on straight sequences of characters. We
could read it in with as little or as large of chunks as we want, and it
still would work properly.</p>
<p>The first part of the loop is to read the data. This uses the
<code class="docutils literal notranslate"><span class="pre">read</span></code> system call. This call just takes a file descriptor to read
from, a buffer to write into, and the size of the buffer (i.e. - the
maximum number of bytes that could be written). The system call returns
the number of bytes actually read, or end-of-file (the number 0).</p>
<p>After reading a block, we check %eax; for an end-of-file
marker. If found, it exits the loop. Otherwise we keep on going.</p>
<p>After the data is read, the <code class="docutils literal notranslate"><span class="pre">convert_to_upper</span></code> function is called with
the buffer we just read in and the number of characters read in the
previous system call. After this function executes, the buffer should be
capitalized and ready to write out. The registers are then restored with
what they had before.</p>
<p>Finally, we issue a <code class="docutils literal notranslate"><span class="pre">write</span></code> system call, which is exactly like
the <code class="docutils literal notranslate"><span class="pre">read</span></code> system call, except that it moves the data from the buffer
out to the file. Now we just go back to the beginning of the loop.</p>
<p>After the loop exits (remember, it exits if, after a read, it detects
the end of the file), it simply closes its file descriptors and exits.
The close system call just takes the file descriptor to close in
%ebx;.</p>
<p>The program is then finished!</p>
</section>
<section id="review">
<h2>Review<a class="headerlink" href="#review" title="Link to this heading">¶</a></h2>
<section id="know-the-concepts">
<h3>Know the Concepts<a class="headerlink" href="#know-the-concepts" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Describe the lifecycle of a file descriptor.</p></li>
<li><p>What are the standard file descriptors and what are they used for?</p></li>
<li><p>What is a buffer?</p></li>
<li><p>What is the difference between the <code class="docutils literal notranslate"><span class="pre">.data</span></code> section and the <code class="docutils literal notranslate"><span class="pre">.bss</span></code>
section?</p></li>
<li><p>What are the system calls related to reading and writing files?</p></li>
</ul>
</section>
<section id="use-the-concepts">
<h3>Use the Concepts<a class="headerlink" href="#use-the-concepts" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Modify the <code class="docutils literal notranslate"><span class="pre">toupper</span></code> program so that it reads from <code class="docutils literal notranslate"><span class="pre">STDIN</span></code> and
writes to <code class="docutils literal notranslate"><span class="pre">STDOUT</span></code> instead of using the files on the command-line.</p></li>
<li><p>Change the size of the buffer.</p></li>
<li><p>Rewrite the program so that it uses storage in the <code class="docutils literal notranslate"><span class="pre">.bss</span></code> section
rather than the stack to store the file descriptors.</p></li>
<li><p>Write a program that will create a file called <code class="docutils literal notranslate"><span class="pre">heynow.txt</span></code> and
write the words “Hey diddle diddle!” into it.</p></li>
</ul>
</section>
<section id="going-further">
<h3>Going Further<a class="headerlink" href="#going-further" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>What difference does the size of the buffer make?</p></li>
<li><p>What error results can be returned by each of these system calls?</p></li>
<li><p>Make the program able to either operate on command-line arguments or
use <code class="docutils literal notranslate"><span class="pre">STDIN</span></code> or <code class="docutils literal notranslate"><span class="pre">STDOUT</span></code> based on the number of command-line
arguments specified by <code class="docutils literal notranslate"><span class="pre">ARGC</span></code>.</p></li>
<li><p>Modify the program so that it checks the results of each system call,
and prints out an error message to <code class="docutils literal notranslate"><span class="pre">STDOUT</span></code> when it occurs.</p></li>
</ul>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id8" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>This will be explained in more detail in
<a class="reference internal" href="counting.html#truthbinarynumbers"><span class="std std-ref">Truth, Falsehood, and Binary Numbers</span></a>.</p>
</aside>
<aside class="footnote brackets" id="id9" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>While this sounds complicated, most of the time in programming you
will not need to deal directly with buffers and file descriptors. In
<a class="reference internal" href="linking.html#linking"><span class="std std-ref">Sharing Functions with Code Libraries</span></a> you will learn how to use existing code present in
Linux to handle most of the complications of file input/output for
you.</p>
</aside>
<aside class="footnote brackets" id="id10" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p>As we mentioned earlier, in Linux, almost everything is a “file”.
Your keyboard input is considered a file, and so is your screen
display.</p>
</aside>
<aside class="footnote brackets" id="id11" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">4</a><span class="fn-bracket">]</span></span>
<p>Maureen Sprankle’s Problem Solving and Programming Concepts is an
excellent book on the problem-solving process applied to computer
programming.</p>
</aside>
<aside class="footnote brackets" id="id12" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">5</a><span class="fn-bracket">]</span></span>
<p>This is fairly standard practice among programmers in all languages.</p>
</aside>
<aside class="footnote brackets" id="id13" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">6</a><span class="fn-bracket">]</span></span>
<p>If you aren’t familiar with UNIX permissions, just put <code class="docutils literal notranslate"><span class="pre">$0666</span></code>
here. Don’t forget the leading zero, as it means that the number is
an octal number.</p>
</aside>
<aside class="footnote brackets" id="id14" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">7</a><span class="fn-bracket">]</span></span>
<p>Notice that we don’t do any error checking on this. That is done just
to keep the program simple. In normal programs, every system call
should normally be checked for success or failure. In failure cases,
%eax; will hold an error code instead of a return value. Error
codes are negative, so they can be detected by comparing
%eax; to zero and jumping if it is less than zero.</p>
</aside>
</aside>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="robust.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Developing Robust Programs</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="functions.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">All About Functions</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Jonathan Bartlett
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Dealing with Files</a><ul>
<li><a class="reference internal" href="#the-unix-file-concept">The UNIX File Concept</a></li>
<li><a class="reference internal" href="#buffers-and-bss">Buffers and <code class="docutils literal notranslate"><span class="pre">.bss</span></code></a></li>
<li><a class="reference internal" href="#standard-and-special-files">Standard and Special Files</a></li>
<li><a class="reference internal" href="#using-files-in-a-program">Using Files in a Program</a></li>
<li><a class="reference internal" href="#review">Review</a><ul>
<li><a class="reference internal" href="#know-the-concepts">Know the Concepts</a></li>
<li><a class="reference internal" href="#use-the-concepts">Use the Concepts</a></li>
<li><a class="reference internal" href="#going-further">Going Further</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="static/documentation_options.js?v=d45e8c67"></script>
    <script src="static/doctools.js?v=9bcbadda"></script>
    <script src="static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>