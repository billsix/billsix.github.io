<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.10">
<title>Computation at Compile-Time</title>
<style type="text/css">
/*
 * AsciiDoc 'volnitsky' theme for xhtml11 and html5 backends.
 * Based on css from http://volnitsky.com, which was in turn based on default
 * theme from AsciiDoc
 *
 * FIXME: The styling is still a bit rough in places.
 *
 */

/* Default font. */
body {
  font-family: Georgia,"Times New Roman",Times,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Candara,Arial,sans-serif;
}


#toc a {
    border-bottom: 1px dotted #999999;
    color: #3A3A4D !important;
    text-decoration: none !important;
}
#toc a:hover {
    border-bottom: 1px solid #6D4100;
    color: #6D4100 !important;
    text-decoration: none !important;
}
a { color: #666688; text-decoration: none; border-bottom: 1px dotted #666688; }
a:visited { color: #615FA0; border-bottom: 1px dotted #615FA0; }
a:hover { color: #6D4100; border-bottom: 1px solid #6D4100; }

em {
  font-style: italic;
  color: #444466;
}

strong {
  font-weight: bold;
  color: #444466;
}

h1, h2, h3, h4, h5, h6 {
  color: #666688;
  margin-bottom: 0.5em;
  line-height: 1.3;
  letter-spacing:+0.15em;
}

h1, h2, h3 { border-bottom: 2px solid #ccd; }
h2 { padding-top: 0.5em; }
h3 { float: left; }
h3 + * { clear: left; }

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid #444466;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #444466;
  font-weight: bold;
  font-size: 1.1em;
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}

#footer-text {
  float: left;
  padding-bottom: 0.5em;
}

#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}

div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}

div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #444466;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock {
  padding-left: 2.0em;
  margin-right: 10%;
}
div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock {
  padding-left: 2.0em;
  margin-right: 10%;
}
div.verseblock > pre.content {
  font-family: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #444466;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: #444466;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

div.tableblock > table {
  border: 3px solid #444466;
}
thead {
  font-weight: bold;
  color: #444466;
}
tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: #444466;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

@media print {
  #footer-badges { display: none; }
}

#toctitle {
  color: #666688;
  font-size: 1.2em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 { margin-top: 0; margin-bottom: 0; }
div.toclevel1 { margin-top: 0.3em; margin-left: 0; font-size: 1.0em; }
div.toclevel2 { margin-top: 0.25em; margin-left: 2em; font-size: 0.9em; }
div.toclevel3 { margin-left: 4em; font-size: 0.8em; }
div.toclevel4 { margin-left: 6em; font-size: 0.8em; }

body {
  margin: 1em 5%;
  max-width:  55em;
  padding-left: 0;

}

.monospaced, tt, div.listingblock > div.content {
  font-family:  Consolas, "Andale Mono", "Courier New", monospace;
  color: #004400;
  background: #f4f4f4;
  max-width: 80em;
  line-height: 1.2em;
}

.paragraph p  {
  line-height: 1.5em;
  margin-top: 1em;
}

.paragraph p, li, dd, .content { max-width: 45em; }
.admonitionblock               { max-width: 35em; }

div.sectionbody div.ulist > ul > li {
  list-style-type: square;
  color: #aaa;
}
  div.sectionbody div.ulist >  ul > li > * {
    color: black;
    /*font-size: 50%;*/
  }


div.sectionbody div.ulist > ul > li div.ulist > ul > li {
  color: #ccd ;
}
  div.sectionbody div.ulist > ul > li div.ulist > ul > li > * {
    color: black ;
  }

em {
  font-style: normal ! important;
  font-weight: bold ! important;
  color: #662222   ! important;
  letter-spacing:+0.08em ! important;
}

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #666688;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #444466;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #444466;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}




@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>Computation at Compile-Time</h1>
<span id="author">Bill Six</span><br>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Copyright 2014-2018&#8201;&#8212;&#8201;William Emerison Six</p></div>
<div class="paragraph"><p>All rights reserved</p></div>
<div class="paragraph"><p>Distributed under LGPL 2.1 or Apache 2.0</p></div>
<div class="paragraph"><p>Source code - <a href="http://github.com/billsix/bug">http://github.com/billsix/bug</a></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_dedication"> Dedication</h2>
<div class="sectionbody">
<div class="paragraph"><p>For Mom and Dad.  Thanks for everything.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_preface"> Preface</h2>
<div class="sectionbody">
<div class="paragraph"><p>This is a book about compiler design for people who have no interest
in studying compiler design.  &#8230;Umm, then who wants to read this book?
Let me try this again&#8230;  This book is the study of
source code which is discarded by the compiler, having no representation in
the generated machine code.
&#8230;Ummm, still not right&#8230;  This book is about viewing a compiler not only
as a means of translating source code into machine code,
but also viewing it as an interpreter capable of any
general purpose computation.  &#8230;Closer, but who cares?&#8230; I think I got it
now. This is a book about "Testing at Compile-Time"!</p></div>
<div class="paragraph"><p>What do I mean by that?  Let&#8217;s say you&#8217;re looking at source code with which
you are unfamiliar, such as the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> permutations
 [|l|
  <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
      ['<span style="color: #FF0000">()</span>]
      [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> permutations <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">))</span>
         <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>
             [<span style="color: #FF0000">(</span>list l<span style="color: #FF0000">)</span>]
             [<span style="color: #FF0000">(</span>flatmap [|x|
                        <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|y| <span style="color: #FF0000">(</span>cons x y<span style="color: #FF0000">)</span>]
                             <span style="color: #FF0000">(</span>permutations <span style="color: #FF0000">(</span>remove x l<span style="color: #FF0000">)))</span>]
                       l<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>What does the code do?  How did the author intend for it to be used?
In trying to answer those questions, fans of statically-typed programming
languages might lament the lack of types, as types help them to reason about
programs and help them to deduce where to look to find more information.
In trying to answer those questions,
fans of dynamically-typed languages might argue "Look at the tests!",
as tests ensure the code functions in a user-specified way and
they serve as a form of documentation.  But
where are those tests?  Probably in some other file whose file-system path is
similar to the current file&#8217;s path (e.g., src/com/BigCorp/HugeProject/Foo.java
is tested by test/com/BigCorp/HugeProject/FooTest.java).
You&#8217;d have to find the file, open the file, look through it
while ignoring tests which are
for other methods.  Frankly, it&#8217;s too much work and it interrupts the flow
of coding, at least for me.</p></div>
<div class="paragraph"><p>But how else would a programmer organize tests?  Well in this book, which is the
implementation of a library called "libbug",
tests may be specified immediately after the procedure&#8217;s definition.
Should any test fail the compiler will
exit in error, like a type error in a
statically-typed language.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{unit-test
<span style="color: #FF0000">(</span>satisfies?
 permutations
 '<span style="color: #FF0000">(</span>
   <span style="color: #FF0000">(()</span> <span style="color: #FF0000">())</span>
   <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)))</span>
   <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
           <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)))</span>
   <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
             <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">3</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
             <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">1</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
             <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
             <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
             <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)))</span>
   <span style="color: #FF0000">))</span>}</tt></pre></div></div>
<div class="paragraph"><p>Why does the collocation of tests with definitions matter?
Towards answering the questions "what does the code do?" and "how did the author
intend for it to be used?", there is neither searching through files nor guessing
how the code was originally intended to be used.
The fact that the
tests are collocated with the procedure definition means that the reader can
inspect the tests without switching between files, perhaps
before looking at the procedure&#8217;s definition.  And the reader
may not even read the procedure at all if the tests gave him enough information
to use it successfully.  Should he want to understand the procedure, he
can mentally apply the procedure to the tests to understand it.</p></div>
<div class="paragraph"><p>Wait a second. If those tests are defined in the source code itself, won&#8217;t they
be in the executable?  And won&#8217;t they run every time I execute the program?
That would be unacceptable as it would both increase the size of the binary and
slow down the program at start up.  Fortunately the
answer to both questions is no, because in chapter <a href="#buglang">[buglang]</a> I show how to specify
that certain code should be interpreted by the compiler instead of being
compiled.  Lisp implementations such as Gambit are particularly well
suited for this style of programming because unevaluated Lisp code is
specified using a data structure of Lisp; because the compiler
is an interpreter capable of being augmented.
Upon finishing compilation, the
compiler has <em>become</em> the very program it is compiling.</p></div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>Libbug is Bill&#8217;s Utilities for Gambit Scheme:  a "standard library" of procedures
which augments Scheme&#8217;s small set of built-in procedures.
Libbug provides procedures for list processing, streams,
control structures,
general-purpose evaluation at compile-time,
and a
compile-time test framework written in only 7 lines of code!
Programs written using libbug optionally may be
programmed in a relatively unobstructive
"literate programming"
style, so that a program can be read linearly in a book form.</p></div>
<div class="sect2">
<h3 id="_prerequisites">1.1. Prerequisites</h3>
<div class="paragraph"><p>The reader is assumed to be somewhat familiar with Scheme, with Common Lisp-style
macros, and with recursive design.  If the book proves too difficult for you,
read "Simply Scheme"<span class="footnote"><br>[available on-line for no cost]<br></span>
or "The Little Schemer".  Since libbug uses Gambit Scheme&#8217;s
Common Lisp-style macros, the author recommends reading "On Lisp"
&lt;<a href="#onlisp">[onlisp]</a>&gt; <span class="footnote"><br>[available on-line for no cost]<br></span>.
The other books listed in the bibliography, all of which inspired ideas for this
book, are recommended reading but are
not necessary to understand the contents of this book.</p></div>
</div>
<div class="sect2">
<h3 id="_order_of_parts">1.2. Order of Parts</h3>
<div class="paragraph"><p>This book is a "literate program", meaning that the source code of libbug is
embedded within this book, and that the book is intended to be able to be
read linearly.
As such, new procedures defined are dependent upon
procedures either defined in standard Gambit Scheme or
which have already been defined earlier in libbug.  In writing the book,
however, it became quite apparent that the foundation upon which libbug is constructed
is by far the most difficult material.  Reading the book in the order which the compiler
compiles the source
would cause the reader to quickly get lost in the "how",
before understanding "why".</p></div>
<div class="paragraph"><p>As such, the ordering of the book was rearranged in an effort to keep the reader
engaged and curious.  The book begins with "Part 1, The Implementation of Libbug"
and ends with "Part 2, Foundations Of Libbug".
The Gambit compiler, however, compiles Part 2 first, then Part 1.</p></div>
</div>
<div class="sect2">
<h3 id="_conventions">1.3. Conventions</h3>
<div class="paragraph"><p>Code which is part of libbug will be outlined and
will have line numbers on the left.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> <span style="font-style: italic"><span style="color: #9A1900">;; This is part of libbug.</span></span></tt></pre></div></div>
<div class="paragraph"><p>Example code which is not part of libbug will not be outlined nor will it have line
numbers.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">(</span>+ <span style="color: #993399">1</span> <span style="color: #FF0000">(</span><span style="color: #FF0000">"This is NOT part of libbug"</span><span style="color: #FF0000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Some examples within this book show interaction with "bug-gsi"  <span class="footnote"><br>[Gambit&#8217;s
Read-Evaluate-Print-Loop (REPL), both with libbug&#8217;s procedures loaded, and with libbug&#8217;s
syntactic extensions.]<br></span>
Such examples will look like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>&gt; <span style="color: #FF0000">(</span>+ <span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
<span style="color: #993399">3</span></tt></pre></div></div>
<div class="paragraph"><p>The line on which the user entered text begins with a "&gt;".  The result
of evaluating that line appears on the subsequent line. In this case, 1 added to 2
evaluates to 3.</p></div>
<div class="sect3">
<h4 id="_syntactic_conventions">1.3.1. Syntactic Conventions</h4>
<div class="paragraph"><p>In libbug, the notation</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">(</span>fun arg1 arg2<span style="color: #FF0000">)</span></tt></pre></div></div>
<div class="paragraph"><p>means evaluate "fun", "arg1"
and "arg2" in any order, then apply "fun" to "arg1" and "arg2";
standard Scheme semantics for invoking a procedure.  But since macros
are not normal procedures and do
not necessarily respect those semantics, in libbug, the notation</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{fun1 arg1 arg2}</tt></pre></div></div>
<div class="paragraph"><p>is used to denote to
the reader that the standard evaluation rules do not necessarily
apply.  For instance, in</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> x <span style="color: #993399">5</span>}</tt></pre></div></div>
<div class="paragraph"><p>{} are used because "x"
may be a new variable.  As such, "x" might not currently evaluate to anything.</p></div>
<div class="paragraph"><p>Not all macro applications use {}.  If the macro always respects Scheme&#8217;s standard
order of evaluation, macro application may use standard Scheme notation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> <span style="color: #FF0000">((</span>compose [|x| <span style="color: #FF0000">(</span>* x <span style="color: #993399">2</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_the_source_code_and_building">1.4. Getting the Source Code And Building</h3>
<div class="paragraph"><p>The Scheme source code is located at <a href="http://github.com/billsix/bug">http://github.com/billsix/bug</a>.
The Scheme files produce the libbug library, as well as this book.
Currently the code works on various distributions of Linux, on FreeBSD, and on Mac
OS X.  The build currently does not work on Windows.</p></div>
<div class="paragraph"><p>The prerequisites for building libbug are a C compiler  <span class="footnote"><br>[such as GCC]<br></span>,
Autoconf, Automake, and Gambit
Scheme <span class="footnote"><br>[<a href="http://gambitscheme.org">http://gambitscheme.org</a>]<br></span> version 4.8 or newer.</p></div>
<div class="paragraph"><p>To compile the book and library, execute the following on the command line:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ ./autogen.sh
$ ./configure --prefix=$BUG_HOME --enable-pdf
$ make
$ make install</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
The argument to "prefix" is the location into which libbug
will be installed when "make install" is executed. "$BUG_HOME" is an
environment variable that I have not defined, so the reader should substitute
"$BUG_HOME" with an actual filesystem path.
</p>
</li>
<li>
<p>
"--enable-pdf" means to build this book as a PDF.  To disable the creation of the PDF,
substitute "--enable-pdf=no".
</p>
</li>
</ul></div>
<div class="paragraph"><p>After installing libbug, you should set the following environment variables.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>export PATH=$BUG_HOME/bin:$PATH
export PKG_CONFIG_PATH=$BUG_HOME/lib/pkgconfig/
export LD_LIBRARY_PATH=$BUG_HOME/lib:$LD_LIBRARY_PATH
export LIBRARY_PATH=$BUG_HOME/lib:$LIBRARY_PATH</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_creating_your_own_project">1.5. Creating Your Own Project</h3>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ bug-create-project testProject 1.0 "Jane Doe &lt;jane@doe.com&gt;"
$ cd testProject/
$ source env.sh
$ ./autogen.sh
$ ./configure --prefix=$BUILD_DIR
....
....
$ make
.....
"FIRST 10 PRIMES"
(2 3 5 7 11 13 17 19 23 29)
....
....
$ make install
....
$ cd $BUILD_DIR
$ ./bin/testProject
"FIRST 10 PRIMES"
(2 3 5 7 11 13 17 19 23 29)</tt></pre></div></div>
<div class="paragraph"><p>Of particular note is that a "FIRST 10 PRIMES", and the 10 values, were printed
during the compilation of the source code in the "make" phase.</p></div>
</div>
<div class="sect2">
<h3 id="_comparison_of_compile_time_computations_in_other_languages">1.6. Comparison of Compile-Time Computations in Other Languages</h3>
<div class="paragraph"><p>What exactly is computation at compile-time?  An introduction
to the topic is provided
in Appendix <a href="#appendix1">[appendix1]</a>
demonstrated
in languages of more widespread use (C and C++),
along with a comparison
of their expressive power.</p></div>
</div>
</div>
</div>
</div>
</div>
<h1 id="_the_implementation_of_libbug">The Implementation of Libbug</h1>
<div class="sect1">
<h2 id="_introductory_procedures">1. Introductory Procedures</h2>
<div class="sectionbody">
<div class="paragraph" id="beginninglibbug"><p>This chapter begins the definition of libbug&#8217;s standard library of Scheme procedures and
macros <span class="footnote"><br>[The code within chapters <a href="#beginninglibbug">[beginninglibbug]</a>
through  <a href="#endinglibbug">[endinglibbug]</a> (inclusive) is found in
"src/main.bug.scm".]<br></span>, along with tests which are run as part of the
compilation process.  If any test fails, the compiler will exit in error,
much like a type error in a statically-typed language.</p></div>
<div class="paragraph"><p>To gain such functionality libbug cannot be defined using Gambit Scheme&#8217;s
"define", "define-macro", and "define-structure", since
they only define variables and
procedures for use at run-time <span class="footnote"><br>[well&#8230; that statement is not true
for "define-macro", but it makes for a simpler explanation upon first reading]<br></span>.
Instead, definitions within
libbug use "libbug-private#define", "libbug-private#define-macro", and
"libbug-private##define-structure" <span class="footnote"><br>[Per convention
within libbug, procedures namespaced to "libbug-private" are not compiled into the library;
such procedures are meant for private use within the implementation
of libbug.]<br></span>, which  are implemented in Chapter <a href="#buglang">[buglang]</a>.
How they are implemented is not relevant yet, since the use of these
procedure-defining procedures will be explained
incrementally.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> <span style="color: #FF0000">(</span>include <span style="color: #FF0000">"bug-language.scm"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    2:</span> {##namespace <span style="color: #FF0000">(</span><span style="color: #FF0000">"libbug-private#"</span> <span style="font-weight: bold"><span style="color: #0000FF">define</span></span> define-macro define-structure<span style="color: #FF0000">)</span>}
<span style="color: #000000">    3:</span> {##namespace <span style="color: #FF0000">(</span><span style="color: #FF0000">"bug#"</span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #FF0000">)</span>}</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 1, the code which makes computation at compile-time possible
is imported. That code is defined in Chapter <a href="#buglang">[buglang]</a>.
</p>
</li>
<li>
<p>
On line 2, Gambit&#8217;s "##namespace" procedure is invoked, ensuring
that all unnamespaced uses of "define", "define-macro",
and "define-structure" will use libbug&#8217;s version of those procedures
instead of Gambit&#8217;s.
</p>
</li>
<li>
<p>
On line 3, all unnamespaced uses of "if" will use libbug&#8217;s version.
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="_noop">1.1. noop</h3>
<div class="paragraph"><p></p></div>
<div class="paragraph"><p>The first definition is "noop" (meaning "no operation"), a procedure which
takes zero arguments and
which evaluates to the symbol 'noop.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> noop
<span style="color: #000000">    2:</span>   ['noop]}</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 1, the libbug-private#define macro <span class="footnote"><br>[defined in section  <a href="#libbugdefine">[libbugdefine]</a>]<br></span>
is invoked.
</p>
</li>
<li>
<p>
On line 1, the variable name "noop".
</p>
</li>
<li>
<p>
On line 2, the lambda literal to be stored into the variable.
Libbug includes a Scheme preprocessor "bug-gscpp",
which expands lambda literals
into lambdas.  In this case, "bug-gscpp" expands
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>['noop]</tt></pre></div></div>
<div class="paragraph"><p>into</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> <span style="color: #FF0000">()</span> 'noop<span style="color: #FF0000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>noop<span style="color: #FF0000">)</span> 'noop<span style="color: #FF0000">)</span>}</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 1, an invocation of "unit-test". In this case, "unit-test" takes one
parameter, which is a test to be run at compile-time.
</p>
</li>
<li>
<p>
On line 2, an expression which evaluates to a boolean.
This is a
test which will be evaluated at compile-time.  Should the test fail,
the compilation of libbug will fail and neither the shared library nor the document which
you are currently reading will be created.
Tests are not present in the created
library.
</p>
</li>
</ul></div>
<div class="paragraph"><p>"noop" does not look useful at first glance, but it is used when
a procedure of zero arguments is required but the resulting value of it is not.
For instance, "noop" is used as a default "exception-handler" for many
procedures within libbug.</p></div>
</div>
<div class="sect2">
<h3 id="_identity">1.2. identity</h3>
<div class="paragraph"><p>"identity" is a procedure of one argument which evaluates to
its argument. &lt;<a href="#calculi">[calculi]</a>&gt;</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> identity
<span style="color: #000000">    2:</span>   [|x| x]}</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 2, "bug-gscpp" expands
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> [|x| x]</tt></pre></div></div>
<div class="paragraph"><p>to</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> <span style="color: #FF0000">(</span>x<span style="color: #FF0000">)</span> x<span style="color: #FF0000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This expansion works with multiple arguments, as long as they are between
the bar symbols "|"  <span class="footnote"><br>[Since "bug-gscpp" uses "|"s for lambda
literals, Scheme&#8217;s block comments are not allowed in libbug programs.]<br></span>.</p></div>
<div class="paragraph"><p>"unit-test" can take more than one test as parameters.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">"foo"</span> <span style="color: #FF0000">(</span>identity <span style="color: #FF0000">"foo"</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    3:</span>  <span style="color: #FF0000">(</span>equal? identity <span style="color: #FF0000">(</span>identity identity<span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_all">1.3. all?</h3>
<div class="paragraph"><p>Like regular Scheme&#8217;s "and", but takes a list instead of a variable number of arguments, and
all elements of the list are evaluated before "all?" is applied.</p></div>
<div class="paragraph" id="langiffirstuse"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> all?
<span style="color: #000000">    2:</span>   [|l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [<span style="color: #009900">#t</span>]
<span style="color: #000000">    5:</span>        [<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>             [<span style="color: #FF0000">(</span>all? <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>]
<span style="color: #000000">    7:</span>             [<span style="color: #009900">#f</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 3, "if", which is currently namespaced to "bug#if"
<span class="footnote"><br>[defined in section <a href="#langif">[langif]</a>]<br></span>, takes
lambda expressions for the two parameters. Libbug pretends that #t and #f are
"Church Booleans" &lt;<a href="#tapl">[tapl]</a>&gt;, and that "bug#if" is just syntactic sugar:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> <span style="color: #009900">#t</span> [|t f| <span style="color: #FF0000">(</span>t<span style="color: #FF0000">)</span>]}
{<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> <span style="color: #009900">#f</span> [|t f| <span style="color: #FF0000">(</span>f<span style="color: #FF0000">)</span>]}
{<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> bug#<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> [|b t f| <span style="color: #FF0000">(</span>b t f<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>As such, "bug#if" would not be a special form, and is more consistent with the
rest of libbug.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>all? '<span style="color: #FF0000">())</span>
<span style="color: #000000">    3:</span>  <span style="color: #FF0000">(</span>all? '<span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>  <span style="color: #FF0000">(</span>all? '<span style="color: #FF0000">(</span><span style="color: #009900">#t</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>  <span style="color: #FF0000">(</span>all? '<span style="color: #FF0000">(</span><span style="color: #009900">#t</span> <span style="color: #009900">#t</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>  <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>all? '<span style="color: #FF0000">(</span><span style="color: #009900">#f</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    7:</span>  <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>all? '<span style="color: #FF0000">(</span><span style="color: #009900">#t</span> <span style="color: #009900">#t</span> <span style="color: #009900">#t</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)))</span>}</tt></pre></div></div>
<div class="paragraph"><p>Tests in libbug are defined for two purposes.  Firstly, to ensure
that the expected behavior of a procedure does not change when the source code
has changed.  Secondly, as a form of documentation.
Libbug is unique <span class="footnote"><br>[as far as the author knows]<br></span> in that the tests are collocated with
the procedure definitions.  The reader is encouraged to read the tests for a
procedure before reading the implementation; since in many cases, the tests are designed
specifically to guide the reader through the implementation.</p></div>
</div>
<div class="sect2">
<h3 id="_satisfies">1.4. satisfies?</h3>
<div class="paragraph"><p>When writing multiple tests, why explicitly invoke the procedure repeatedly
with varying inputs and outputs, as was done for "all?"?  Instead, provide
the procedure and a list
of input/output pairs <span class="footnote"><br>[Within libbug, a parameter named "f" usually means the parameter is
a procedure.]<br></span>.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> satisfies?
<span style="color: #000000">    2:</span>   [|f list-of-pairs|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span>all? <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|pair| <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>f <span style="color: #FF0000">(</span>car pair<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>                               <span style="color: #FF0000">(</span>cadr pair<span style="color: #FF0000">))</span>]
<span style="color: #000000">    5:</span>               list-of-pairs<span style="color: #FF0000">))</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|x| <span style="color: #FF0000">(</span>+ x <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">   10:</span>   all?
<span style="color: #000000">   11:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   12:</span>     <span style="color: #FF0000">(()</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>     <span style="color: #FF0000">((</span><span style="color: #009900">#t</span><span style="color: #FF0000">)</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>     <span style="color: #FF0000">((</span><span style="color: #009900">#t</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   16:</span>     <span style="color: #FF0000">((</span><span style="color: #009900">#f</span><span style="color: #FF0000">)</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   17:</span>     <span style="color: #FF0000">((</span><span style="color: #009900">#t</span> <span style="color: #009900">#t</span> <span style="color: #009900">#t</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   18:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_while">1.5. while</h3>
<div class="paragraph"><p></p></div>
<div class="paragraph"><p>Programmers who are new to the Scheme language  may be surprised that
the language provides no built-in syntax for looping, such as "for"
or "while".  A better question is why don&#8217;t other
languages provide primitives from which you can create
those looping constructs yourself?  "Take the red pill."  <span class="footnote"><br>[Within libbug,
a parameter named "pred?" or "p?" usually means the parameter
is a predicate, meaning a procedure which returns true or false.]<br></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> while
<span style="color: #000000">    2:</span>   [|pred? body|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> while <span style="color: #FF0000">((</span>val 'noop<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>pred?<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          [<span style="color: #FF0000">(</span>while <span style="color: #FF0000">(</span>body<span style="color: #FF0000">))</span>]
<span style="color: #000000">    6:</span>          [val]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>a <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>while [<span style="color: #FF0000">(</span>&lt; a <span style="color: #993399">5</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>                        [{set! a <span style="color: #FF0000">(</span>+ a <span style="color: #993399">1</span><span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                 #!void<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>         <span style="color: #FF0000">(</span>equal? a <span style="color: #993399">5</span><span style="color: #FF0000">)</span>}}
<span style="color: #000000">    7:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>a <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>while [<span style="color: #FF0000">(</span>&lt; a <span style="color: #993399">5</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">    9:</span>                        [{set! a <span style="color: #FF0000">(</span>+ a <span style="color: #993399">1</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">   10:</span>                         'foo]<span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>                 'foo<span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>         <span style="color: #FF0000">(</span>equal? a <span style="color: #993399">5</span><span style="color: #FF0000">)</span>}}}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_numeric_if">1.6. numeric-if</h3>
<div class="paragraph"><p>A conditional expression for numbers, based on their sign. "numeric-if"
uses Gambit&#8217;s keyword syntax.  "ifPositive", "ifZero", and "ifNegative" are
optional arguments, each with their default value as the value in the "noop"
variable.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> numeric-if
<span style="color: #000000">    2:</span>   [|n #!key <span style="color: #FF0000">(</span>ifPositive noop<span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span>ifZero noop<span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span>ifNegative noop<span style="color: #FF0000">)</span>|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>&gt; n <span style="color: #993399">0</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [<span style="color: #FF0000">(</span>ifPositive<span style="color: #FF0000">)</span>]
<span style="color: #000000">    5:</span>        [<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>= n <span style="color: #993399">0</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>             [<span style="color: #FF0000">(</span>ifZero<span style="color: #FF0000">)</span>]
<span style="color: #000000">    7:</span>             [<span style="color: #FF0000">(</span>ifNegative<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#onlisp">[onlisp]</a>&gt;</p></div>
<div class="paragraph"><p>Keyword arguments are optionally passed to the procedure, and use the following syntax.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|n|
<span style="color: #000000">    4:</span>    <span style="color: #FF0000">(</span>numeric-if n
<span style="color: #000000">    5:</span>                ifPositive: ['pos]
<span style="color: #000000">    6:</span>                ifZero: ['zero]
<span style="color: #000000">    7:</span>                ifNegative: ['neg]<span style="color: #FF0000">)</span>]
<span style="color: #000000">    8:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">5</span> pos<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> zero<span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>     <span style="color: #FF0000">(</span>-5 neg<span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   13:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">   14:</span>   [|n|
<span style="color: #000000">   15:</span>    <span style="color: #FF0000">(</span>numeric-if n
<span style="color: #000000">   16:</span>                ifZero: ['zero]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   17:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   18:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">5</span> noop<span style="color: #FF0000">)</span>
<span style="color: #000000">   19:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> zero<span style="color: #FF0000">)</span>
<span style="color: #000000">   20:</span>     <span style="color: #FF0000">(</span>-5 noop<span style="color: #FF0000">)</span>
<span style="color: #000000">   21:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   22:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_atom">1.7. atom?</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> atom?
<span style="color: #000000">    2:</span>   [|x|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #FF0000">(</span>number? x<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        <span style="color: #FF0000">(</span>symbol? x<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>        <span style="color: #FF0000">(</span>boolean? x<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>        <span style="color: #FF0000">(</span>string? x<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>        <span style="color: #FF0000">(</span>char? x<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="paragraph"><p><span class="footnote"><br>[Within libbug, a parameter named "x" usually means the parameter can
be of any type.]<br></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   atom?
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span>/3 <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span>a <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span><span style="color: #009900">#t</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">(</span><span style="color: #009900">#f</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">"string"</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>     <span style="color: #FF0000">(</span><span style="color: #009900">#\c</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>     <span style="color: #FF0000">((</span>make-vector <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">(()</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>     <span style="color: #FF0000">((</span>a<span style="color: #FF0000">)</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   16:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_complement">1.8. complement</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> complement
<span style="color: #000000">    2:</span>   [|f|
<span style="color: #000000">    3:</span>    [|#!rest args|
<span style="color: #000000">    4:</span>     <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>apply f args<span style="color: #FF0000">))</span>]]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#onlisp">[onlisp]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   pair?
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    9:</span>   <span style="color: #FF0000">(</span>complement pair?<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   11:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   14:</span>  }</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lists">2. Lists</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_copy">2.1. copy</h3>
<div class="paragraph"><p>Creates a shallow copy of the list <span class="footnote"><br>[meaning the list structure itself is copied, but not the data
to which each node points.]<br></span> <span class="footnote"><br>[Within libbug, a parameter named "l" usually means the parameter is
a list.]<br></span>.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> copy
<span style="color: #000000">    2:</span>   [|l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> identity l<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>a '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>equal? a <span style="color: #FF0000">(</span>copy a<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>         <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>eq? a <span style="color: #FF0000">(</span>copy a<span style="color: #FF0000">)))</span>}}
<span style="color: #000000">    5:</span>  }</tt></pre></div></div>
<div class="paragraph"><p>For a thorough description of "equal?" vs "eq?", see &lt;<a href="#schemeprogramanguage">[schemeprogramanguage]</a>&gt;.</p></div>
</div>
<div class="sect2">
<h3 id="_proper">2.2. proper?</h3>
<div class="paragraph"><p>Tests that the last element of the list is the sentinel value "'()".
Will not terminate on a circular list.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> proper?
<span style="color: #000000">    2:</span>   [|l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [<span style="color: #009900">#t</span>]
<span style="color: #000000">    5:</span>        [<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>pair? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>             [<span style="color: #FF0000">(</span>proper? <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>]
<span style="color: #000000">    7:</span>             [<span style="color: #009900">#f</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   proper?
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">4</span><span style="color: #FF0000">)</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> . <span style="color: #993399">5</span><span style="color: #FF0000">)</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_first">2.3. first</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> first
<span style="color: #000000">    2:</span>   [|l #!key <span style="color: #FF0000">(</span>onNull noop<span style="color: #FF0000">)</span>|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [<span style="color: #FF0000">(</span>onNull<span style="color: #FF0000">)</span>]
<span style="color: #000000">    5:</span>        [<span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#ss">[ss]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   first
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> noop<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    9:</span>   [|l| <span style="color: #FF0000">(</span>first l onNull: [<span style="color: #993399">5</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   10:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   11:</span>     <span style="color: #FF0000">(()</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_but_first">2.4. but-first</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> but-first
<span style="color: #000000">    2:</span>   [|l #!key <span style="color: #FF0000">(</span>onNull noop<span style="color: #FF0000">)</span>|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [<span style="color: #FF0000">(</span>onNull<span style="color: #FF0000">)</span>]
<span style="color: #000000">    5:</span>        [<span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#ss">[ss]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   but-first
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> noop<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    9:</span>   [|l| <span style="color: #FF0000">(</span>but-first l onNull: [<span style="color: #993399">5</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   10:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   11:</span>     <span style="color: #FF0000">(()</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_last">2.5. last</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> last
<span style="color: #000000">    2:</span>   [|l #!key <span style="color: #FF0000">(</span>onNull noop<span style="color: #FF0000">)</span>|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [<span style="color: #FF0000">(</span>onNull<span style="color: #FF0000">)</span>]
<span style="color: #000000">    5:</span>        [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> last <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>           <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>               [<span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)</span>]
<span style="color: #000000">    8:</span>               [<span style="color: #FF0000">(</span>last <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#ss">[ss]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   last
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> noop<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">   10:</span>   [|l| <span style="color: #FF0000">(</span>last l onNull: [<span style="color: #993399">5</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   11:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   12:</span>     <span style="color: #FF0000">(()</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_but_last">2.6. but-last</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> but-last
<span style="color: #000000">    2:</span>   [|l #!key <span style="color: #FF0000">(</span>onNull noop<span style="color: #FF0000">)</span>|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [<span style="color: #FF0000">(</span>onNull<span style="color: #FF0000">)</span>]
<span style="color: #000000">    5:</span>        [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> but-last <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>           <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>               ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    8:</span>               [<span style="color: #FF0000">(</span>cons <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>                      <span style="color: #FF0000">(</span>but-last <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#ss">[ss]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   but-last
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> noop<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">2</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">2</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">   11:</span>   [|l| <span style="color: #FF0000">(</span>but-last l onNull: [<span style="color: #993399">5</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   12:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">(()</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">2</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   15:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   16:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_filter">2.7. filter</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> filter
<span style="color: #000000">    2:</span>   [|p? l|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> filter <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    6:</span>          [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>first <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)))</span>
<span style="color: #000000">    7:</span>             <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>p? first<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                 [<span style="color: #FF0000">(</span>cons first <span style="color: #FF0000">(</span>filter <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)))</span>]
<span style="color: #000000">    9:</span>                 [<span style="color: #FF0000">(</span>filter <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#ss">[ss]</a>&gt; <span class="footnote"><br>[Simply Scheme has an excellent discussion on section
on Higher-Order Functions and their combinations &lt;<a href="#ss">[ss]</a>&gt;]<br></span>. &lt;<a href="#sicp">[sicp]</a>&gt;.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|l| <span style="color: #FF0000">(</span>filter [|x| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>= <span style="color: #993399">4</span> x<span style="color: #FF0000">))</span>]
<span style="color: #000000">    4:</span>                l<span style="color: #FF0000">)</span>]
<span style="color: #000000">    5:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(()</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">4</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">4</span> <span style="color: #993399">1</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">2</span> <span style="color: #993399">4</span> <span style="color: #993399">1</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   11:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_remove">2.8. remove</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> remove
<span style="color: #000000">    2:</span>   [|x l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span>filter [|y| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? x y<span style="color: #FF0000">))</span>]
<span style="color: #000000">    4:</span>            l<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|l| <span style="color: #FF0000">(</span>remove <span style="color: #993399">5</span> l<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">5</span> <span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_fold_left">2.9. fold-left</h3>
<div class="paragraph"><p>Reduce the list to a scalar by applying the reducing procedure repeatedly,
starting from the "left" side of the list <span class="footnote"><br>[Within libbug, a
parameter named "acc" usually means the parameter
is an accumulated value.]<br></span>.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> fold-left
<span style="color: #000000">    2:</span>   [|f acc l|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> fold-left <span style="color: #FF0000">((</span>acc acc<span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span>l l<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          [acc]
<span style="color: #000000">    6:</span>          [<span style="color: #FF0000">(</span>fold-left <span style="color: #FF0000">(</span>f acc
<span style="color: #000000">    7:</span>                         <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>                      <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#sicp">[sicp]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|l| <span style="color: #FF0000">(</span>fold-left + <span style="color: #993399">5</span> l<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span> <span style="color: #993399">26</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Understanding the first test may give the reader false confidence in understanding
"fold-left".  To understand how "fold-left" really works, understand
how it works with non-commutative procedures, such as "-".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    2:</span>   [|l| <span style="color: #FF0000">(</span>fold-left - <span style="color: #993399">5</span> l<span style="color: #FF0000">)</span>]
<span style="color: #000000">    3:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    4:</span>     <span style="color: #FF0000">(()</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span> -16<span style="color: #FF0000">)))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_sum">2.10. sum</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> sum
<span style="color: #000000">    2:</span>   [|l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span>fold-left + <span style="color: #993399">0</span> l<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   sum
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">((</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span>    <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>  <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #993399">6</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    7:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_fold_right">2.11. fold-right</h3>
<div class="paragraph"><p>Reduces the list to a scalar by applying the reducing
procedure repeatedly,
starting from the "right" side of the list</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> fold-right
<span style="color: #000000">    2:</span>   [|f acc l|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> fold-right <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          [acc]
<span style="color: #000000">    6:</span>          [<span style="color: #FF0000">(</span>f <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>              <span style="color: #FF0000">(</span>fold-right <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#sicp">[sicp]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|l| <span style="color: #FF0000">(</span>fold-right + <span style="color: #993399">5</span> l<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span> <span style="color: #993399">26</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">   11:</span>   [|l| <span style="color: #FF0000">(</span>fold-right - <span style="color: #993399">5</span> l<span style="color: #FF0000">)</span>]
<span style="color: #000000">   12:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">(()</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> -4<span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   16:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span> <span style="color: #993399">2</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   17:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_scan_left">2.12. scan-left</h3>
<div class="paragraph"><p>Like "fold-left", but every intermediate value
of "fold-left"s accumulator is an element in the resulting list of "scan-left".</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> scan-left
<span style="color: #000000">    2:</span>   [|f acc l|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>acc-list <span style="color: #FF0000">(</span>list acc<span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>      {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> scan-left <span style="color: #FF0000">((</span>acc acc<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                      <span style="color: #FF0000">(</span>l l<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                      <span style="color: #FF0000">(</span>last-cell acc-list<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>        <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>            [acc-list]
<span style="color: #000000">    9:</span>            [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>newacc <span style="color: #FF0000">(</span>f acc
<span style="color: #000000">   10:</span>                              <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">))))</span>
<span style="color: #000000">   11:</span>               <span style="color: #FF0000">(</span>scan-left newacc
<span style="color: #000000">   12:</span>                          <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>                          {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">   14:</span>                            {set-cdr! last-cell <span style="color: #FF0000">(</span>list newacc<span style="color: #FF0000">)</span>}
<span style="color: #000000">   15:</span>                            <span style="color: #FF0000">(</span>cdr last-cell<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>}}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|l| <span style="color: #FF0000">(</span>scan-left + <span style="color: #993399">5</span> l<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> <span style="color: #FF0000">(</span><span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">5</span> <span style="color: #993399">6</span> <span style="color: #993399">8</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">5</span> <span style="color: #993399">6</span> <span style="color: #993399">8</span> <span style="color: #993399">11</span> <span style="color: #993399">15</span> <span style="color: #993399">20</span> <span style="color: #993399">26</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">   11:</span>   [|l| <span style="color: #FF0000">(</span>scan-left - <span style="color: #993399">5</span> l<span style="color: #FF0000">)</span>]
<span style="color: #000000">   12:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">(()</span> <span style="color: #FF0000">(</span><span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   14:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">5</span> <span style="color: #993399">4</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   15:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">5</span> <span style="color: #993399">4</span> <span style="color: #993399">2</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   16:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">5</span> <span style="color: #993399">4</span> <span style="color: #993399">2</span> -1 -5 -10 -16<span style="color: #FF0000">))))</span>
<span style="color: #000000">   17:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">   18:</span>   [|l| <span style="color: #FF0000">(</span>scan-left * <span style="color: #993399">1</span> l<span style="color: #FF0000">)</span>]
<span style="color: #000000">   19:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   20:</span>     <span style="color: #FF0000">(()</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   21:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   22:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">6</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   23:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">6</span> <span style="color: #993399">24</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   24:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">6</span> <span style="color: #993399">24</span> <span style="color: #993399">120</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   25:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   26:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_append">2.13. append!</h3>
<div class="paragraph"><p>Like Scheme&#8217;s "append", but recycles the last cons cell, so it is a more
efficient computation at the expense of mutating the input.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> append!
<span style="color: #000000">    2:</span>   [|#!rest ls|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>append! [|second-list first-list|
<span style="color: #000000">    4:</span>                    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? first-list<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                        [second-list]
<span style="color: #000000">    6:</span>                        [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>head first-list<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>                           {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> append! <span style="color: #FF0000">((</span>first-list first-list<span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>                             <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? <span style="color: #FF0000">(</span>cdr first-list<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>                                 [{set-cdr! first-list second-list}]
<span style="color: #000000">   10:</span>                                 [<span style="color: #FF0000">(</span>append! <span style="color: #FF0000">(</span>cdr first-list<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>}
<span style="color: #000000">   11:</span>                           head}]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">))</span>
<span style="color: #000000">   12:</span>      <span style="color: #FF0000">(</span>fold-left append! '<span style="color: #FF0000">()</span> <span style="color: #FF0000">(</span>reverse ls<span style="color: #FF0000">))</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>append! '<span style="color: #FF0000">()</span>
<span style="color: #000000">    3:</span>                   '<span style="color: #FF0000">(</span><span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>append! '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                   '<span style="color: #FF0000">(</span><span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>a '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>        <span style="color: #FF0000">(</span>b '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   10:</span>    <span style="color: #FF0000">(</span>append! a b '<span style="color: #FF0000">(</span><span style="color: #993399">7</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   11:</span>    <span style="color: #FF0000">(</span>equal? a '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span> <span style="color: #993399">7</span><span style="color: #FF0000">))</span>}
<span style="color: #000000">   12:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>a '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   13:</span>        <span style="color: #FF0000">(</span>b '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   14:</span>    <span style="color: #FF0000">(</span>append! a b '<span style="color: #FF0000">(</span><span style="color: #993399">7</span><span style="color: #FF0000">)</span> '<span style="color: #FF0000">(</span><span style="color: #993399">8</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   15:</span>    <span style="color: #FF0000">(</span>equal? a '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span> <span style="color: #993399">7</span> <span style="color: #993399">8</span><span style="color: #FF0000">))</span>}
<span style="color: #000000">   16:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_flatmap">2.14. flatmap</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> flatmap
<span style="color: #000000">    2:</span>   [|f l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span>fold-left append! '<span style="color: #FF0000">()</span> <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> f l<span style="color: #FF0000">))</span>]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#sicp">[sicp]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|l| <span style="color: #FF0000">(</span>flatmap [|x| <span style="color: #FF0000">(</span>list x
<span style="color: #000000">    4:</span>                            <span style="color: #FF0000">(</span>+ x <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                            <span style="color: #FF0000">(</span>+ x <span style="color: #993399">2</span><span style="color: #FF0000">))</span>]
<span style="color: #000000">    6:</span>                 l<span style="color: #FF0000">)</span>]
<span style="color: #000000">    7:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">10</span> <span style="color: #993399">20</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">10</span> <span style="color: #993399">11</span> <span style="color: #993399">12</span> <span style="color: #993399">20</span> <span style="color: #993399">21</span> <span style="color: #993399">22</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>  }</tt></pre></div></div>
<div class="paragraph"><p>Mutating cons cells which were created in this procedure still
respects referential-transparency
from the caller&#8217;s point of view.</p></div>
</div>
<div class="sect2">
<h3 id="_take">2.15. take</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> take
<span style="color: #000000">    2:</span>   [|n l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>            <span style="color: #FF0000">(</span>&lt;= n <span style="color: #993399">0</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">    5:</span>        ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    6:</span>        [<span style="color: #FF0000">(</span>cons <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>               <span style="color: #FF0000">(</span>take <span style="color: #FF0000">(</span>- n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                     <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|n| <span style="color: #FF0000">(</span>take n '<span style="color: #FF0000">(</span>a b<span style="color: #FF0000">))</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span>-1 <span style="color: #FF0000">())</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #FF0000">(</span>a<span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #FF0000">(</span>a b<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #FF0000">(</span>a b<span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_take_while">2.16. take-while</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> take-while
<span style="color: #000000">    2:</span>   [|p? l|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>not-p? <span style="color: #FF0000">(</span>complement p?<span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>      {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> take-while <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>        <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                <span style="color: #FF0000">(</span>not-p? <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">))</span>}
<span style="color: #000000">    7:</span>            ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    8:</span>            [<span style="color: #FF0000">(</span>cons <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>                   <span style="color: #FF0000">(</span>take-while <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>}}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|x| <span style="color: #FF0000">(</span>take-while [|y| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? x y<span style="color: #FF0000">))</span>]
<span style="color: #000000">    4:</span>                    '<span style="color: #FF0000">(</span>a b c<span style="color: #FF0000">))</span>]
<span style="color: #000000">    5:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span>a <span style="color: #FF0000">())</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span>b <span style="color: #FF0000">(</span>a<span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span>c <span style="color: #FF0000">(</span>a b<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">(</span>d <span style="color: #FF0000">(</span>a b c<span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_drop">2.17. drop</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> drop
<span style="color: #000000">    2:</span>   [|n l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>            <span style="color: #FF0000">(</span>&lt;= n <span style="color: #993399">0</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">    5:</span>        [l]
<span style="color: #000000">    6:</span>        [<span style="color: #FF0000">(</span>drop <span style="color: #FF0000">(</span>- n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>               <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|n| <span style="color: #FF0000">(</span>drop n '<span style="color: #FF0000">(</span>a b<span style="color: #FF0000">))</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span>-1 <span style="color: #FF0000">(</span>a b<span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #FF0000">(</span>a b<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #FF0000">(</span>b<span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_drop_while">2.18. drop-while</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> drop-while
<span style="color: #000000">    2:</span>   [|p? l|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>not-p? <span style="color: #FF0000">(</span>complement p?<span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>      {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> drop-while <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>        <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                <span style="color: #FF0000">(</span>not-p? <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">))</span>}
<span style="color: #000000">    7:</span>            [l]
<span style="color: #000000">    8:</span>            [<span style="color: #FF0000">(</span>drop-while <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>}}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|x| <span style="color: #FF0000">(</span>drop-while [|y| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? x y<span style="color: #FF0000">))</span>]
<span style="color: #000000">    4:</span>                    '<span style="color: #FF0000">(</span>a b c<span style="color: #FF0000">))</span>]
<span style="color: #000000">    5:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span>a <span style="color: #FF0000">(</span>a b c<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span>b <span style="color: #FF0000">(</span>b c<span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span>c <span style="color: #FF0000">(</span>c<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">(</span>d <span style="color: #FF0000">())</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">(</span>e <span style="color: #FF0000">())</span>
<span style="color: #000000">   11:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_enumerate_interval">2.19. enumerate-interval</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> enumerate-interval
<span style="color: #000000">    2:</span>   [|low high #!key <span style="color: #FF0000">(</span>step <span style="color: #993399">1</span><span style="color: #FF0000">)</span>|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> enumerate-interval <span style="color: #FF0000">((</span>low low<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>&gt; low high<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    6:</span>          [<span style="color: #FF0000">(</span>cons low
<span style="color: #000000">    7:</span>                 <span style="color: #FF0000">(</span>enumerate-interval <span style="color: #FF0000">(</span>+ low step<span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>enumerate-interval <span style="color: #993399">1</span> <span style="color: #993399">10</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    3:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span> <span style="color: #993399">7</span> <span style="color: #993399">8</span> <span style="color: #993399">9</span> <span style="color: #993399">10</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>enumerate-interval <span style="color: #993399">1</span> <span style="color: #993399">10</span> step: <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span> <span style="color: #993399">9</span><span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_any">2.20. any?</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> any?
<span style="color: #000000">    2:</span>   [|l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [<span style="color: #009900">#f</span>]
<span style="color: #000000">    5:</span>        [<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>             [<span style="color: #009900">#t</span>]
<span style="color: #000000">    7:</span>             [<span style="color: #FF0000">(</span>any? <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   any?
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #009900">#t</span><span style="color: #FF0000">)</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">((</span><span style="color: #009900">#t</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">((</span><span style="color: #009900">#f</span><span style="color: #FF0000">)</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">((</span><span style="color: #009900">#t</span> <span style="color: #009900">#t</span> <span style="color: #009900">#t</span> <span style="color: #009900">#f</span><span style="color: #FF0000">)</span> <span style="color: #009900">#t</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   11:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_zip">2.21. zip</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> zip
<span style="color: #000000">    2:</span>   [|#!rest lsts|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> zip <span style="color: #FF0000">((</span>lsts lsts<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>any? <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> null? lsts<span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>          ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    6:</span>          [<span style="color: #FF0000">(</span>cons <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> car lsts<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>                 <span style="color: #FF0000">(</span>zip <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> cdr lsts<span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip '<span style="color: #FF0000">()</span> '<span style="color: #FF0000">())</span>
<span style="color: #000000">    3:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">    4:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip '<span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> '<span style="color: #FF0000">(</span><span style="color: #993399">4</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>          '<span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">4</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    6:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>          '<span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">5</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    9:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>          '<span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">6</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   13:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip '<span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> '<span style="color: #FF0000">())</span>
<span style="color: #000000">   14:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">   15:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip '<span style="color: #FF0000">()</span> '<span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   16:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">   17:</span>  }</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip '<span style="color: #FF0000">()</span> '<span style="color: #FF0000">()</span> '<span style="color: #FF0000">())</span>
<span style="color: #000000">    3:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">    4:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>               '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>               '<span style="color: #FF0000">(</span><span style="color: #993399">7</span> <span style="color: #993399">8</span> <span style="color: #993399">9</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>          '<span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">4</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">6</span> <span style="color: #993399">9</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   10:</span>  }</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip '<span style="color: #FF0000">()</span> '<span style="color: #FF0000">()</span> '<span style="color: #FF0000">()</span> '<span style="color: #FF0000">())</span>
<span style="color: #000000">    3:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">    4:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>               '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>               '<span style="color: #FF0000">(</span><span style="color: #993399">7</span> <span style="color: #993399">8</span> <span style="color: #993399">9</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>               '<span style="color: #FF0000">(</span><span style="color: #993399">10</span> <span style="color: #993399">11</span> <span style="color: #993399">12</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>          '<span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">4</span> <span style="color: #993399">7</span> <span style="color: #993399">10</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">8</span> <span style="color: #993399">11</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">6</span> <span style="color: #993399">9</span> <span style="color: #993399">12</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   11:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_zip_with">2.22. zip-with</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> zip-with
<span style="color: #000000">    2:</span>   [|f #!rest lsts|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> zip <span style="color: #FF0000">((</span>lsts lsts<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>any? <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> null? lsts<span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>          ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    6:</span>          [<span style="color: #FF0000">(</span>cons <span style="color: #FF0000">(</span>apply f <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> car lsts<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>                 <span style="color: #FF0000">(</span>zip <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> cdr lsts<span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip-with +
<span style="color: #000000">    3:</span>                    '<span style="color: #FF0000">()</span>
<span style="color: #000000">    4:</span>                    '<span style="color: #FF0000">())</span>
<span style="color: #000000">    5:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">    6:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip-with +
<span style="color: #000000">    7:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">4</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip-with +
<span style="color: #000000">   11:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   13:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">5</span> <span style="color: #993399">7</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   14:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip-with +
<span style="color: #000000">   15:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   16:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   17:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">5</span> <span style="color: #993399">7</span> <span style="color: #993399">9</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   18:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip-with +
<span style="color: #000000">   19:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   20:</span>                    '<span style="color: #FF0000">())</span>
<span style="color: #000000">   21:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">   22:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip-with +
<span style="color: #000000">   23:</span>                    '<span style="color: #FF0000">()</span>
<span style="color: #000000">   24:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   25:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">   26:</span>  }</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip-with +
<span style="color: #000000">    3:</span>                    '<span style="color: #FF0000">()</span>
<span style="color: #000000">    4:</span>                    '<span style="color: #FF0000">()</span>
<span style="color: #000000">    5:</span>                    '<span style="color: #FF0000">())</span>
<span style="color: #000000">    6:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">    7:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip-with +
<span style="color: #000000">    8:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">7</span> <span style="color: #993399">8</span> <span style="color: #993399">9</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   11:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">12</span> <span style="color: #993399">15</span> <span style="color: #993399">18</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   12:</span>  }</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip-with +
<span style="color: #000000">    3:</span>                    '<span style="color: #FF0000">()</span>
<span style="color: #000000">    4:</span>                    '<span style="color: #FF0000">()</span>
<span style="color: #000000">    5:</span>                    '<span style="color: #FF0000">()</span>
<span style="color: #000000">    6:</span>                    '<span style="color: #FF0000">())</span>
<span style="color: #000000">    7:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">    8:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>zip-with +
<span style="color: #000000">    9:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">7</span> <span style="color: #993399">8</span> <span style="color: #993399">9</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>                    '<span style="color: #FF0000">(</span><span style="color: #993399">10</span> <span style="color: #993399">11</span> <span style="color: #993399">12</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   13:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">22</span> <span style="color: #993399">26</span> <span style="color: #993399">30</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   14:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_permutations">2.23. permutations</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> permutations
<span style="color: #000000">    2:</span>   [|l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    5:</span>        [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> permutations <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>           <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>               [<span style="color: #FF0000">(</span>list l<span style="color: #FF0000">)</span>]
<span style="color: #000000">    8:</span>               [<span style="color: #FF0000">(</span>flatmap [|x| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|y| <span style="color: #FF0000">(</span>cons x y<span style="color: #FF0000">)</span>]
<span style="color: #000000">    9:</span>                                   <span style="color: #FF0000">(</span>permutations <span style="color: #FF0000">(</span>remove x l<span style="color: #FF0000">)))</span>]
<span style="color: #000000">   10:</span>                         l<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   permutations
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>             <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>               <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">3</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>               <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">1</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>               <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>               <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>               <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   15:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
<div class="paragraph"><p>Inspired by &lt;<a href="#sicp">[sicp]</a>&gt;, although I think they have a slight
mistake in their code.  Given their definition (permutations '())
evaluates to '(()), instead of '().</p></div>
<div class="paragraph"><p>See also &lt;<a href="#taocp">[taocp]</a>&gt;</p></div>
</div>
<div class="sect2">
<h3 id="_cartesian_product">2.24. cartesian-product</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> cartesian-product
<span style="color: #000000">    2:</span>   [|lol|
<span style="color: #000000">    3:</span>    {##<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> cp
<span style="color: #000000">    4:</span>      [|lol|
<span style="color: #000000">    5:</span>       {<span style="font-weight: bold"><span style="color: #0000FF">cond</span></span>
<span style="color: #000000">    6:</span>        <span style="color: #FF0000">((</span>null? <span style="color: #FF0000">(</span>cdr lol<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>         <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> list <span style="color: #FF0000">(</span>car lol<span style="color: #FF0000">)))</span>
<span style="color: #000000">    8:</span>        <span style="color: #FF0000">(</span><span style="color: #009900">#t</span>
<span style="color: #000000">    9:</span>         <span style="color: #FF0000">(</span>flatmap [|x| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|y| <span style="color: #FF0000">(</span>cons x y<span style="color: #FF0000">)</span>]
<span style="color: #000000">   10:</span>                            <span style="color: #FF0000">(</span>cp <span style="color: #FF0000">(</span>cdr lol<span style="color: #FF0000">)))</span>]
<span style="color: #000000">   11:</span>                  <span style="color: #FF0000">(</span>car lol<span style="color: #FF0000">)))</span>}]}
<span style="color: #000000">   12:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">cond</span></span> <span style="color: #FF0000">((</span>null? lol<span style="color: #FF0000">)</span> '<span style="color: #FF0000">())</span>
<span style="color: #000000">   13:</span>          <span style="color: #FF0000">(</span><span style="color: #009900">#t</span> <span style="color: #FF0000">(</span>cp lol<span style="color: #FF0000">))</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>cartesian-product '<span style="color: #FF0000">())</span>
<span style="color: #000000">    3:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">    4:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>cartesian-product '<span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    5:</span>          '<span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">3</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    6:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>cartesian-product '<span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>                               <span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    8:</span>          '<span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   16:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">6</span><span style="color: #FF0000">)))</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>cartesian-product '<span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    2:</span>                               <span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    3:</span>                               <span style="color: #FF0000">(</span><span style="color: #993399">7</span> <span style="color: #993399">8</span> <span style="color: #993399">9</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>          '<span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">4</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">4</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">4</span> <span style="color: #993399">9</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">5</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">5</span> <span style="color: #993399">9</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">6</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">6</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">6</span> <span style="color: #993399">9</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">4</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">4</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">4</span> <span style="color: #993399">9</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   16:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   17:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   18:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">9</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   19:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">6</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   20:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">6</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   21:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">6</span> <span style="color: #993399">9</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   22:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   23:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   24:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">9</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   25:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   26:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   27:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">9</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   28:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">6</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   29:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">6</span> <span style="color: #993399">8</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   30:</span>            <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">6</span> <span style="color: #993399">9</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   31:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_ref_of">2.25. ref-of</h3>
<div class="paragraph"><p>The inverse of list-ref.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> ref-of
<span style="color: #000000">    2:</span>   [|l x #!key <span style="color: #FF0000">(</span>onMissing noop<span style="color: #FF0000">)</span>|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [<span style="color: #FF0000">(</span>onMissing<span style="color: #FF0000">)</span>]
<span style="color: #000000">    5:</span>        [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ref-of <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                      <span style="color: #FF0000">(</span>index <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>           <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)</span> x<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>               [index]
<span style="color: #000000">    9:</span>               [<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>                    [<span style="color: #FF0000">(</span>onMissing<span style="color: #FF0000">)</span>]
<span style="color: #000000">   11:</span>                    [<span style="color: #FF0000">(</span>ref-of <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span>+ index <span style="color: #993399">1</span><span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|x| <span style="color: #FF0000">(</span>ref-of '<span style="color: #FF0000">(</span>a b c d e f g<span style="color: #FF0000">)</span> x<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span>z noop<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span>a <span style="color: #993399">0</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span>b <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span>g <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>  }</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|x| <span style="color: #FF0000">(</span>ref-of '<span style="color: #FF0000">(</span>a b c d e f g<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>                x
<span style="color: #000000">    5:</span>                onMissing: ['missing]<span style="color: #FF0000">)</span>]
<span style="color: #000000">    6:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span>z missing<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span>a <span style="color: #993399">0</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>  }</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>l '<span style="color: #FF0000">(</span>a b c d e f g<span style="color: #FF0000">)))</span>
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    4:</span>     [|x| <span style="color: #FF0000">(</span>list-ref l <span style="color: #FF0000">(</span>ref-of l x<span style="color: #FF0000">))</span>]
<span style="color: #000000">    5:</span>     '<span style="color: #FF0000">(</span>
<span style="color: #000000">    6:</span>       <span style="color: #FF0000">(</span>a a<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>       <span style="color: #FF0000">(</span>b b<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>       <span style="color: #FF0000">(</span>g g<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>       <span style="color: #FF0000">))</span>}
<span style="color: #000000">   10:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_list_set">2.26. list-set!</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> <span style="font-style: italic"><span style="color: #9A1900">;; TODO - handle case where index is too large</span></span>
<span style="color: #000000">    2:</span> <span style="font-style: italic"><span style="color: #9A1900">;; N.B this is called list-sef! instead of list-ref-set!</span></span>
<span style="color: #000000">    3:</span> <span style="font-style: italic"><span style="color: #9A1900">;;  to facilitate use by setf!, as setf! drops the -ref suffix</span></span>
<span style="color: #000000">    4:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> list-set!
<span style="color: #000000">    5:</span>   [|l index val|
<span style="color: #000000">    6:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #993399">0</span> index<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>        [<span style="color: #FF0000">(</span>set-car! l val<span style="color: #FF0000">)</span>]
<span style="color: #000000">    8:</span>        [<span style="color: #FF0000">(</span>list-set! <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span>- index <span style="color: #993399">1</span><span style="color: #FF0000">)</span> val<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>    ]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo '<span style="color: #FF0000">(</span>bar baz quux<span style="color: #FF0000">)))</span>
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span>list-set! foo <span style="color: #993399">0</span> 'blah<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>    <span style="color: #FF0000">(</span>equal? foo '<span style="color: #FF0000">(</span>blah baz quux<span style="color: #FF0000">))</span>}
<span style="color: #000000">    5:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo '<span style="color: #FF0000">(</span>bar baz quux<span style="color: #FF0000">)))</span>
<span style="color: #000000">    6:</span>    <span style="color: #FF0000">(</span>list-set! foo <span style="color: #993399">1</span> 'blah<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>    <span style="color: #FF0000">(</span>equal? foo '<span style="color: #FF0000">(</span>bar blah quux<span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>    }
<span style="color: #000000">    9:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_partition">2.27. partition</h3>
<div class="paragraph"><p>Partitions the input list into two lists, with the criterion being whether or not
the application of the  procedure "p?" to each element of the input list evaluated
to true or false.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> partition
<span style="color: #000000">    2:</span>   [|l p?|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> partition <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>                    <span style="color: #FF0000">(</span>trueList '<span style="color: #FF0000">())</span>
<span style="color: #000000">    5:</span>                    <span style="color: #FF0000">(</span>falseList '<span style="color: #FF0000">()))</span>
<span style="color: #000000">    6:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>          [<span style="color: #FF0000">(</span>list trueList falseList<span style="color: #FF0000">)</span>]
<span style="color: #000000">    8:</span>          [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>head <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)))</span>
<span style="color: #000000">    9:</span>             <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>p? head<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>                 [<span style="color: #FF0000">(</span>partition <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>                             <span style="color: #FF0000">(</span>cons head trueList<span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>                             falseList<span style="color: #FF0000">)</span>]
<span style="color: #000000">   13:</span>                 [<span style="color: #FF0000">(</span>partition <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>                             trueList
<span style="color: #000000">   15:</span>                             <span style="color: #FF0000">(</span>cons head falseList<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|l| <span style="color: #FF0000">(</span>partition l [|x| <span style="color: #FF0000">(</span>&lt;= x <span style="color: #993399">3</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> <span style="color: #FF0000">(()</span>
<span style="color: #000000">    6:</span>          <span style="color: #FF0000">()))</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">4</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                   <span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
<div class="paragraph"><p>In section <a href="#dbind">[dbind]</a>, "destructuring-bind" allows for a more convenient syntax when
using "partition".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>&gt; {destructuring-bind <span style="color: #FF0000">(</span>trueList falseList<span style="color: #FF0000">)</span>
                     <span style="color: #FF0000">(</span>partition '<span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">4</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
                                [|x| <span style="color: #FF0000">(</span>&lt;= x <span style="color: #993399">3</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
                     trueList}
<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
&gt; {destructuring-bind <span style="color: #FF0000">(</span>trueList falseList<span style="color: #FF0000">)</span>
                     <span style="color: #FF0000">(</span>partition '<span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">4</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
                                [|x| <span style="color: #FF0000">(</span>&lt;= x <span style="color: #993399">3</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
                     falseList}
<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_sort">2.28. sort</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> sort
<span style="color: #000000">    2:</span>   [|l comparison?|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> sort <span style="color: #FF0000">((</span>l l<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    6:</span>          [{<span style="font-weight: bold"><span style="color: #0000FF">let*</span></span> <span style="color: #FF0000">((</span>current-node <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>                  <span style="color: #FF0000">(</span>p <span style="color: #FF0000">(</span>partition <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                                [|x| <span style="color: #FF0000">(</span>comparison? x current-node<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">    9:</span>             <span style="color: #FF0000">(</span>append! <span style="color: #FF0000">(</span>sort <span style="color: #FF0000">(</span>car p<span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>                      <span style="color: #FF0000">(</span>cons current-node
<span style="color: #000000">   11:</span>                            <span style="color: #FF0000">(</span>sort <span style="color: #FF0000">(</span>cadr p<span style="color: #FF0000">))))</span>}]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|l| <span style="color: #FF0000">(</span>sort l &lt;<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span> <span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">4</span> <span style="color: #993399">0</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_reverse">2.29. reverse!</h3>
<div class="paragraph"><p>Reverses the list more efficiently by mutating cons cells</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> reverse!
<span style="color: #000000">    2:</span>   [|l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    5:</span>        [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> reverse! <span style="color: #FF0000">((</span>current-cons-cell l<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                        <span style="color: #FF0000">(</span>reversed-list '<span style="color: #FF0000">()))</span>
<span style="color: #000000">    7:</span>           <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? <span style="color: #FF0000">(</span>cdr current-cons-cell<span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>               [{set-cdr! current-cons-cell reversed-list}
<span style="color: #000000">    9:</span>                current-cons-cell]
<span style="color: #000000">   10:</span>               [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>rest <span style="color: #FF0000">(</span>cdr current-cons-cell<span style="color: #FF0000">)))</span>
<span style="color: #000000">   11:</span>                  {set-cdr! current-cons-cell reversed-list}
<span style="color: #000000">   12:</span>                  <span style="color: #FF0000">(</span>reverse! rest current-cons-cell<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   reverse!
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(()</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">((</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>x '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   11:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>y <span style="color: #FF0000">(</span>reverse! x<span style="color: #FF0000">)))</span>
<span style="color: #000000">   12:</span>      {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>equal? y '<span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   13:</span>           <span style="color: #FF0000">(</span>equal? x '<span style="color: #FF0000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">))</span>}}}
<span style="color: #000000">   14:</span>  }</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lifting">3. Lifting</h2>
<div class="sectionbody">
<div class="paragraph"><p>From the Haskell wiki <span class="footnote"><br>[<a href="https://wiki.haskell.org/Lifting">https://wiki.haskell.org/Lifting</a>]<br></span>
"lifting is a concept which allows you to transform a function into
a corresponding function within another (usually more general) setting".</p></div>
<div class="sect2">
<h3 id="_string_lift_list">3.1. string-lift-list</h3>
<div class="paragraph"><p>Strings are sequences of characters, just as lists are
sequences of arbitrary Scheme objects. "string-lift-list"
allows the creation of a context in which strings may
be treated as lists{ <span class="footnote"><br>[Within libbug, a parameter named
"s" usually means the parameter is of type string.]<br></span>.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> string-lift-list
<span style="color: #000000">    2:</span>   [|f|
<span style="color: #000000">    3:</span>    [|#!rest s|
<span style="color: #000000">    4:</span>     <span style="color: #FF0000">(</span>list-&gt;string
<span style="color: #000000">    5:</span>      <span style="color: #FF0000">(</span>apply f
<span style="color: #000000">    6:</span>             <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> string-&gt;list s<span style="color: #FF0000">)))</span>]]}
<span style="color: #000000">    7:</span> </tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_string_reverse">3.2. string-reverse</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> string-reverse
<span style="color: #000000">    2:</span>   <span style="color: #FF0000">(</span>string-lift-list reverse!<span style="color: #FF0000">)</span>}
<span style="color: #000000">    3:</span> </tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   string-reverse
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">""</span> <span style="color: #FF0000">""</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">"foo"</span> <span style="color: #FF0000">"oof"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">"bar"</span> <span style="color: #FF0000">"rab"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_string_take">3.3. string-take</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> string-take
<span style="color: #000000">    2:</span>   [|n s|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>string-take-n <span style="color: #FF0000">(</span>string-lift-list [|l| <span style="color: #FF0000">(</span>take n l<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span>string-take-n s<span style="color: #FF0000">)</span>}]}
<span style="color: #000000">    5:</span> </tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|s| <span style="color: #FF0000">(</span>string-take <span style="color: #993399">2</span> s<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">""</span> <span style="color: #FF0000">""</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">"foo"</span> <span style="color: #FF0000">"fo"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_string_drop">3.4. string-drop</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> string-drop
<span style="color: #000000">    2:</span>   [|n s|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>string-drop-n <span style="color: #FF0000">(</span>string-lift-list [|l| <span style="color: #FF0000">(</span>drop n l<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span>string-drop-n s<span style="color: #FF0000">)</span>}]}
<span style="color: #000000">    5:</span> </tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|s| <span style="color: #FF0000">(</span>string-drop <span style="color: #993399">2</span> s<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">""</span> <span style="color: #FF0000">""</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">"foo"</span> <span style="color: #FF0000">"o"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">"foobar"</span> <span style="color: #FF0000">"obar"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_character_lift_integer">3.5. character-lift-integer</h3>
<div class="paragraph"><p>Characters are stored as integer values in computers, but in Scheme
they are not treated as numbers.
"character-lift-integer"
allows the creation of a context in which the characters may
be treated as integers.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> character-lift-integer
<span style="color: #000000">    2:</span>   [|f|
<span style="color: #000000">    3:</span>    [|#!rest c|
<span style="color: #000000">    4:</span>     <span style="color: #FF0000">(</span>integer-&gt;char
<span style="color: #000000">    5:</span>      <span style="color: #FF0000">(</span>apply f
<span style="color: #000000">    6:</span>             <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> char-&gt;integer c<span style="color: #FF0000">)))</span>]]}
<span style="color: #000000">    7:</span> </tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   <span style="color: #FF0000">(</span>character-lift-integer [|i| <span style="color: #FF0000">(</span>+ i <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span><span style="color: #009900">#\a</span> <span style="color: #009900">#\b</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #009900">#\b</span> <span style="color: #009900">#\c</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span><span style="color: #009900">#\c</span> <span style="color: #009900">#\d</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_string_map">3.6. string-map</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> string-map
<span style="color: #000000">    2:</span>   [|f s|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>string-map-f <span style="color: #FF0000">(</span>string-lift-list [|l| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> f l<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span>string-map-f s<span style="color: #FF0000">)</span>}]}
<span style="color: #000000">    5:</span> </tt></pre></div></div>
<div class="paragraph"><p>The "Caesar Cipher". &lt;<a href="#crypto">[crypto]</a>&gt;.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|s| <span style="color: #FF0000">(</span>string-map [|c| {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>transform-char
<span style="color: #000000">    4:</span>                                <span style="color: #FF0000">(</span>character-lift-integer
<span style="color: #000000">    5:</span>                                 [|base-char c|
<span style="color: #000000">    6:</span>                                  <span style="color: #FF0000">(</span>+ base-char
<span style="color: #000000">    7:</span>                                     <span style="color: #FF0000">(</span>modulo <span style="color: #FF0000">(</span>+ <span style="color: #FF0000">(</span>- c base-char<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                                                <span style="color: #993399">3</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>                                             <span style="color: #993399">26</span><span style="color: #FF0000">))</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">   10:</span>                           <span style="color: #FF0000">(</span>transform-char <span style="color: #009900">#\a</span> c<span style="color: #FF0000">)</span>}]
<span style="color: #000000">   11:</span>                    s<span style="color: #FF0000">)</span>]
<span style="color: #000000">   12:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">""</span> <span style="color: #FF0000">""</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">"abc"</span> <span style="color: #FF0000">"def"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">"nop"</span> <span style="color: #FF0000">"qrs"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   16:</span>     <span style="color: #FF0000">(</span><span style="color: #FF0000">"xyz"</span> <span style="color: #FF0000">"abc"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   17:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   18:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_symbol_lift_list">3.7. symbol-lift-list</h3>
<div class="paragraph"><p>Symbols are sequences of characters, just as lists are
sequences of arbitrary Scheme objects. "symbol-lift-list"
allows the creation of a context in which the symbols may
be treated as lists.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> symbol-lift-list
<span style="color: #000000">    2:</span>   [|f|
<span style="color: #000000">    3:</span>    [|#!rest sym|
<span style="color: #000000">    4:</span>     <span style="color: #FF0000">(</span>string-&gt;symbol
<span style="color: #000000">    5:</span>      <span style="color: #FF0000">(</span>apply <span style="color: #FF0000">(</span>string-lift-list f<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>             <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> symbol-&gt;string sym<span style="color: #FF0000">)))</span>]]}
<span style="color: #000000">    7:</span> </tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   <span style="color: #FF0000">(</span>symbol-lift-list reverse<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span>foo oof<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span>bar rab<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">((</span>symbol-lift-list append!<span style="color: #FF0000">)</span> 'foo 'bar<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>          'foobar<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>  }</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_macros">4. Macros</h2>
<div class="sectionbody">
<div class="paragraph" id="macros"><p>Although many concepts first implemented in Lisp (conditional expressions,
garbage collection, procedures as first-class objects)
have been appropriated into mainstream languages, the one feature of Lisp which
remains difficult for other languages to copy is also Lisp&#8217;s best:  macros.
A Lisp macro is procedure for application at compile-time which takes unevaluated Lisp
code as a parameter and
transforms it into a new form of unevaluated code before further evaluation.
Essentially, they are a facility
by which a programmer may augment the compiler with new functionality <em>while
the compiler is compiling</em>.</p></div>
<div class="paragraph"><p>Transforming unevaluated code into new code introduces a few problems of which
the macro writer must be aware.
First, if the macro needs to create a new variable within the expanded code,
the new variable must have a name, which will be generated during macro-expansion.
This new name inserted into the generated code may clash
with a variable name in the input form; resulting in expanded code which does
not function correctly.  Second, if
unevaluated code which causes side-effects is inserted more than once into
the generated code, the expanded code will likely have unintended side-effects
from the caller of the macro&#8217;s point of view.</p></div>
<div class="paragraph"><p>The first problem is solved using "gensym"s.  The second problem is solved
using "once-only".</p></div>
<div class="paragraph"><p>For a much fuller explanation of the aforementioned problems, the author
recommends reading
"On Lisp" by Paul Graham &lt;<a href="#onlisp">[onlisp]</a>&gt;.</p></div>
<div class="sect2">
<h3 id="_compose">4.1. compose</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {define-macro compose
<span style="color: #000000">    2:</span>   [|#!rest fs|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? fs<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        ['identity]
<span style="color: #000000">    5:</span>        [{<span style="font-weight: bold"><span style="color: #0000FF">let*</span></span> <span style="color: #FF0000">((</span>last-fn-is-lambda-literal
<span style="color: #000000">    6:</span>                 {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>list? <span style="color: #FF0000">(</span>last fs<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>                      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>null? <span style="color: #FF0000">(</span>last fs<span style="color: #FF0000">)))</span>
<span style="color: #000000">    8:</span>                      <span style="color: #FF0000">(</span>equal? '<span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span>
<span style="color: #000000">    9:</span>                              <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>last fs<span style="color: #FF0000">)))</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>                <span style="color: #FF0000">(</span>args <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> last-fn-is-lambda-literal
<span style="color: #000000">   11:</span>                          [<span style="color: #FF0000">(</span>cadr <span style="color: #FF0000">(</span>last fs<span style="color: #FF0000">))</span>]
<span style="color: #000000">   12:</span>                          [<span style="color: #FF0000">(</span>gensym<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">   13:</span>           `{<span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> ,<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> last-fn-is-lambda-literal
<span style="color: #000000">   14:</span>                         [args]
<span style="color: #000000">   15:</span>                         [`<span style="color: #FF0000">(</span>#!rest ,args<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">   16:</span>              ,{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> compose <span style="color: #FF0000">((</span>fs fs<span style="color: #FF0000">))</span>
<span style="color: #000000">   17:</span>                 <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? <span style="color: #FF0000">(</span>cdr fs<span style="color: #FF0000">))</span>
<span style="color: #000000">   18:</span>                     [<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> last-fn-is-lambda-literal
<span style="color: #000000">   19:</span>                          [`{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span> ,@<span style="color: #FF0000">(</span>cddar fs<span style="color: #FF0000">)</span>}]
<span style="color: #000000">   20:</span>                          [`<span style="color: #FF0000">(</span>apply ,<span style="color: #FF0000">(</span>car fs<span style="color: #FF0000">)</span>
<span style="color: #000000">   21:</span>                                   ,args<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   22:</span>                     [`<span style="color: #FF0000">(</span>,<span style="color: #FF0000">(</span>car fs<span style="color: #FF0000">)</span>
<span style="color: #000000">   23:</span>                        ,<span style="color: #FF0000">(</span>compose <span style="color: #FF0000">(</span>cdr fs<span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>}}}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#onlisp">[onlisp]</a>&gt;</p></div>
<div class="ulist"><ul>
<li>
<p>
On line 1, the "libbug-private#define-macro" macro <span class="footnote"><br>[defined in
section  <a href="#libbugdefinemacro">[libbugdefinemacro]</a>]<br></span>
is invoked.  Besides defining the macro, "libbug-private#define-macro"
also exports the
namespace definition and the macro definitions to external files,
for consumption by programs which link against libbug.
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 <span style="color: #FF0000">(</span>compose<span style="color: #FF0000">)</span>}
<span style="color: #000000">    3:</span>          'identity<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">((</span>eval {macroexpand-1 <span style="color: #FF0000">(</span>compose<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">((</span>compose<span style="color: #FF0000">)</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>          <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>  }</tt></pre></div></div>
<div class="paragraph"><p>Macro-expansions occur during compile-time, so how should a programmer
test the resulting form?  Libbug provides "macroexpand-1" which treats the macro
as a procedure which transforms lists into lists, and as such is able
to be tested
<span class="footnote"><br>["macroexpand-1" expands the unevaluated code passed to the
macro into a new unevaluated form, which would have been compiled by the compiler
if "macroexpand-1" had been absent.  But, how should "gensym"
evaluate, since by definition it creates symbols which cannot be typed
by the programmer
into a program?  During the expansion of "macroexpand-1", "gensym"
is overridden by a procedure
which expands into typable symbols like "gensymed-var1", "gensymed-var2", etc.  Each
call during a macro-expansion generates a new, unique symbol.  Although the generated symbol
may clash with symbols in the expanded code, this does not break "gensym" for
run-time evaluation, since run-time "gensym" remains not overridden.
Although testing code within libbug "eval"s code generated from "macroexpand-1",
the author advises against doing such in compiled code.
]<br></span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 <span style="color: #FF0000">(</span>compose [|x| <span style="color: #FF0000">(</span>* x <span style="color: #993399">2</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}
<span style="color: #000000">    3:</span>          '[|x| {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span> <span style="color: #FF0000">(</span>* x <span style="color: #993399">2</span><span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">((</span>eval {macroexpand-1 <span style="color: #FF0000">(</span>compose [|x| <span style="color: #FF0000">(</span>* x <span style="color: #993399">2</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>           <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>          <span style="color: #993399">10</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">((</span>compose [|x| <span style="color: #FF0000">(</span>* x <span style="color: #993399">2</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>           <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>          <span style="color: #993399">10</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>  }
<span style="color: #000000">   11:</span> {unit-test
<span style="color: #000000">   12:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 <span style="color: #FF0000">(</span>compose [|x| <span style="color: #FF0000">(</span>+ x <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">   13:</span>                                  [|y| <span style="color: #FF0000">(</span>* y <span style="color: #993399">2</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}
<span style="color: #000000">   14:</span>          '[|y|
<span style="color: #000000">   15:</span>            <span style="color: #FF0000">(</span>[|x| <span style="color: #FF0000">(</span>+ x <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">   16:</span>             {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span> <span style="color: #FF0000">(</span>* y <span style="color: #993399">2</span><span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">   17:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">((</span>compose [|x| <span style="color: #FF0000">(</span>+ x <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">   18:</span>                    [|y| <span style="color: #FF0000">(</span>* y <span style="color: #993399">2</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">   19:</span>           <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   20:</span>          <span style="color: #993399">11</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   21:</span>  }
<span style="color: #000000">   22:</span> {unit-test
<span style="color: #000000">   23:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 <span style="color: #FF0000">(</span>compose [|x| <span style="color: #FF0000">(</span>/ x <span style="color: #993399">13</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">   24:</span>                                  [|y| <span style="color: #FF0000">(</span>+ y <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">   25:</span>                                  [|z| <span style="color: #FF0000">(</span>* z <span style="color: #993399">2</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}
<span style="color: #000000">   26:</span>          '[|z|
<span style="color: #000000">   27:</span>            <span style="color: #FF0000">(</span>[|x| <span style="color: #FF0000">(</span>/ x <span style="color: #993399">13</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">   28:</span>             <span style="color: #FF0000">(</span>[|y| <span style="color: #FF0000">(</span>+ y <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">   29:</span>              {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span> <span style="color: #FF0000">(</span>* z <span style="color: #993399">2</span><span style="color: #FF0000">)</span>}<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">   30:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">((</span>compose [|x| <span style="color: #FF0000">(</span>/ x <span style="color: #993399">13</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">   31:</span>                    [|y| <span style="color: #FF0000">(</span>+ y <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">   32:</span>                    [|z| <span style="color: #FF0000">(</span>* z <span style="color: #993399">2</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">   33:</span>           <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   34:</span>          <span style="color: #993399">11</span>/13<span style="color: #FF0000">)</span>
<span style="color: #000000">   35:</span>  }
<span style="color: #000000">   36:</span> {unit-test
<span style="color: #000000">   37:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 <span style="color: #FF0000">(</span>compose <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> +<span style="color: #FF0000">)</span>}
<span style="color: #000000">   38:</span>          '[|#!rest gensymed-var1|
<span style="color: #000000">   39:</span>            <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>apply + gensymed-var1<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">   40:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">((</span>compose <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> +<span style="color: #FF0000">)</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   41:</span>          <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   42:</span>  }
<span style="color: #000000">   43:</span> </tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_aif">4.2. aif</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {define-macro aif
<span style="color: #000000">    2:</span>   [|bool ifTrue #!rest ifFalse|
<span style="color: #000000">    3:</span>    `{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>bug#it ,bool<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>       <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> bug#it
<span style="color: #000000">    5:</span>           ,ifTrue
<span style="color: #000000">    6:</span>           ,@<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>null? ifFalse<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>                 [ifFalse]
<span style="color: #000000">    8:</span>                 [<span style="color: #FF0000">(</span>list '[<span style="color: #009900">#f</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">))</span>}]}</tt></pre></div></div>
<div class="paragraph"><p>Although variable capture &lt;<a href="#onlisp">[onlisp]</a>&gt; is generally avoided,
there are instances in which variable capture is desirable &lt;<a href="#onlisp">[onlisp]</a>&gt;.
Within libbug, variables intended for capture are fully qualified with a namespace
to ensure that the variable is captured.</p></div>
<div class="paragraph"><p>&lt;<a href="#onlisp">[onlisp]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 {aif <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">10</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    3:</span>                              [<span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>]}}
<span style="color: #000000">    4:</span>          '{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>bug#it <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">10</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    5:</span>             <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> bug#it
<span style="color: #000000">    6:</span>                 [<span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>]
<span style="color: #000000">    7:</span>                 [<span style="color: #009900">#f</span>]<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>  <span style="color: #FF0000">(</span>equal? {aif <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">10</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>               [<span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>]}
<span style="color: #000000">   10:</span>          <span style="color: #993399">30</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>  <span style="color: #FF0000">(</span>equal? {aif <span style="color: #009900">#f</span>
<span style="color: #000000">   12:</span>               [<span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>]}
<span style="color: #000000">   13:</span>          <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>  <span style="color: #FF0000">(</span>equal? {aif <span style="color: #009900">#f</span>
<span style="color: #000000">   15:</span>               [<span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>]}
<span style="color: #000000">   16:</span>          <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   17:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 {aif <span style="color: #009900">#f</span>
<span style="color: #000000">   18:</span>                              [<span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>]
<span style="color: #000000">   19:</span>                              [<span style="color: #993399">5</span>]}}
<span style="color: #000000">   20:</span>          '{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>bug#it <span style="color: #009900">#f</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   21:</span>             <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> bug#it
<span style="color: #000000">   22:</span>                 [<span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>]
<span style="color: #000000">   23:</span>                 [<span style="color: #993399">5</span>]<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">   24:</span>  <span style="color: #FF0000">(</span>equal? {aif <span style="color: #009900">#f</span>
<span style="color: #000000">   25:</span>               [<span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>]
<span style="color: #000000">   26:</span>               [<span style="color: #993399">5</span>]}
<span style="color: #000000">   27:</span>          <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   28:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_with_gensyms">4.3. with-gensyms</h3>
<div class="paragraph"><p>"with-gensyms" is a macro to be invoked from other macros.  It is a utility
to minimize repetitive calls to "gensym".</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {define-macro with-gensyms
<span style="color: #000000">    2:</span>   [|symbols #!rest body|
<span style="color: #000000">    3:</span>    `{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ,<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|symbol| `<span style="color: #FF0000">(</span>,symbol <span style="color: #FF0000">(</span>gensym<span style="color: #FF0000">))</span>]
<span style="color: #000000">    4:</span>                symbols<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>       ,@body}]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#onlisp">[onlisp]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 {with-gensyms <span style="color: #FF0000">(</span>foo bar baz<span style="color: #FF0000">)</span>
<span style="color: #000000">    3:</span>                                       `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    4:</span>                                          <span style="color: #FF0000">(</span>pp ,foo<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                                          <span style="color: #FF0000">(</span>pp ,bar<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                                          <span style="color: #FF0000">(</span>pp ,baz<span style="color: #FF0000">)</span>}}}
<span style="color: #000000">    7:</span>          '{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo <span style="color: #FF0000">(</span>gensym<span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>                 <span style="color: #FF0000">(</span>bar <span style="color: #FF0000">(</span>gensym<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>                 <span style="color: #FF0000">(</span>baz <span style="color: #FF0000">(</span>gensym<span style="color: #FF0000">)))</span>
<span style="color: #000000">   10:</span>             `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">   11:</span>                <span style="color: #FF0000">(</span>pp ,foo<span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>                <span style="color: #FF0000">(</span>pp ,bar<span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>                <span style="color: #FF0000">(</span>pp ,baz<span style="color: #FF0000">)</span>}}<span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_once_only">4.4. once-only</h3>
<div class="paragraph"><p></p></div>
<div class="paragraph"><p>Sometimes macros need to put two or more copies of an argument
into the generated code.
But that can cause that form to be evaluated multiple times,
possibly with side-effects,
which is seldom expected by the caller.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>&gt; {define-macro double [|x| `<span style="color: #FF0000">(</span>+ ,x ,x<span style="color: #FF0000">)</span>]}
&gt; {double <span style="color: #993399">5</span>}
<span style="color: #993399">10</span></tt></pre></div></div>
<div class="paragraph"><p>The caller of "double" should reasonably expect the argument to "double"
only to be evaluated once only, because that&#8217;s how Scheme usually works.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>&gt; {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> foo <span style="color: #993399">5</span>}
&gt; {double {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span> {set! foo <span style="color: #FF0000">(</span>+ foo <span style="color: #993399">1</span><span style="color: #FF0000">)</span>}
                foo}}
<span style="color: #993399">13</span></tt></pre></div></div>
<div class="paragraph"><p>"once-only" allows a macro-writer to ensure that a variable is evaluated
only once in the generated code.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>&gt; {define-macro double [|x| {once-only <span style="color: #FF0000">(</span>x<span style="color: #FF0000">)</span> `<span style="color: #FF0000">(</span>+ ,x ,x<span style="color: #FF0000">)</span>}]}
&gt; {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> foo <span style="color: #993399">5</span>}
&gt; {double {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span> {set! foo <span style="color: #FF0000">(</span>+ foo <span style="color: #993399">1</span><span style="color: #FF0000">)</span>}
                foo}}
<span style="color: #993399">12</span></tt></pre></div></div>
<div class="paragraph"><p>Like "with-gensyms", "once-only" is a macro to be used by other macros.  Code
which generates code which generates code.  Unlike
"with-gensyms", which wraps its argument with a new context to be used for
later macro-expansions, "once-only" needs to defer binding the variable to a
"gensym"-ed variable until the second macro-expansion.  As such, it is the
most difficult macro is this book.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {define-macro once-only
<span style="color: #000000">    2:</span>   [|symbols #!rest body|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>gensyms <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|s| <span style="color: #FF0000">(</span>gensym<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>                        symbols<span style="color: #FF0000">)))</span>
<span style="color: #000000">    5:</span>      `<span style="color: #FF0000">(</span>list '<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>
<span style="color: #000000">    6:</span>             <span style="color: #FF0000">(</span>append ,@<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|g s| `<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>atom? ,s<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>                                        ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    8:</span>                                        [<span style="color: #FF0000">(</span>list <span style="color: #FF0000">(</span>list <span style="color: #FF0000">(</span>quote ,g<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>                                                     ,s<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   10:</span>                            gensyms
<span style="color: #000000">   11:</span>                            symbols<span style="color: #FF0000">))</span>
<span style="color: #000000">   12:</span>             ,<span style="color: #FF0000">(</span>append <span style="color: #FF0000">(</span>list '<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>
<span style="color: #000000">   13:</span>                            <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|s g| <span style="color: #FF0000">(</span>list s
<span style="color: #000000">   14:</span>                                              `<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>atom? ,s<span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>                                                   [,s]
<span style="color: #000000">   16:</span>                                                   [<span style="color: #FF0000">(</span>quote ,g<span style="color: #FF0000">)</span>]<span style="color: #FF0000">))</span>]
<span style="color: #000000">   17:</span>                                 symbols
<span style="color: #000000">   18:</span>                                 gensyms<span style="color: #FF0000">))</span>
<span style="color: #000000">   19:</span>                      body<span style="color: #FF0000">))</span>}]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#paip">[paip]</a>&gt;</p></div>
<div class="paragraph"><p>"atom"s are handled as a special case to minimize the creation
of "gensym"ed variables since evaluation of "atom"s
causes no side effects, thus causes no problems from multiple evaluation.</p></div>
<div class="sect3">
<h4 id="_first_macro_expansion">4.4.1. First Macro-expansion</h4>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 {once-only <span style="color: #FF0000">(</span>x y<span style="color: #FF0000">)</span> `<span style="color: #FF0000">(</span>+ ,x ,y ,x<span style="color: #FF0000">)</span>}}
<span style="color: #000000">    3:</span>          `<span style="color: #FF0000">(</span>list '<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>
<span style="color: #000000">    4:</span>                 <span style="color: #FF0000">(</span>append <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>atom? x<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                             ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    6:</span>                             [<span style="color: #FF0000">(</span>list <span style="color: #FF0000">(</span>list 'gensymed-var1 x<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>                         <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>atom? y<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                             ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    9:</span>                             [<span style="color: #FF0000">(</span>list <span style="color: #FF0000">(</span>list 'gensymed-var2 y<span style="color: #FF0000">))</span>]<span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>                 {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>x <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>atom? x<span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>                              [x]
<span style="color: #000000">   12:</span>                              ['gensymed-var1]<span style="color: #FF0000">))</span>
<span style="color: #000000">   13:</span>                       <span style="color: #FF0000">(</span>y <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>atom? y<span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>                              [y]
<span style="color: #000000">   15:</span>                              ['gensymed-var2<span style="color: #FF0000">))))</span>
<span style="color: #000000">   16:</span>                   `<span style="color: #FF0000">(</span>+ ,x ,y ,x<span style="color: #FF0000">)</span>}<span style="color: #FF0000">))</span>
<span style="color: #000000">   17:</span>  }</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_the_second_macro_expansion">4.4.2. The Second Macro-expansion</h4>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>eval `{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>x <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    3:</span>                       <span style="color: #FF0000">(</span>y <span style="color: #993399">6</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>                   ,{macroexpand-1
<span style="color: #000000">    5:</span>                     {once-only <span style="color: #FF0000">(</span>x y<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                                `<span style="color: #FF0000">(</span>+ ,x ,y ,x<span style="color: #FF0000">)</span>}}}<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>          `{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">()</span> <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">6</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>eval `{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>x '<span style="color: #FF0000">(</span>car foo<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>                       <span style="color: #FF0000">(</span>y <span style="color: #993399">6</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>                   ,{macroexpand-1
<span style="color: #000000">   11:</span>                     {once-only <span style="color: #FF0000">(</span>x y<span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>                                `<span style="color: #FF0000">(</span>+ ,x ,y ,x<span style="color: #FF0000">)</span>}}}<span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>          '{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>gensymed-var1 <span style="color: #FF0000">(</span>car foo<span style="color: #FF0000">)))</span>
<span style="color: #000000">   14:</span>             <span style="color: #FF0000">(</span>+ gensymed-var1 <span style="color: #993399">6</span> gensymed-var1<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>eval `{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>x '<span style="color: #FF0000">(</span>car foo<span style="color: #FF0000">))</span>
<span style="color: #000000">   16:</span>                       <span style="color: #FF0000">(</span>y '<span style="color: #FF0000">(</span>baz<span style="color: #FF0000">)))</span>
<span style="color: #000000">   17:</span>                   ,{macroexpand-1
<span style="color: #000000">   18:</span>                     {once-only <span style="color: #FF0000">(</span>x y<span style="color: #FF0000">)</span>
<span style="color: #000000">   19:</span>                                `<span style="color: #FF0000">(</span>+ ,x ,y ,x<span style="color: #FF0000">)</span>}}}<span style="color: #FF0000">)</span>
<span style="color: #000000">   20:</span>          '{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>gensymed-var1 <span style="color: #FF0000">(</span>car foo<span style="color: #FF0000">))</span>
<span style="color: #000000">   21:</span>                 <span style="color: #FF0000">(</span>gensymed-var2 <span style="color: #FF0000">(</span>baz<span style="color: #FF0000">)))</span>
<span style="color: #000000">   22:</span>             <span style="color: #FF0000">(</span>+ gensymed-var1 gensymed-var2 gensymed-var1<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">   23:</span>  }</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_the_evaluation_of_the_twice_expanded_code">4.4.3. The Evaluation of the twice-expanded Code</h4>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>eval <span style="color: #FF0000">(</span>eval `{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>x <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    3:</span>                             <span style="color: #FF0000">(</span>y <span style="color: #993399">6</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>                         ,{macroexpand-1
<span style="color: #000000">    5:</span>                           {once-only <span style="color: #FF0000">(</span>x y<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                                      `<span style="color: #FF0000">(</span>+ ,x ,y ,x<span style="color: #FF0000">)</span>}}}<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>          <span style="color: #993399">16</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>  }</tt></pre></div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generalized_assignment">5. Generalized Assignment</h2>
<div class="sectionbody">
<div class="paragraph"><p>;;<a id="endinglibbug"></a></p></div>
<div class="sect2">
<h3 id="_setf">5.1. setf!</h3>
<div class="paragraph"><p>"Rather than thinking about two distinct functions that respectively
access and update a storage location somehow deduced from their arguments,
we can instead simply think of a call to the access function with given
arguments as a <em>name</em> for the storage location." &lt;<a href="#cl">[cl]</a>&gt;</p></div>
<div class="paragraph"><p>Create a macro named "setf!" which invokes the appropriate
"setting" procedure, based on the given "accessing" procedure <span class="footnote"><br>[The
implementation is inspired by &lt;<a href="#setf">[setf]</a>&gt;.]<br></span>.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {define-macro setf!
<span style="color: #000000">    2:</span>   [|exp val|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>pair? exp<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>        [`{set! ,exp ,val}]
<span style="color: #000000">    5:</span>        [{<span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">(</span>car exp<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>           <span style="color: #FF0000">((</span>car<span style="color: #FF0000">)</span>  `{set-car! ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>           <span style="color: #FF0000">((</span>cdr<span style="color: #FF0000">)</span>  `{set-cdr! ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>           <span style="color: #FF0000">((</span>caar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>car ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>           <span style="color: #FF0000">((</span>cadr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cdr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>           <span style="color: #FF0000">((</span>cdar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>car ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>           <span style="color: #FF0000">((</span>cddr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>cdr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>           <span style="color: #FF0000">((</span>caaar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>caar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>           <span style="color: #FF0000">((</span>caadr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cadr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>           <span style="color: #FF0000">((</span>cadar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cdar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>           <span style="color: #FF0000">((</span>caddr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cddr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   16:</span>           <span style="color: #FF0000">((</span>cdaar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>caar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   17:</span>           <span style="color: #FF0000">((</span>cdadr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>cadr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   18:</span>           <span style="color: #FF0000">((</span>cddar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>cdar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   19:</span>           <span style="color: #FF0000">((</span>cdddr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>cddr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   20:</span>           <span style="color: #FF0000">((</span>caaaar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>caaar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   21:</span>           <span style="color: #FF0000">((</span>caaadr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>caadr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   22:</span>           <span style="color: #FF0000">((</span>caadar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cadar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   23:</span>           <span style="color: #FF0000">((</span>caaddr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>caddr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   24:</span>           <span style="color: #FF0000">((</span>cadaar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cdaar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   25:</span>           <span style="color: #FF0000">((</span>cadadr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cdadr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   26:</span>           <span style="color: #FF0000">((</span>caddar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cddar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   27:</span>           <span style="color: #FF0000">((</span>cadddr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cdddr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   28:</span>           <span style="color: #FF0000">((</span>cdaaar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>caaar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   29:</span>           <span style="color: #FF0000">((</span>cdaadr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>caadr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   30:</span>           <span style="color: #FF0000">((</span>cdadar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>cadar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   31:</span>           <span style="color: #FF0000">((</span>cdaddr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>caddr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   32:</span>           <span style="color: #FF0000">((</span>cddaar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>cdaar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   33:</span>           <span style="color: #FF0000">((</span>cddadr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>cdadr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   34:</span>           <span style="color: #FF0000">((</span>cdddar<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>cddar ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   35:</span>           <span style="color: #FF0000">((</span>cddddr<span style="color: #FF0000">)</span> `{setf! <span style="color: #FF0000">(</span>cdr <span style="color: #FF0000">(</span>cdddr ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span> ,val}<span style="color: #FF0000">)</span>
<span style="color: #000000">   36:</span>           <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">else</span></span> `<span style="color: #FF0000">(</span>,{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>append-set!
<span style="color: #000000">   37:</span>                           <span style="color: #FF0000">(</span>symbol-lift-list
<span style="color: #000000">   38:</span>                            [|l -set! -ref|
<span style="color: #000000">   39:</span>                             <span style="color: #FF0000">(</span>append!
<span style="color: #000000">   40:</span>                              <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>reverse -ref<span style="color: #FF0000">)</span>
<span style="color: #000000">   41:</span>                                          <span style="color: #FF0000">(</span>take <span style="color: #993399">4</span> <span style="color: #FF0000">(</span>reverse l<span style="color: #FF0000">)))</span>
<span style="color: #000000">   42:</span>                                  [<span style="color: #FF0000">(</span>reverse <span style="color: #FF0000">(</span>drop <span style="color: #993399">4</span>
<span style="color: #000000">   43:</span>                                                  <span style="color: #FF0000">(</span>reverse l<span style="color: #FF0000">)))</span>]
<span style="color: #000000">   44:</span>                                  [l]<span style="color: #FF0000">)</span>
<span style="color: #000000">   45:</span>                              -set!<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">   46:</span>                      <span style="color: #FF0000">(</span>append-set! <span style="color: #FF0000">(</span>car exp<span style="color: #FF0000">)</span>
<span style="color: #000000">   47:</span>                                   '-set!
<span style="color: #000000">   48:</span>                                   '-ref<span style="color: #FF0000">)</span>}
<span style="color: #000000">   49:</span>                   ,@<span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)</span>
<span style="color: #000000">   50:</span>                   ,val<span style="color: #FF0000">))</span>}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="sect3">
<h4 id="_updating_a_variable_directly">5.1.1. Updating a Variable Directly</h4>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1
<span style="color: #000000">    3:</span>           {setf! foo <span style="color: #993399">10</span>}}
<span style="color: #000000">    4:</span>          '{set! foo <span style="color: #993399">10</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>a <span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>    {setf! a <span style="color: #993399">10</span>}
<span style="color: #000000">    7:</span>    <span style="color: #FF0000">(</span>equal? a <span style="color: #993399">10</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">    8:</span>  }</tt></pre></div></div>
<div class="sect4">
<h5 id="_updating_car_cdr_8230_through_cddddr">Updating Car, Cdr, &#8230; Through Cddddr</h5>
<div class="paragraph"><p>Test updating "car".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1
<span style="color: #000000">    3:</span>           {setf! <span style="color: #FF0000">(</span>car foo<span style="color: #FF0000">)</span> <span style="color: #993399">10</span>}}
<span style="color: #000000">    4:</span>          '{set-car! foo <span style="color: #993399">10</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    6:</span>    {setf! <span style="color: #FF0000">(</span>car foo<span style="color: #FF0000">)</span> <span style="color: #993399">10</span>}
<span style="color: #000000">    7:</span>    <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>car foo<span style="color: #FF0000">)</span> <span style="color: #993399">10</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">    8:</span>  }</tt></pre></div></div>
<div class="paragraph"><p>Test updating "cdr".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1
<span style="color: #000000">    3:</span>           {setf! <span style="color: #FF0000">(</span>cdr foo<span style="color: #FF0000">)</span> <span style="color: #993399">10</span>}}
<span style="color: #000000">    4:</span>          '{set-cdr! foo <span style="color: #993399">10</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    6:</span>    {setf! <span style="color: #FF0000">(</span>cdr foo<span style="color: #FF0000">)</span> <span style="color: #993399">10</span>}
<span style="color: #000000">    7:</span>    <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>cdr foo<span style="color: #FF0000">)</span> <span style="color: #993399">10</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">    8:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo '<span style="color: #FF0000">(</span>bar baz quux<span style="color: #FF0000">)))</span>
<span style="color: #000000">    9:</span>    {setf! <span style="color: #FF0000">(</span>list-ref foo <span style="color: #993399">2</span><span style="color: #FF0000">)</span> 'blah}
<span style="color: #000000">   10:</span>    <span style="color: #FF0000">(</span>equal? foo '<span style="color: #FF0000">(</span>bar baz blah<span style="color: #FF0000">))</span>}
<span style="color: #000000">   11:</span>  }</tt></pre></div></div>
<div class="paragraph"><p>Testing all of the "car" through "cddddr" procedures would
be quite
repetitive.  Instead, create a list which has an element at each of those
accessor procedures, and test each.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>eval
<span style="color: #000000">    3:</span>   `{<span style="font-weight: bold"><span style="color: #0000FF">and</span></span>
<span style="color: #000000">    4:</span>     ,@<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|x| `{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo '<span style="color: #FF0000">((((</span>the-caaaar<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                                 the-cadaar<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                                <span style="color: #FF0000">(</span>the-caadar<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>                                <span style="color: #FF0000">())</span>
<span style="color: #000000">    8:</span>                               <span style="color: #FF0000">((</span>the-caaadr<span style="color: #FF0000">)</span> the-cadadr<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>                               <span style="color: #FF0000">(</span>the-caaddr<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>                               <span style="color: #FF0000">()</span>
<span style="color: #000000">   11:</span>                               <span style="color: #FF0000">)))</span>
<span style="color: #000000">   12:</span>                    {setf! <span style="color: #FF0000">(</span>,x foo<span style="color: #FF0000">)</span> <span style="color: #993399">10</span>}
<span style="color: #000000">   13:</span>                    <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>,x foo<span style="color: #FF0000">)</span> <span style="color: #993399">10</span><span style="color: #FF0000">)</span>}]
<span style="color: #000000">   14:</span>            '<span style="color: #FF0000">(</span>car
<span style="color: #000000">   15:</span>              cdr
<span style="color: #000000">   16:</span>              caar cadr
<span style="color: #000000">   17:</span>              cdar cddr
<span style="color: #000000">   18:</span>              caaar caadr cadar caddr
<span style="color: #000000">   19:</span>              cdaar cdadr cddar cdddr
<span style="color: #000000">   20:</span>              caaaar caaadr caadar caaddr
<span style="color: #000000">   21:</span>              cadaar cadadr caddar cadddr
<span style="color: #000000">   22:</span>              cdaaar cdaadr cdadar cdaddr
<span style="color: #000000">   23:</span>              cddaar cddadr cdddar cddddr
<span style="color: #000000">   24:</span>              <span style="color: #FF0000">))</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">   25:</span>  }</tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_suffixed_by_set">Suffixed By -set!</h5>
<div class="paragraph"><p>Test updating procedures where the updating procedure is
the name of the getting procedure, suffixed by <em>-set!</em>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {at-compile-time
<span style="color: #000000">    2:</span>  {##define-structure foo bar}}
<span style="color: #000000">    3:</span>
<span style="color: #000000">    4:</span> {unit-test
<span style="color: #000000">    5:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1
<span style="color: #000000">    6:</span>           {setf! <span style="color: #FF0000">(</span>foo-bar f<span style="color: #FF0000">)</span> <span style="color: #993399">10</span>}}
<span style="color: #000000">    7:</span>          '{foo-bar-set! f <span style="color: #993399">10</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    9:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>f <span style="color: #FF0000">(</span>make-foo <span style="color: #993399">1</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   10:</span>      {setf! <span style="color: #FF0000">(</span>foo-bar f<span style="color: #FF0000">)</span> <span style="color: #993399">10</span>}
<span style="color: #000000">   11:</span>      <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>make-foo <span style="color: #993399">10</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>              f<span style="color: #FF0000">)</span>}}
<span style="color: #000000">   13:</span>  }</tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_ref_replaced_by_set">-ref Replaced By -set!</h5>
<div class="paragraph"><p>Test updating procedures where the updating procedure is
the name of the getting procedure, with the "-ref" suffix removed, replaced
with "-set".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1
<span style="color: #000000">    3:</span>           {setf! <span style="color: #FF0000">(</span>string-ref s <span style="color: #993399">0</span><span style="color: #FF0000">)</span> <span style="color: #009900">#\q</span>}}
<span style="color: #000000">    4:</span>          '{string-set! s <span style="color: #993399">0</span> <span style="color: #009900">#\q</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>s <span style="color: #FF0000">"foobar"</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>    {setf! <span style="color: #FF0000">(</span>string-ref s <span style="color: #993399">0</span><span style="color: #FF0000">)</span> <span style="color: #009900">#\q</span>}
<span style="color: #000000">    7:</span>    <span style="color: #FF0000">(</span>equal? s <span style="color: #FF0000">"qoobar"</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">    8:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1
<span style="color: #000000">    9:</span>           {setf! <span style="color: #FF0000">(</span>vector-ref v <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #993399">4</span>}}
<span style="color: #000000">   10:</span>          '{vector-set! v <span style="color: #993399">2</span> <span style="color: #993399">4</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>v <span style="color: #FF0000">(</span>vector <span style="color: #993399">1</span> <span style="color: #993399">2</span> '<span style="color: #FF0000">()</span> <span style="color: #FF0000">""</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   12:</span>    {setf! <span style="color: #FF0000">(</span>vector-ref v <span style="color: #993399">2</span><span style="color: #FF0000">)</span> <span style="color: #993399">4</span>}
<span style="color: #000000">   13:</span>    <span style="color: #FF0000">(</span>equal? v
<span style="color: #000000">   14:</span>            <span style="color: #FF0000">(</span>vector <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">4</span> <span style="color: #FF0000">""</span><span style="color: #FF0000">))</span>}
<span style="color: #000000">   15:</span>  }</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mutate">5.2. mutate!</h3>
<div class="paragraph"><p>Like "setf!", "mutate!" takes a generalized variable
as input, but it additionally takes a procedure to be applied
to the value of the generalized variable; the result of the application
will be stored back into the generalized variable <span class="footnote"><br>["mutate!" is
used in similar contexts as Common Lisp&#8217;s
"define-modify-macro" would be, but it is more general, as
it allows the new procedure to remain anonymous, as compared
to making a new name like "toggle" &lt;<a href="#onlisp">[onlisp]</a>&gt;.]<br></span>.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {define-macro mutate!
<span style="color: #000000">    2:</span>   [|exp f|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>symbol? exp<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [`{setf! ,exp <span style="color: #FF0000">(</span>,f ,exp<span style="color: #FF0000">)</span>}]
<span style="color: #000000">    5:</span>        [{<span style="font-weight: bold"><span style="color: #0000FF">let*</span></span> <span style="color: #FF0000">((</span>atom-or-binding <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|x| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>atom? x<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                                               [x]
<span style="color: #000000">    7:</span>                                               [<span style="color: #FF0000">(</span>list <span style="color: #FF0000">(</span>gensym<span style="color: #FF0000">)</span> x<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">    8:</span>                                      <span style="color: #FF0000">(</span>cdr exp<span style="color: #FF0000">)))</span>
<span style="color: #000000">    9:</span>                <span style="color: #FF0000">(</span>args-of-generalized-var <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|x| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>atom? x<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>                                                       [x]
<span style="color: #000000">   11:</span>                                                       [<span style="color: #FF0000">(</span>car x<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   12:</span>                                              atom-or-binding<span style="color: #FF0000">)))</span>
<span style="color: #000000">   13:</span>           `{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ,<span style="color: #FF0000">(</span>filter <span style="color: #FF0000">(</span>complement atom?<span style="color: #FF0000">)</span> atom-or-binding<span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>              {setf! <span style="color: #FF0000">(</span>,<span style="color: #FF0000">(</span>car exp<span style="color: #FF0000">)</span> ,@args-of-generalized-var<span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>                     <span style="color: #FF0000">(</span>,f <span style="color: #FF0000">(</span>,<span style="color: #FF0000">(</span>car exp<span style="color: #FF0000">)</span> ,@args-of-generalized-var<span style="color: #FF0000">))</span>}}}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 {mutate! foo <span style="font-weight: bold"><span style="color: #0000FF">not</span></span>}}
<span style="color: #000000">    3:</span>          '{setf! foo <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> foo<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo <span style="color: #009900">#t</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span>
<span style="color: #000000">    6:</span>     {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    7:</span>       {mutate! foo <span style="font-weight: bold"><span style="color: #0000FF">not</span></span>}
<span style="color: #000000">    8:</span>       <span style="color: #FF0000">(</span>equal? foo <span style="color: #009900">#f</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">    9:</span>     {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">   10:</span>       {mutate! foo <span style="font-weight: bold"><span style="color: #0000FF">not</span></span>}
<span style="color: #000000">   11:</span>       <span style="color: #FF0000">(</span>equal? foo <span style="color: #009900">#t</span><span style="color: #FF0000">)</span>}}}
<span style="color: #000000">   12:</span>  }</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1 {mutate! <span style="color: #FF0000">(</span>vector-ref foo <span style="color: #993399">0</span><span style="color: #FF0000">)</span> [|n| <span style="color: #FF0000">(</span>+ n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]}}
<span style="color: #000000">    3:</span>          '{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">()</span>
<span style="color: #000000">    4:</span>             {setf! <span style="color: #FF0000">(</span>vector-ref foo <span style="color: #993399">0</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                    <span style="color: #FF0000">(</span>[|n| <span style="color: #FF0000">(</span>+ n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>] <span style="color: #FF0000">(</span>vector-ref foo <span style="color: #993399">0</span><span style="color: #FF0000">))</span>}}<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo <span style="color: #FF0000">(</span>vector <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    7:</span>    {mutate! <span style="color: #FF0000">(</span>vector-ref foo <span style="color: #993399">0</span><span style="color: #FF0000">)</span> [|n| <span style="color: #FF0000">(</span>+ n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]}
<span style="color: #000000">    8:</span>    <span style="color: #FF0000">(</span>equal? foo
<span style="color: #000000">    9:</span>            <span style="color: #FF0000">(</span>vector <span style="color: #993399">1</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span><span style="color: #FF0000">))</span>}
<span style="color: #000000">   10:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo <span style="color: #FF0000">(</span>vector <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   11:</span>    {mutate! <span style="color: #FF0000">(</span>vector-ref foo <span style="color: #993399">2</span><span style="color: #FF0000">)</span> [|n| <span style="color: #FF0000">(</span>+ n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]}
<span style="color: #000000">   12:</span>    <span style="color: #FF0000">(</span>equal? foo
<span style="color: #000000">   13:</span>            <span style="color: #FF0000">(</span>vector <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">1</span><span style="color: #FF0000">))</span>}
<span style="color: #000000">   14:</span>  }</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1
<span style="color: #000000">    3:</span>           {mutate! <span style="color: #FF0000">(</span>vector-ref foo {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    4:</span>                                      {setf! index <span style="color: #FF0000">(</span>+ <span style="color: #993399">1</span> index<span style="color: #FF0000">)</span>}
<span style="color: #000000">    5:</span>                                      index}<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                    [|n| <span style="color: #FF0000">(</span>+ n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]}}
<span style="color: #000000">    7:</span>          '{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>gensymed-var1 {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    8:</span>                                  {setf! index <span style="color: #FF0000">(</span>+ <span style="color: #993399">1</span> index<span style="color: #FF0000">)</span>}
<span style="color: #000000">    9:</span>                                  index}<span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>             {setf! <span style="color: #FF0000">(</span>vector-ref foo gensymed-var1<span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>                    <span style="color: #FF0000">(</span>[|n| <span style="color: #FF0000">(</span>+ n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>] <span style="color: #FF0000">(</span>vector-ref foo gensymed-var1<span style="color: #FF0000">))</span>}}<span style="color: #FF0000">)</span>
<span style="color: #000000">   12:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo <span style="color: #FF0000">(</span>vector <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   13:</span>        <span style="color: #FF0000">(</span>index <span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   14:</span>    {mutate! <span style="color: #FF0000">(</span>vector-ref foo {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">   15:</span>                               {setf! index <span style="color: #FF0000">(</span>+ <span style="color: #993399">1</span> index<span style="color: #FF0000">)</span>}
<span style="color: #000000">   16:</span>                               index}<span style="color: #FF0000">)</span>
<span style="color: #000000">   17:</span>             [|n| <span style="color: #FF0000">(</span>+ n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]}
<span style="color: #000000">   18:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>equal? foo
<span style="color: #000000">   19:</span>                 <span style="color: #FF0000">(</span>vector <span style="color: #993399">0</span> <span style="color: #993399">0</span> <span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   20:</span>         <span style="color: #FF0000">(</span>equal? index
<span style="color: #000000">   21:</span>                 <span style="color: #993399">2</span><span style="color: #FF0000">)</span>}}
<span style="color: #000000">   22:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_destructuring_bind">5.3. destructuring-bind</h3>
<div class="paragraph" id="dbind"><p></p></div>
<div class="paragraph"><p>"destructuring-bind" is a generalization of "let", in which multiple variables
may be bound to values based on their positions within a (possibly nested) list.
Look at the tests
at the end of the section for an example.</p></div>
<div class="paragraph"><p>"destructuring-bind" is a complicated macro which can be decomposed into a regular
procedure named "tree-of-accessors", and the macro "destructuring-bind"
<span class="footnote"><br>[This poses a small problem.  "tree-of-accessors" is not macroexpanded as it a not a
macro, therefore it does not have access to the compile-time "gensym" procedure
which allows macro-expansions to be tested.  To allow "tree-of-accessors" to
be tested independently, as well as part of "destructuring-bind", "tree-of-accessors"
takes a procedure named "gensym" as an argument, defaulting to whatever value
"gensym" is by default in the environment.]<br></span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> tree-of-accessors
<span style="color: #000000">    2:</span>   [|pat lst #!key <span style="color: #FF0000">(</span>gensym gensym<span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span>n <span style="color: #993399">0</span><span style="color: #FF0000">)</span>|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> tree-of-accessors <span style="color: #FF0000">((</span>pat pat<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>                            <span style="color: #FF0000">(</span>lst lst<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                            <span style="color: #FF0000">(</span>n n<span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>      {<span style="font-weight: bold"><span style="color: #0000FF">cond</span></span> <span style="color: #FF0000">((</span>null? pat<span style="color: #FF0000">)</span>                '<span style="color: #FF0000">())</span>
<span style="color: #000000">    7:</span>            <span style="color: #FF0000">((</span>symbol? pat<span style="color: #FF0000">)</span>              `<span style="color: #FF0000">((</span>,pat <span style="color: #FF0000">(</span>drop ,n ,lst<span style="color: #FF0000">))))</span>
<span style="color: #000000">    8:</span>            <span style="color: #FF0000">((</span>equal? <span style="color: #FF0000">(</span>car pat<span style="color: #FF0000">)</span> '#!rest<span style="color: #FF0000">)</span> `<span style="color: #FF0000">((</span>,<span style="color: #FF0000">(</span>cadr pat<span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span>drop ,n
<span style="color: #000000">    9:</span>                                                             ,lst<span style="color: #FF0000">))))</span>
<span style="color: #000000">   10:</span>            <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<span style="color: #000000">   11:</span>             <span style="color: #FF0000">(</span>cons {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>p <span style="color: #FF0000">(</span>car pat<span style="color: #FF0000">)))</span>
<span style="color: #000000">   12:</span>                     <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>symbol? p<span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>                         [`<span style="color: #FF0000">(</span>,p <span style="color: #FF0000">(</span>list-ref ,lst ,n<span style="color: #FF0000">))</span>]
<span style="color: #000000">   14:</span>                         [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>var <span style="color: #FF0000">(</span>gensym<span style="color: #FF0000">)))</span>
<span style="color: #000000">   15:</span>                            <span style="color: #FF0000">(</span>cons `<span style="color: #FF0000">(</span>,var <span style="color: #FF0000">(</span>list-ref ,lst ,n<span style="color: #FF0000">))</span>
<span style="color: #000000">   16:</span>                                  <span style="color: #FF0000">(</span>tree-of-accessors p
<span style="color: #000000">   17:</span>                                                     var
<span style="color: #000000">   18:</span>                                                     <span style="color: #993399">0</span><span style="color: #FF0000">))</span>}]<span style="color: #FF0000">)</span>}
<span style="color: #000000">   19:</span>                   <span style="color: #FF0000">(</span>tree-of-accessors <span style="color: #FF0000">(</span>cdr pat<span style="color: #FF0000">)</span>
<span style="color: #000000">   20:</span>                                      lst
<span style="color: #000000">   21:</span>                                      <span style="color: #FF0000">(</span>+ <span style="color: #993399">1</span> n<span style="color: #FF0000">))))</span>}}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>tree-of-accessors '<span style="color: #FF0000">()</span> 'gensym-for-list<span style="color: #FF0000">)</span>
<span style="color: #000000">    3:</span>          '<span style="color: #FF0000">())</span>
<span style="color: #000000">    4:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>tree-of-accessors 'a 'gensym-for-list<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          '<span style="color: #FF0000">((</span>a <span style="color: #FF0000">(</span>drop <span style="color: #993399">0</span> gensym-for-list<span style="color: #FF0000">))))</span>
<span style="color: #000000">    6:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>tree-of-accessors '<span style="color: #FF0000">(</span>#!rest d<span style="color: #FF0000">)</span> 'gensym-for-list<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>          '<span style="color: #FF0000">((</span>d <span style="color: #FF0000">(</span>drop <span style="color: #993399">0</span> gensym-for-list<span style="color: #FF0000">))))</span>
<span style="color: #000000">    8:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>tree-of-accessors '<span style="color: #FF0000">(</span>a<span style="color: #FF0000">)</span> 'gensym-for-list<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>          '<span style="color: #FF0000">((</span>a <span style="color: #FF0000">(</span>list-ref gensym-for-list <span style="color: #993399">0</span><span style="color: #FF0000">))))</span>
<span style="color: #000000">   10:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>tree-of-accessors '<span style="color: #FF0000">(</span>a . b<span style="color: #FF0000">)</span> 'gensym-for-list<span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>          '<span style="color: #FF0000">((</span>a <span style="color: #FF0000">(</span>list-ref gensym-for-list <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   12:</span>            <span style="color: #FF0000">(</span>b <span style="color: #FF0000">(</span>drop <span style="color: #993399">1</span> gensym-for-list<span style="color: #FF0000">))))</span>
<span style="color: #000000">   13:</span>  }</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>tree-of-accessors '<span style="color: #FF0000">(</span>a <span style="color: #FF0000">(</span>b c<span style="color: #FF0000">))</span>
<span style="color: #000000">    3:</span>                             'gensym-for-list
<span style="color: #000000">    4:</span>                             gensym: ['gensymed-var1]<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          '<span style="color: #FF0000">((</span>a <span style="color: #FF0000">(</span>list-ref gensym-for-list <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>            <span style="color: #FF0000">((</span>gensymed-var1 <span style="color: #FF0000">(</span>list-ref gensym-for-list <span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>             <span style="color: #FF0000">(</span>b <span style="color: #FF0000">(</span>list-ref gensymed-var1 <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>             <span style="color: #FF0000">(</span>c <span style="color: #FF0000">(</span>list-ref gensymed-var1 <span style="color: #993399">1</span><span style="color: #FF0000">)))))</span>
<span style="color: #000000">    9:</span>  }</tt></pre></div></div>
<div class="paragraph"><p>Although a call to "tree-of-accessors" by a macro could be a victim
of the multiple-evaluation
problem that macros may have, the only caller of "tree-of-accessors" is
"destructuring-bind", which passes
a "gensymed" symbol to "tree-of-accessors".  Therefore "destructuring-bind" does not
fall victim to unintended multiple evaluations <span class="footnote"><br>[Although the author would like to inline
"tree-of-accessors" into the definition of "destructuring-bind", thus making it safe,
he could not determine how to write tests for a nested definition.]<br></span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {define-macro destructuring-bind
<span style="color: #000000">    2:</span>   [|pat lst #!rest body|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>glst <span style="color: #FF0000">(</span>gensym<span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>      `{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>,glst ,lst<span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>         ,{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> create-nested-lets <span style="color: #FF0000">((</span>bindings
<span style="color: #000000">    6:</span>                                    <span style="color: #FF0000">(</span>tree-of-accessors pat
<span style="color: #000000">    7:</span>                                                       glst
<span style="color: #000000">    8:</span>                                                       gensym: gensym<span style="color: #FF0000">)))</span>
<span style="color: #000000">    9:</span>            <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? bindings<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>                [`{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span> ,@body}]
<span style="color: #000000">   11:</span>                [`{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ,<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|b| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>pair? <span style="color: #FF0000">(</span>car b<span style="color: #FF0000">))</span>
<span style="color: #000000">   12:</span>                                      [<span style="color: #FF0000">(</span>car b<span style="color: #FF0000">)</span>]
<span style="color: #000000">   13:</span>                                      [b]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   14:</span>                             bindings<span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>                    ,<span style="color: #FF0000">(</span>create-nested-lets <span style="color: #FF0000">(</span>flatmap [|b| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>pair? <span style="color: #FF0000">(</span>car b<span style="color: #FF0000">))</span>
<span style="color: #000000">   16:</span>                                                           [<span style="color: #FF0000">(</span>cdr b<span style="color: #FF0000">)</span>]
<span style="color: #000000">   17:</span>                                                           ['<span style="color: #FF0000">()</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   18:</span>                                                  bindings<span style="color: #FF0000">))</span>}]<span style="color: #FF0000">)</span>}}}]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#onlisp">[onlisp]</a>&gt;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? {macroexpand-1
<span style="color: #000000">    3:</span>           {destructuring-bind <span style="color: #FF0000">(</span>a <span style="color: #FF0000">(</span>b . c<span style="color: #FF0000">)</span> #!rest d<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>                               '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                               <span style="color: #FF0000">(</span>list a b c d<span style="color: #FF0000">)</span>}}
<span style="color: #000000">    6:</span>          '{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>gensymed-var1 '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    7:</span>             {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>a <span style="color: #FF0000">(</span>list-ref gensymed-var1 <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>                   <span style="color: #FF0000">(</span>gensymed-var2 <span style="color: #FF0000">(</span>list-ref gensymed-var1 <span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>                   <span style="color: #FF0000">(</span>d <span style="color: #FF0000">(</span>drop <span style="color: #993399">2</span> gensymed-var1<span style="color: #FF0000">)))</span>
<span style="color: #000000">   10:</span>               {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>b <span style="color: #FF0000">(</span>list-ref gensymed-var2 <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   11:</span>                     <span style="color: #FF0000">(</span>c <span style="color: #FF0000">(</span>drop <span style="color: #993399">1</span> gensymed-var2<span style="color: #FF0000">)))</span>
<span style="color: #000000">   12:</span>                 {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span> <span style="color: #FF0000">(</span>list a b c d<span style="color: #FF0000">)</span>}}}}<span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>  <span style="color: #FF0000">(</span>equal? {destructuring-bind <span style="color: #FF0000">(</span>a <span style="color: #FF0000">(</span>b . c<span style="color: #FF0000">)</span> #!rest d<span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>                              '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>                              <span style="color: #FF0000">(</span>list a b c d<span style="color: #FF0000">)</span>}
<span style="color: #000000">   16:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #FF0000">(</span><span style="color: #993399">3</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">   17:</span>  <span style="color: #FF0000">(</span>equal? {destructuring-bind <span style="color: #FF0000">(</span>trueList falseList<span style="color: #FF0000">)</span>
<span style="color: #000000">   18:</span>                              <span style="color: #FF0000">(</span>partition '<span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">4</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   19:</span>                                         [|x| <span style="color: #FF0000">(</span>&lt;= x <span style="color: #993399">3</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">   20:</span>                              trueList}
<span style="color: #000000">   21:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   22:</span>  <span style="color: #FF0000">(</span>equal? {destructuring-bind <span style="color: #FF0000">(</span>trueList falseList<span style="color: #FF0000">)</span>
<span style="color: #000000">   23:</span>                              <span style="color: #FF0000">(</span>partition '<span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #993399">2</span> <span style="color: #993399">5</span> <span style="color: #993399">4</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   24:</span>                                         [|x| <span style="color: #FF0000">(</span>&lt;= x <span style="color: #993399">3</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
<span style="color: #000000">   25:</span>                              falseList}
<span style="color: #000000">   26:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   27:</span>  }</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coroutines">6. Coroutines</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_make_generator">6.1. make-generator</h3>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> make-generator
<span style="color: #000000">    2:</span>   [|f|
<span style="color: #000000">    3:</span>    <span style="font-style: italic"><span style="color: #9A1900">;; will be defined to something useful before it is called,</span></span>
<span style="color: #000000">    4:</span>    <span style="font-style: italic"><span style="color: #9A1900">;; but for now, the environment needs a variable defined</span></span>
<span style="color: #000000">    5:</span>    {##<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> return-to-callee 'ignore}
<span style="color: #000000">    6:</span>    <span style="font-style: italic"><span style="color: #9A1900">;; do the work of the generator</span></span>
<span style="color: #000000">    7:</span>    {##<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> <span style="color: #FF0000">(</span>eval-until-yield send<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>      {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>value-passed-to-yield <span style="color: #FF0000">(</span>f [|value|
<span style="color: #000000">    9:</span>                                       <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">call/cc</span></span> [|stack-of-yield-exp|
<span style="color: #000000">   10:</span>                                                 {setf! eval-until-yield stack-of-yield-exp}
<span style="color: #000000">   11:</span>                                                 <span style="color: #FF0000">(</span>return-to-callee value<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">   12:</span>        <span style="color: #FF0000">(</span>return-to-callee value-passed-to-yield<span style="color: #FF0000">)</span>}}
<span style="color: #000000">   13:</span>    [|#!rest send|
<span style="color: #000000">   14:</span>     {<span style="font-weight: bold"><span style="color: #0000FF">call/cc</span></span> [|stack-of-callee|
<span style="color: #000000">   15:</span>               {setf! return-to-callee stack-of-callee}
<span style="color: #000000">   16:</span>               <span style="color: #FF0000">(</span>eval-until-yield <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? send<span style="color: #FF0000">)</span>
<span style="color: #000000">   17:</span>                                     ['ignore]
<span style="color: #000000">   18:</span>                                     [<span style="color: #FF0000">(</span>car send<span style="color: #FF0000">)</span>]<span style="color: #FF0000">))</span>]}]]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>test <span style="color: #FF0000">(</span>make-generator
<span style="color: #000000">    4:</span>                 [|yield|
<span style="color: #000000">    5:</span>                  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>time <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>                    {setf! time <span style="color: #FF0000">(</span>+ time <span style="color: #FF0000">(</span>yield 'event-one<span style="color: #FF0000">))</span>}
<span style="color: #000000">    7:</span>                    {setf! time <span style="color: #FF0000">(</span>+ time <span style="color: #FF0000">(</span>yield 'event-two<span style="color: #FF0000">))</span>}
<span style="color: #000000">    8:</span>                    {setf! time <span style="color: #FF0000">(</span>+ time <span style="color: #FF0000">(</span>yield 'event-three<span style="color: #FF0000">))</span>}
<span style="color: #000000">    9:</span>                    <span style="color: #FF0000">(</span>yield time<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>                    'end-of-generator}]<span style="color: #FF0000">)))</span>
<span style="color: #000000">   11:</span>      {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>equal? 'event-one <span style="color: #FF0000">(</span>test<span style="color: #FF0000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; just like python, nothing to send on first use</span></span>
<span style="color: #000000">   12:</span>           <span style="color: #FF0000">(</span>equal? 'event-two <span style="color: #FF0000">(</span>test <span style="color: #993399">10</span><span style="color: #FF0000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; send 10 to be the value of "(yield 'event-one)"</span></span>
<span style="color: #000000">   13:</span>           <span style="color: #FF0000">(</span>equal? 'event-three <span style="color: #FF0000">(</span>test <span style="color: #993399">10</span><span style="color: #FF0000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; send 10 to be the value of "(yield 'event-two)"</span></span>
<span style="color: #000000">   14:</span>           <span style="color: #FF0000">(</span>equal? <span style="color: #993399">30</span> <span style="color: #FF0000">(</span>test <span style="color: #993399">10</span><span style="color: #FF0000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; send 10 to be the value of "(yield 'event-three)"</span></span>
<span style="color: #000000">   15:</span>           <span style="color: #FF0000">(</span>equal? 'end-of-generator <span style="color: #FF0000">(</span>test <span style="color: #993399">10</span><span style="color: #FF0000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; end of the generator</span></span>
<span style="color: #000000">   16:</span>           }}}}
<span style="color: #000000">   17:</span> </tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_generator">6.2. generator</h3>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {define-macro generator
<span style="color: #000000">    2:</span>   [|body|
<span style="color: #000000">    3:</span>    `<span style="color: #FF0000">(</span>make-generator
<span style="color: #000000">    4:</span>      [|yield|
<span style="color: #000000">    5:</span>       {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    6:</span>         ,body
<span style="color: #000000">    7:</span>         'end-of-generator}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>test <span style="color: #FF0000">(</span>generator
<span style="color: #000000">    4:</span>                  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>time <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>                    {setf! time <span style="color: #FF0000">(</span>+ time <span style="color: #FF0000">(</span>yield 'event-one<span style="color: #FF0000">))</span>}
<span style="color: #000000">    6:</span>                    {setf! time <span style="color: #FF0000">(</span>+ time <span style="color: #FF0000">(</span>yield 'event-two<span style="color: #FF0000">))</span>}
<span style="color: #000000">    7:</span>                    {setf! time <span style="color: #FF0000">(</span>+ time <span style="color: #FF0000">(</span>yield 'event-three<span style="color: #FF0000">))</span>}
<span style="color: #000000">    8:</span>                    <span style="color: #FF0000">(</span>yield time<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>      {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>equal? 'event-one <span style="color: #FF0000">(</span>test<span style="color: #FF0000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; just like python, nothing to send on first use</span></span>
<span style="color: #000000">   10:</span>           <span style="color: #FF0000">(</span>equal? 'event-two <span style="color: #FF0000">(</span>test <span style="color: #993399">10</span><span style="color: #FF0000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; send 10 to be the value of "(yield 'event-one)"</span></span>
<span style="color: #000000">   11:</span>           <span style="color: #FF0000">(</span>equal? 'event-three <span style="color: #FF0000">(</span>test <span style="color: #993399">10</span><span style="color: #FF0000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; send 10 to be the value of "(yield 'event-two)"</span></span>
<span style="color: #000000">   12:</span>           <span style="color: #FF0000">(</span>equal? <span style="color: #993399">30</span> <span style="color: #FF0000">(</span>test <span style="color: #993399">10</span><span style="color: #FF0000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; send 10 to be the value of "(yield 'event-three)"</span></span>
<span style="color: #000000">   13:</span>           <span style="color: #FF0000">(</span>equal? 'end-of-generator <span style="color: #FF0000">(</span>test <span style="color: #993399">10</span><span style="color: #FF0000">))</span> <span style="font-style: italic"><span style="color: #9A1900">;; end of the generator</span></span>
<span style="color: #000000">   14:</span>           }}}}</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_streams">7. Streams</h2>
<div class="sectionbody">
<div class="paragraph"><p>Streams are sequential collections like lists, but the
"cdr" of each pair must be a zero-argument lambda expression.  This lambda
expression will be automatically applied when "(stream-cdr s)" is evaluated.
This technique allows a programmer to create seemingly infinite data structures,
such as the definition of "integers-from" and "primes".
For more information, consult &lt;<a href="#sicp">[sicp]</a>&gt; <span class="footnote"><br>[although, they
define "stream-cons" as syntax instead of passing a lambda
to the second argument]<br></span>.</p></div>
<div class="sect2">
<h3 id="_stream_structure">7.1. Stream structure</h3>
<div class="paragraph"><p>"libbug-private#define-structure" <span class="footnote"><br>[defined in section <a href="#definestructure">[definestructure]</a>]<br></span>
takes the name of the datatype and a variable
number of fields as parameters.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {define-structure stream
<span style="color: #000000">    2:</span>   a
<span style="color: #000000">    3:</span>   d}</tt></pre></div></div>
<div class="paragraph"><p>"libbug-private#define-structure" will create a constructor procedure named "make-stream",
accessor procedures "stream-a", "stream-d", and updating procedures "stream-a-set!" and
"stream-d-set!".
For streams, none of these generated procedures are intended to be
used directly by the programmer. Instead, "stream-cons", "stream-car",
and "stream-cdr"
are to be used.</p></div>
</div>
<div class="sect2">
<h3 id="_stream_cons">7.2. stream-cons</h3>
<div class="paragraph"><p>Like "cons", creates a pair.  The second argument must be a zero-argument
lambda value.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {define-macro stream-cons
<span style="color: #000000">    2:</span>   [|a d|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>list? d<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>             <span style="color: #FF0000">(</span>equal? '<span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> <span style="color: #FF0000">(</span>car d<span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>             <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>null? <span style="color: #FF0000">(</span>cdr d<span style="color: #FF0000">)))</span>
<span style="color: #000000">    6:</span>             <span style="color: #FF0000">(</span>equal? '<span style="color: #FF0000">()</span> <span style="color: #FF0000">(</span>cadr d<span style="color: #FF0000">))</span>}
<span style="color: #000000">    7:</span>        [`<span style="color: #FF0000">(</span>make-stream ,a {<span style="font-weight: bold"><span style="color: #0000FF">delay</span></span> ,<span style="color: #FF0000">(</span>caddr d<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>]
<span style="color: #000000">    8:</span>        [<span style="color: #FF0000">(</span>error <span style="color: #FF0000">"bug#stream-cons requires a zero-argument \</span>
<span style="color: #000000">    9:</span> <span style="color: #FF0000">                lambda as its second argument."</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#sicp">[sicp]</a>&gt;.</p></div>
</div>
<div class="sect2">
<h3 id="_stream_car">7.3. stream-car</h3>
<div class="paragraph"><p>Get the first element of the stream.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-car
<span style="color: #000000">    2:</span>   stream-a}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#sicp">[sicp]</a>&gt;.</p></div>
</div>
<div class="sect2">
<h3 id="_stream_cdr">7.4. stream-cdr</h3>
<div class="paragraph"><p>Forces the evaluation of the next element of the stream.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-cdr
<span style="color: #000000">    2:</span>   [|s|
<span style="color: #000000">    3:</span>    {force <span style="color: #FF0000">(</span>stream-d s<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#sicp">[sicp]</a>&gt;.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>s <span style="color: #FF0000">(</span>stream-cons <span style="color: #993399">1</span> [<span style="color: #993399">2</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span>
<span style="color: #000000">    4:</span>     <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-car s<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>             <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>             <span style="color: #993399">2</span><span style="color: #FF0000">)</span>}}
<span style="color: #000000">    8:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_null">7.5. stream-null</h3>
<div class="paragraph"><p>The sentinel value for streams is the same value as the sentinel value
for lists.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-null
<span style="color: #000000">    2:</span>   '<span style="color: #FF0000">()</span>
<span style="color: #000000">    3:</span>   }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_null_2">7.6. stream-null?</h3>
<div class="paragraph"><p>But to test for the sentinel value, use "stream-null?".</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-null?
<span style="color: #000000">    2:</span>   null?}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>stream-null?
<span style="color: #000000">    3:</span>   <span style="color: #FF0000">(</span>stream-cdr
<span style="color: #000000">    4:</span>    <span style="color: #FF0000">(</span>stream-cdr <span style="color: #FF0000">(</span>stream-cons <span style="color: #993399">1</span> [<span style="color: #FF0000">(</span>stream-cons <span style="color: #993399">2</span>
<span style="color: #000000">    5:</span>                                             [stream-null]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">))))</span>
<span style="color: #000000">    6:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_list_8594_stream">7.7. list&#8594;stream</h3>
<div class="paragraph"><p>Converts a list into a stream.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> list-&gt;stream
<span style="color: #000000">    2:</span>   [|l|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>null? l<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [stream-null]
<span style="color: #000000">    5:</span>        [<span style="color: #FF0000">(</span>stream-cons <span style="color: #FF0000">(</span>car l<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                      [<span style="color: #FF0000">(</span>list-&gt;stream <span style="color: #FF0000">(</span>cdr l<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>foo <span style="color: #FF0000">(</span>list-&gt;stream '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">))))</span>
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #993399">1</span> <span style="color: #FF0000">(</span>stream-car foo<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>         <span style="color: #FF0000">(</span>equal? <span style="color: #993399">2</span> <span style="color: #FF0000">((</span>compose stream-car
<span style="color: #000000">    5:</span>                             stream-cdr<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                    foo<span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>         <span style="color: #FF0000">(</span>equal? <span style="color: #993399">3</span> <span style="color: #FF0000">((</span>compose stream-car
<span style="color: #000000">    8:</span>                             stream-cdr
<span style="color: #000000">    9:</span>                             stream-cdr<span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>                    foo<span style="color: #FF0000">))</span>
<span style="color: #000000">   11:</span>         <span style="color: #FF0000">(</span>stream-null? <span style="color: #FF0000">((</span>compose stream-cdr
<span style="color: #000000">   12:</span>                                 stream-cdr
<span style="color: #000000">   13:</span>                                 stream-cdr<span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>                        foo<span style="color: #FF0000">))</span>}}}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_8594_list">7.8. stream&#8594;list</h3>
<div class="paragraph"><p>Converts a stream into a list.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-&gt;list
<span style="color: #000000">    2:</span>   [|s|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>stream-null? s<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        ['<span style="color: #FF0000">()</span>]
<span style="color: #000000">    5:</span>        [<span style="color: #FF0000">(</span>cons <span style="color: #FF0000">(</span>stream-car s<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>               <span style="color: #FF0000">(</span>stream-&gt;list <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    3:</span>           <span style="color: #FF0000">(</span>list-&gt;stream '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_ref">7.9. stream-ref</h3>
<div class="paragraph"><p>The analogous procedure of "list-ref".</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-ref
<span style="color: #000000">    2:</span>   [|s n #!key <span style="color: #FF0000">(</span>onOutOfBounds noop<span style="color: #FF0000">)</span>|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>&lt; n <span style="color: #993399">0</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>        [<span style="color: #FF0000">(</span>onOutOfBounds<span style="color: #FF0000">)</span>]
<span style="color: #000000">    5:</span>        [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> stream-ref <span style="color: #FF0000">((</span>s s<span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span>n n<span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>           <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>equal? n <span style="color: #993399">0</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>               [<span style="color: #FF0000">(</span>stream-car s<span style="color: #FF0000">)</span>]
<span style="color: #000000">    8:</span>               [<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>stream-null? <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>                    [<span style="color: #FF0000">(</span>onOutOfBounds<span style="color: #FF0000">)</span>]
<span style="color: #000000">   10:</span>                    [<span style="color: #FF0000">(</span>stream-ref <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>                                 <span style="color: #FF0000">(</span>- n <span style="color: #993399">1</span><span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#sicp">[sicp]</a>&gt;.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|i| <span style="color: #FF0000">(</span>stream-ref <span style="color: #FF0000">(</span>list-&gt;stream '<span style="color: #FF0000">(</span>a b c d e<span style="color: #FF0000">))</span> i<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span>-1 noop<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> a<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">4</span> e<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">5</span> noop<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">)</span>
<span style="color: #000000">   10:</span>   <span style="color: #FF0000">)</span>
<span style="color: #000000">   11:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">   12:</span>   [|i| <span style="color: #FF0000">(</span>stream-ref <span style="color: #FF0000">(</span>list-&gt;stream '<span style="color: #FF0000">(</span>a b c d e<span style="color: #FF0000">))</span>
<span style="color: #000000">   13:</span>                    i
<span style="color: #000000">   14:</span>                    onOutOfBounds: ['out]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   15:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   16:</span>     <span style="color: #FF0000">(</span>-1 out<span style="color: #FF0000">)</span>
<span style="color: #000000">   17:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> a<span style="color: #FF0000">)</span>
<span style="color: #000000">   18:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">4</span> e<span style="color: #FF0000">)</span>
<span style="color: #000000">   19:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">5</span> out<span style="color: #FF0000">)</span>
<span style="color: #000000">   20:</span>     <span style="color: #FF0000">)</span>
<span style="color: #000000">   21:</span>   <span style="color: #FF0000">)</span>
<span style="color: #000000">   22:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_integers_from">7.10. integers-from</h3>
<div class="paragraph"><p></p></div>
<div class="paragraph"><p>Creates an infinite <span class="footnote"><br>[bounded by memory constraints of course. Scheme
isn&#8217;t a Turing machine.]<br></span> stream of integers.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> integers-from
<span style="color: #000000">    2:</span>   [|n|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span>stream-cons n [<span style="color: #FF0000">(</span>integers-from <span style="color: #FF0000">(</span>+ n <span style="color: #993399">1</span><span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#sicp">[sicp]</a>&gt;.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|n| <span style="color: #FF0000">(</span>stream-ref <span style="color: #FF0000">(</span>integers-from <span style="color: #993399">0</span><span style="color: #FF0000">)</span> n<span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #993399">0</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">   10:</span>   [|n| <span style="color: #FF0000">(</span>stream-ref <span style="color: #FF0000">(</span>integers-from <span style="color: #993399">5</span><span style="color: #FF0000">)</span> n<span style="color: #FF0000">)</span>]
<span style="color: #000000">   11:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">   12:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">6</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">7</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   15:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   16:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_take">7.11. stream-take</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-take
<span style="color: #000000">    2:</span>   [|n s|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #FF0000">(</span>stream-null? s<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>            <span style="color: #FF0000">(</span>&lt;= n <span style="color: #993399">0</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">    5:</span>        [stream-null]
<span style="color: #000000">    6:</span>        [<span style="color: #FF0000">(</span>stream-cons <span style="color: #FF0000">(</span>stream-car s<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>                      [<span style="color: #FF0000">(</span>stream-take <span style="color: #FF0000">(</span>- n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                                    <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|n| <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    4:</span>         <span style="color: #FF0000">(</span>stream-take n <span style="color: #FF0000">(</span>integers-from <span style="color: #993399">0</span><span style="color: #FF0000">)))</span>]
<span style="color: #000000">    5:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #FF0000">(</span><span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #993399">1</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">6</span> <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_filter">7.12. stream-filter</h3>
<div class="paragraph"><p>The analogous procedure of filter.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-filter
<span style="color: #000000">    2:</span>   [|p? s|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> stream-filter <span style="color: #FF0000">((</span>s s<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>stream-null? s<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          [stream-null]
<span style="color: #000000">    6:</span>          [{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>first <span style="color: #FF0000">(</span>stream-car s<span style="color: #FF0000">)))</span>
<span style="color: #000000">    7:</span>             <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>p? first<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                 [<span style="color: #FF0000">(</span>stream-cons first
<span style="color: #000000">    9:</span>                               [<span style="color: #FF0000">(</span>stream-filter <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]
<span style="color: #000000">   10:</span>                 [<span style="color: #FF0000">(</span>stream-filter <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>}]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal?  <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    3:</span>            <span style="color: #FF0000">(</span>stream-filter [|x| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>= <span style="color: #993399">4</span> x<span style="color: #FF0000">))</span>]
<span style="color: #000000">    4:</span>                           <span style="color: #FF0000">(</span>list-&gt;stream '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">4</span> <span style="color: #993399">2</span> <span style="color: #993399">4</span><span style="color: #FF0000">))))</span>
<span style="color: #000000">    5:</span>           '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>  }</tt></pre></div></div>
<div class="paragraph"><p>Understanding the following tests is crucial to understanding
the definition of "primes".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    3:</span>           <span style="color: #FF0000">(</span>stream-take
<span style="color: #000000">    4:</span>            <span style="color: #993399">10</span>
<span style="color: #000000">    5:</span>            <span style="color: #FF0000">(</span>stream-cons
<span style="color: #000000">    6:</span>             <span style="color: #993399">2</span>
<span style="color: #000000">    7:</span>             [<span style="color: #FF0000">(</span>stream-filter [|n|
<span style="color: #000000">    8:</span>                              <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #993399">0</span>
<span style="color: #000000">    9:</span>                                           <span style="color: #FF0000">(</span>modulo n <span style="color: #993399">2</span><span style="color: #FF0000">)))</span>]
<span style="color: #000000">   10:</span>                             <span style="color: #FF0000">(</span>integers-from <span style="color: #993399">2</span><span style="color: #FF0000">))</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">   11:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span> <span style="color: #993399">9</span> <span style="color: #993399">11</span> <span style="color: #993399">13</span> <span style="color: #993399">15</span> <span style="color: #993399">17</span> <span style="color: #993399">19</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   12:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">   13:</span>           <span style="color: #FF0000">(</span>stream-take
<span style="color: #000000">   14:</span>            <span style="color: #993399">10</span>
<span style="color: #000000">   15:</span>            <span style="color: #FF0000">(</span>stream-cons
<span style="color: #000000">   16:</span>             <span style="color: #993399">2</span>
<span style="color: #000000">   17:</span>             [<span style="color: #FF0000">(</span>stream-filter [|n|
<span style="color: #000000">   18:</span>                              <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #993399">0</span>
<span style="color: #000000">   19:</span>                                           <span style="color: #FF0000">(</span>modulo n <span style="color: #993399">2</span><span style="color: #FF0000">)))</span>]
<span style="color: #000000">   20:</span>                             <span style="color: #FF0000">(</span>stream-cons
<span style="color: #000000">   21:</span>                              <span style="color: #993399">3</span>
<span style="color: #000000">   22:</span>                              [<span style="color: #FF0000">(</span>stream-filter [|n|
<span style="color: #000000">   23:</span>                                               <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #993399">0</span>
<span style="color: #000000">   24:</span>                                                            <span style="color: #FF0000">(</span>modulo n <span style="color: #993399">3</span><span style="color: #FF0000">)))</span>]
<span style="color: #000000">   25:</span>                                              <span style="color: #FF0000">(</span>integers-from <span style="color: #993399">2</span><span style="color: #FF0000">))</span>]<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">   26:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span> <span style="color: #993399">11</span> <span style="color: #993399">13</span> <span style="color: #993399">17</span> <span style="color: #993399">19</span> <span style="color: #993399">23</span> <span style="color: #993399">25</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   27:</span>  }
<span style="color: #000000">   28:</span> </tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    3:</span>           <span style="color: #FF0000">(</span>stream-take
<span style="color: #000000">    4:</span>            <span style="color: #993399">10</span>
<span style="color: #000000">    5:</span>            <span style="color: #FF0000">(</span>stream-cons
<span style="color: #000000">    6:</span>             <span style="color: #993399">2</span>
<span style="color: #000000">    7:</span>             [<span style="color: #FF0000">(</span>stream-filter
<span style="color: #000000">    8:</span>               [|n|
<span style="color: #000000">    9:</span>                <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #993399">0</span>
<span style="color: #000000">   10:</span>                             <span style="color: #FF0000">(</span>modulo n <span style="color: #993399">2</span><span style="color: #FF0000">)))</span>]
<span style="color: #000000">   11:</span>               <span style="color: #FF0000">(</span>stream-cons
<span style="color: #000000">   12:</span>                <span style="color: #993399">3</span>
<span style="color: #000000">   13:</span>                [<span style="color: #FF0000">(</span>stream-filter
<span style="color: #000000">   14:</span>                  [|n|
<span style="color: #000000">   15:</span>                   <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #993399">0</span>
<span style="color: #000000">   16:</span>                                <span style="color: #FF0000">(</span>modulo n <span style="color: #993399">3</span><span style="color: #FF0000">)))</span>]
<span style="color: #000000">   17:</span>                  <span style="color: #FF0000">(</span>stream-cons
<span style="color: #000000">   18:</span>                   <span style="color: #993399">5</span>
<span style="color: #000000">   19:</span>                   [<span style="color: #FF0000">(</span>stream-filter
<span style="color: #000000">   20:</span>                     [|n|
<span style="color: #000000">   21:</span>                      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #993399">0</span>
<span style="color: #000000">   22:</span>                                   <span style="color: #FF0000">(</span>modulo n <span style="color: #993399">5</span><span style="color: #FF0000">)))</span>]
<span style="color: #000000">   23:</span>                     <span style="color: #FF0000">(</span>integers-from <span style="color: #993399">2</span><span style="color: #FF0000">))</span>]<span style="color: #FF0000">))</span>]<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)))</span>
<span style="color: #000000">   24:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span> <span style="color: #993399">11</span> <span style="color: #993399">13</span> <span style="color: #993399">17</span> <span style="color: #993399">19</span> <span style="color: #993399">23</span> <span style="color: #993399">29</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   25:</span>  }
<span style="color: #000000">   26:</span> </tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_primes">7.13. primes</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> primes
<span style="color: #000000">    2:</span>   {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> sieve-of-eratosthenes <span style="color: #FF0000">((</span>s <span style="color: #FF0000">(</span>integers-from <span style="color: #993399">2</span><span style="color: #FF0000">)))</span>
<span style="color: #000000">    3:</span>     <span style="color: #FF0000">(</span>stream-cons
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span>stream-car s<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>      [<span style="color: #FF0000">(</span>sieve-of-eratosthenes <span style="color: #FF0000">(</span>stream-filter
<span style="color: #000000">    6:</span>                               [|n|
<span style="color: #000000">    7:</span>                                <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? <span style="color: #993399">0</span>
<span style="color: #000000">    8:</span>                                             <span style="color: #FF0000">(</span>modulo n <span style="color: #FF0000">(</span>stream-car s<span style="color: #FF0000">))))</span>]
<span style="color: #000000">    9:</span>                               <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>}}</tt></pre></div></div>
<div class="paragraph"><p>&lt;<a href="#sicp">[sicp]</a>&gt;.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    3:</span>           <span style="color: #FF0000">(</span>stream-take
<span style="color: #000000">    4:</span>            <span style="color: #993399">10</span>
<span style="color: #000000">    5:</span>            primes<span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span> <span style="color: #993399">11</span> <span style="color: #993399">13</span> <span style="color: #993399">17</span> <span style="color: #993399">19</span> <span style="color: #993399">23</span> <span style="color: #993399">29</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_drop">7.14. stream-drop</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-drop
<span style="color: #000000">    2:</span>   [|n s|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #FF0000">(</span>stream-null? s<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>            <span style="color: #FF0000">(</span>&lt;= n <span style="color: #993399">0</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">    5:</span>        [s]
<span style="color: #000000">    6:</span>        [<span style="color: #FF0000">(</span>stream-drop <span style="color: #FF0000">(</span>- n <span style="color: #993399">1</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>                      <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|n|
<span style="color: #000000">    4:</span>    <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span>stream-drop n <span style="color: #FF0000">(</span>list-&gt;stream '<span style="color: #FF0000">(</span>a b<span style="color: #FF0000">))))</span>]
<span style="color: #000000">    6:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span>-1 <span style="color: #FF0000">(</span>a b<span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #FF0000">(</span>a b<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #FF0000">(</span>b<span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">   11:</span>     <span style="color: #FF0000">(</span><span style="color: #993399">3</span> <span style="color: #FF0000">())</span>
<span style="color: #000000">   12:</span>     <span style="color: #FF0000">))</span>
<span style="color: #000000">   13:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">   14:</span>           <span style="color: #FF0000">(</span>stream-take <span style="color: #993399">10</span> <span style="color: #FF0000">(</span>stream-drop <span style="color: #993399">10</span>
<span style="color: #000000">   15:</span>                                        primes<span style="color: #FF0000">)))</span>
<span style="color: #000000">   16:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">31</span> <span style="color: #993399">37</span> <span style="color: #993399">41</span> <span style="color: #993399">43</span> <span style="color: #993399">47</span> <span style="color: #993399">53</span> <span style="color: #993399">59</span> <span style="color: #993399">61</span> <span style="color: #993399">67</span> <span style="color: #993399">71</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   17:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_drop_while">7.15. stream-drop-while</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-drop-while
<span style="color: #000000">    2:</span>   [|p? s|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>not-p? <span style="color: #FF0000">(</span>complement p?<span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>      {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> stream-drop-while <span style="color: #FF0000">((</span>s s<span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>        <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #FF0000">(</span>stream-null? s<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                <span style="color: #FF0000">(</span>not-p? <span style="color: #FF0000">(</span>stream-car s<span style="color: #FF0000">))</span>}
<span style="color: #000000">    7:</span>            [s]
<span style="color: #000000">    8:</span>            [<span style="color: #FF0000">(</span>stream-drop-while <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>}}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|x|
<span style="color: #000000">    4:</span>    <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span>stream-drop-while [|y| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>equal? x y<span style="color: #FF0000">))</span>]
<span style="color: #000000">    6:</span>                        <span style="color: #FF0000">(</span>list-&gt;stream
<span style="color: #000000">    7:</span>                         '<span style="color: #FF0000">(</span>a b c<span style="color: #FF0000">))))</span>]
<span style="color: #000000">    8:</span>   '<span style="color: #FF0000">(</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">(</span>a <span style="color: #FF0000">(</span>a b c<span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>     <span style="color: #FF0000">(</span>b <span style="color: #FF0000">(</span>b c<span style="color: #FF0000">))</span>
<span style="color: #000000">   11:</span>     <span style="color: #FF0000">(</span>c <span style="color: #FF0000">(</span>c<span style="color: #FF0000">))</span>
<span style="color: #000000">   12:</span>     <span style="color: #FF0000">(</span>d <span style="color: #FF0000">())</span>
<span style="color: #000000">   13:</span>     <span style="color: #FF0000">(</span>e <span style="color: #FF0000">())</span>
<span style="color: #000000">   14:</span>     <span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_map">7.16. stream-map</h3>
<div class="paragraph"><p>The analogous procedure of "map".</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-map
<span style="color: #000000">    2:</span>   [|f #!rest list-of-streams|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> stream-map <span style="color: #FF0000">((</span>list-of-streams list-of-streams<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>any? <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> stream-null? list-of-streams<span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>          [stream-null]
<span style="color: #000000">    6:</span>          [<span style="color: #FF0000">(</span>stream-cons
<span style="color: #000000">    7:</span>            <span style="color: #FF0000">(</span>apply f
<span style="color: #000000">    8:</span>                   <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> stream-car list-of-streams<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>            [<span style="color: #FF0000">(</span>stream-map <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> stream-cdr list-of-streams<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    3:</span>           <span style="color: #FF0000">(</span>stream-map [|x| <span style="color: #FF0000">(</span>+ x <span style="color: #993399">1</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">    4:</span>                       <span style="color: #FF0000">(</span>list-&gt;stream '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">))))</span>
<span style="color: #000000">    5:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    7:</span>           <span style="color: #FF0000">(</span>stream-map [|x y| <span style="color: #FF0000">(</span>+ x y<span style="color: #FF0000">)</span>]
<span style="color: #000000">    8:</span>                       <span style="color: #FF0000">(</span>list-&gt;stream '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>                       <span style="color: #FF0000">(</span>list-&gt;stream '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span> <span style="color: #993399">1</span><span style="color: #FF0000">))))</span>
<span style="color: #000000">   10:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   11:</span>  }
<span style="color: #000000">   12:</span> </tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_enumerate_interval">7.17. stream-enumerate-interval</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-enumerate-interval
<span style="color: #000000">    2:</span>   [|low high #!key <span style="color: #FF0000">(</span>step <span style="color: #993399">1</span><span style="color: #FF0000">)</span>|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> stream-enumerate-interval <span style="color: #FF0000">((</span>low low<span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>&gt; low high<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>          [stream-null]
<span style="color: #000000">    6:</span>          [<span style="color: #FF0000">(</span>stream-cons low
<span style="color: #000000">    7:</span>                        [<span style="color: #FF0000">(</span>stream-enumerate-interval <span style="color: #FF0000">(</span>+ low step<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    3:</span>           <span style="color: #FF0000">(</span>stream-enumerate-interval <span style="color: #993399">1</span> <span style="color: #993399">10</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span> <span style="color: #993399">7</span> <span style="color: #993399">8</span> <span style="color: #993399">9</span> <span style="color: #993399">10</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>  <span style="color: #FF0000">(</span>equal? <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    6:</span>           <span style="color: #FF0000">(</span>stream-enumerate-interval <span style="color: #993399">1</span> <span style="color: #993399">10</span> step: <span style="color: #993399">2</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    7:</span>          '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">3</span> <span style="color: #993399">5</span> <span style="color: #993399">7</span> <span style="color: #993399">9</span><span style="color: #FF0000">))</span>}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_stream_take_while">7.18. stream-take-while</h3>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> stream-take-while
<span style="color: #000000">    2:</span>   [|p? s|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>not-p? <span style="color: #FF0000">(</span>complement p?<span style="color: #FF0000">)))</span>
<span style="color: #000000">    4:</span>      {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> stream-take-while <span style="color: #FF0000">((</span>s s<span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>        <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #FF0000">(</span>stream-null? s<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>                <span style="color: #FF0000">(</span>not-p? <span style="color: #FF0000">(</span>stream-car s<span style="color: #FF0000">))</span>}
<span style="color: #000000">    7:</span>            [stream-null]
<span style="color: #000000">    8:</span>            [<span style="color: #FF0000">(</span>stream-cons <span style="color: #FF0000">(</span>stream-car s<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>                          [<span style="color: #FF0000">(</span>stream-take-while
<span style="color: #000000">   10:</span>                            <span style="color: #FF0000">(</span>stream-cdr s<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>}}]}</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {unit-test
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>satisfies?
<span style="color: #000000">    3:</span>   [|s|
<span style="color: #000000">    4:</span>    <span style="color: #FF0000">(</span>stream-&gt;list
<span style="color: #000000">    5:</span>     <span style="color: #FF0000">(</span>stream-take-while [|n| <span style="color: #FF0000">(</span>&lt; n <span style="color: #993399">10</span><span style="color: #FF0000">)</span>]
<span style="color: #000000">    6:</span>                        s<span style="color: #FF0000">))</span>]
<span style="color: #000000">    7:</span>   `<span style="color: #FF0000">((</span>,<span style="color: #FF0000">(</span>integers-from <span style="color: #993399">0</span><span style="color: #FF0000">)</span>               <span style="color: #FF0000">(</span><span style="color: #993399">0</span> <span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span> <span style="color: #993399">5</span> <span style="color: #993399">6</span> <span style="color: #993399">7</span> <span style="color: #993399">8</span> <span style="color: #993399">9</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span>,<span style="color: #FF0000">(</span>stream-enumerate-interval <span style="color: #993399">1</span> <span style="color: #993399">4</span><span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span> <span style="color: #993399">3</span> <span style="color: #993399">4</span><span style="color: #FF0000">))))</span>
<span style="color: #000000">    9:</span>  }</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_the_end_of_compilation">7.19. The End of Compilation</h3>
<div class="paragraph"><p>At the beginning of the book, in chapter <a href="#beginninglibbug">[beginninglibbug]</a>, "bug-language.scm"
was imported, so that "libbug-private#define", and "libbug-private#define-macro" could be used.
This chapter is the end of the file "main.bug.scm".  However, as will be shown
in the next chapter, "bug-languge.scm" opened files for writing during compile-time,
and they must be closed, accomplished by executing "at-end-of-compilation".</p></div>
<div class="paragraph"><p>;;[[call-end-of-compilation</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {at-compile-time
<span style="color: #000000">    2:</span>  <span style="color: #FF0000">(</span>at-end-of-compilation<span style="color: #FF0000">)</span>}</tt></pre></div></div>
</div>
</div>
</div>
<h1 id="_foundations_of_libbug">Foundations Of Libbug</h1>
<div class="sect1">
<h2 id="_computation_at_compile_time">1. Computation At Compile-Time</h2>
<div class="sectionbody">
<div class="paragraph" id="buglang"><p>This chapter<span class="footnote"><br>[The contents of which is found in
"src/bug-language.bug.scm''.]<br></span>, which was evaluated before the previous chapters, provides
the foundation for computation at compile-time.  Although
the most prevalent code in the previous chapters which executed at compile-time
was for testing, many other computations occurred during compile-time
transparently to the reader.  These other computations produced output
files for namespace mappings and for macro definitions, to be used by other
programs which link against libbug.</p></div>
<div class="sect2">
<h3 id="_at_compile_time">1.1. at-compile-time</h3>
<div class="paragraph"><p>"at-compile-time" is a macro which "eval"s the form during macro-expansion,
but evaluates to the symbol "noop", thus not affecting
run-time &lt;<a href="#evalduringmacroexpansion">[evalduringmacroexpansion]</a>&gt;.
"Eval"ing during macro-expansion is how the compiler may be augmented with new procedures,
thus treating the compiler as an interpreter.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {##namespace <span style="color: #FF0000">(</span><span style="color: #FF0000">"bug#"</span> at-compile-time<span style="color: #FF0000">)</span>}
<span style="color: #000000">    2:</span> {##define-macro at-compile-time
<span style="color: #000000">    3:</span>   [|#!rest forms|
<span style="color: #000000">    4:</span>    <span style="color: #FF0000">(</span>eval `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    5:</span>             ,@forms}<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>    '{quote noop}]}</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On lines 4-5, the unevaluated code which is passed to
"at-compile-time" is evaluated during macro-expansion, thus
at compile-time.  The macro-expansion expands into "{quote noop}", so the
form will not evaluate at run-time.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_at_both_times">1.2. at-both-times</h3>
<div class="paragraph"><p></p></div>
<div class="paragraph"><p>"at-both-times", like "at-compile-time", "eval"s the forms
in the compile-time environment, but also in the run-time environment.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {##namespace <span style="color: #FF0000">(</span><span style="color: #FF0000">"bug#"</span> at-both-times<span style="color: #FF0000">)</span>}
<span style="color: #000000">    2:</span> {##define-macro at-both-times
<span style="color: #000000">    3:</span>   [|#!rest forms|
<span style="color: #000000">    4:</span>    <span style="color: #FF0000">(</span>eval `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    5:</span>             ,@forms}<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>    `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    7:</span>       ,@forms}]}</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On lines 4-5, evaluation in the compile-time environment
</p>
</li>
<li>
<p>
On lines 6-7, evaluation in the run-time environment.  The forms
are returned unaltered to Gambit&#8217;s compiler, thus ensuring that
they are defined in the run-time environment.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_at_compile_time_expand">1.3. at-compile-time-expand</h3>
<div class="paragraph"><p></p></div>
<div class="paragraph"><p>"at-compile-time-expand" allows any procedure to act as a macro.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {##namespace <span style="color: #FF0000">(</span><span style="color: #FF0000">"bug#"</span> at-compile-time-expand<span style="color: #FF0000">)</span>}
<span style="color: #000000">    2:</span> {##define-macro at-compile-time-expand
<span style="color: #000000">    3:</span>   [|#!rest forms|
<span style="color: #000000">    4:</span>    <span style="color: #FF0000">(</span>eval `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    5:</span>             ,@forms}<span style="color: #FF0000">)</span>]}</tt></pre></div></div>
<div class="paragraph"><p>This allows the programmer to create "anonymous" macros.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>&gt; <span style="color: #FF0000">(</span>{at-compile-time-expand
    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #009900">#t</span>
        ['car]
        ['cdr]<span style="color: #FF0000">)</span>}
  '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">))</span>
<span style="color: #993399">1</span>
&gt; <span style="color: #FF0000">(</span>{at-compile-time-expand
    <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #009900">#f</span>
        ['car]
        ['cdr]<span style="color: #FF0000">))</span>
  '<span style="color: #FF0000">(</span><span style="color: #993399">1</span> <span style="color: #993399">2</span><span style="color: #FF0000">)</span>}
<span style="color: #FF0000">(</span><span style="color: #993399">2</span><span style="color: #FF0000">)</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_create_files_for_linking_against_libbug">1.4. Create Files for Linking Against Libbug</h3>
<div class="paragraph"><p>Libbug is a collection of procedures and macros.  Building libbug results
in a dynamic library and a "loadable" library (a .o1 file, for loading
in the Gambit interpreter).
But programs which link against libug will require libbug&#8217;s
macro definitions and namespace declarations, both of which are not
compiled into the library.  Rather than manually copying all of them to
external files, why not generate them during compile-time?</p></div>
<div class="paragraph"><p>At compile time, open one file for the namespaces ("libbug#.scm") and one for the macros
("libbug-macros.scm").  These files will be pure Gambit scheme code, no
libbug syntax enhancements.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {at-compile-time</tt></pre></div></div>
<div class="paragraph"><p><span class="footnote"><br>[All of the code through section <a href="#endOfLinkAgainstLibbug">[endOfLinkAgainstLibbug]</a>
is done at compile-time.  The author chose to use subsection numbers to indicate
scope for code which spans multiple pages.]<br></span></p></div>
<div class="sect3">
<h4 id="_create_file_for_namespaces">1.4.1. Create File for Namespaces</h4>
<div class="paragraph"><p>The previous three macros are currently namespaced within libbug, but
external projects which link against libbug may need these namespace
mappings as well.  Towards that goal, open a file
during compile-time and write the namespace mappings
to the file.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>  {##<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> libbug-headers-file
<span style="color: #000000">    2:</span>    <span style="color: #FF0000">(</span>open-output-file '<span style="color: #FF0000">(</span>path: <span style="color: #FF0000">"libbug#.scm"</span> append: <span style="color: #009900">#f</span><span style="color: #FF0000">))</span>}
<span style="color: #000000">    3:</span>  <span style="color: #FF0000">(</span>display
<span style="color: #000000">    4:</span>   <span style="color: #FF0000">";;;Copyright 2014-2018 - William Emerison Six</span>
<span style="color: #000000">    5:</span> <span style="color: #FF0000">   ;;; All rights reserved</span>
<span style="color: #000000">    6:</span> <span style="color: #FF0000">   ;;; Distributed under LGPL 2.1 or Apache 2.0</span>
<span style="color: #000000">    7:</span> <span style="color: #FF0000">   {##namespace (</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">bug#</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000"> at-compile-time)}</span>
<span style="color: #000000">    8:</span> <span style="color: #FF0000">   {##namespace (</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">bug#</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000"> at-both-times)}</span>
<span style="color: #000000">    9:</span> <span style="color: #FF0000">   {##namespace (</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">bug#</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000"> at-compile-time-expand)}</span>
<span style="color: #000000">   10:</span> <span style="color: #FF0000">   "</span>
<span style="color: #000000">   11:</span>   libbug-headers-file<span style="color: #FF0000">)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_create_file_for_macro_definitions">1.4.2. Create File for Macro Definitions</h4>
<div class="paragraph"><p>The previous three macros are available within libbug,
but not to programs which link against libbug.  To rectify that, open a file
during compile-time, and write the macro definitions
to the file.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>  <span style="color: #FF0000">(</span>##include <span style="color: #FF0000">"config.scm"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    2:</span>  {##<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> bug-configuration#libbugsharp
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span>string-append bug-configuration#prefix <span style="color: #FF0000">"/include/libbug/libbug#.scm"</span><span style="color: #FF0000">)</span>}
<span style="color: #000000">    4:</span>
<span style="color: #000000">    5:</span>  {##<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> libbug-macros-file
<span style="color: #000000">    6:</span>    <span style="color: #FF0000">(</span>open-output-file '<span style="color: #FF0000">(</span>path: <span style="color: #FF0000">"libbug-macros.scm"</span> append: <span style="color: #009900">#f</span><span style="color: #FF0000">))</span>}
<span style="color: #000000">    7:</span>  <span style="color: #FF0000">(</span>display
<span style="color: #000000">    8:</span>   <span style="color: #FF0000">(</span>string-append
<span style="color: #000000">    9:</span>    <span style="color: #FF0000">";;;Copyright 2014-2018 - William Emerison Six</span>
<span style="color: #000000">   10:</span> <span style="color: #FF0000">    ;;; All rights reserved</span>
<span style="color: #000000">   11:</span> <span style="color: #FF0000">    ;;; Distributed under LGPL 2.1 or Apache 2.0</span>
<span style="color: #000000">   12:</span> <span style="color: #FF0000">    (##include </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">~~lib/gambit#.scm</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span> <span style="color: #FF0000">    (##include </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span> bug-configuration#libbugsharp <span style="color: #FF0000">"</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span> <span style="color: #FF0000">    {##define-macro at-compile-time</span>
<span style="color: #000000">   15:</span> <span style="color: #FF0000">      [|#!rest forms|</span>
<span style="color: #000000">   16:</span> <span style="color: #FF0000">       (eval `{begin</span>
<span style="color: #000000">   17:</span> <span style="color: #FF0000">                ,@forms})</span>
<span style="color: #000000">   18:</span> <span style="color: #FF0000">       '{quote noop}]}</span>
<span style="color: #000000">   19:</span> <span style="color: #FF0000">    {at-compile-time (##include </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">"</span> bug-configuration#libbugsharp <span style="color: #FF0000">"</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">)}</span>
<span style="color: #000000">   20:</span> <span style="color: #FF0000">    {##define-macro at-both-times</span>
<span style="color: #000000">   21:</span> <span style="color: #FF0000">      [|#!rest forms|</span>
<span style="color: #000000">   22:</span> <span style="color: #FF0000">       (eval `{begin</span>
<span style="color: #000000">   23:</span> <span style="color: #FF0000">                ,@forms})</span>
<span style="color: #000000">   24:</span> <span style="color: #FF0000">       `{begin</span>
<span style="color: #000000">   25:</span> <span style="color: #FF0000">          ,@forms}]}</span>
<span style="color: #000000">   26:</span> <span style="color: #FF0000">    {##define-macro at-compile-time-expand</span>
<span style="color: #000000">   27:</span> <span style="color: #FF0000">      [|#!rest forms|</span>
<span style="color: #000000">   28:</span> <span style="color: #FF0000">       (eval `{begin</span>
<span style="color: #000000">   29:</span> <span style="color: #FF0000">                ,@forms})]}</span>
<span style="color: #000000">   30:</span> <span style="color: #FF0000">   "</span><span style="color: #FF0000">)</span>
<span style="color: #000000">   31:</span>   libbug-macros-file<span style="color: #FF0000">)</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 1-3, include the "config.scm" file which was preprocessed
by Autoconf, so that the installation directory of libbug is known
at compile-time.
</p>
</li>
<li>
<p>
On line 13, "libbug#.scm" is imported, so that the generated macros are
namespaced correctly in external projects which import libbug.  In the previous section,
this file is created at compile-time.  Remember that when "libbug-macros.scm" will
be imported by an external project, "libbug#.scm" will exist with all
of the namespaces defined in libbug<span class="footnote"><br>[Marty: "Well Doc, we can
scratch that idea. I mean we can&#8217;t wait around a year and a half for this
thing to get finished."  Doc Brown:  "Marty it&#8217;s perfect, you&#8217;re just not
thinking fourth-dimensionally.  Don&#8217;t you see, the bridge will exist
in 1985." -Back to the Future 3]<br></span>.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_close_files_at_compile_time">1.4.3. Close Files At Compile-Time</h4>
<div class="paragraph"><p>Create a procedure to be invoked
at the end of compilation, to close the compile-time generated
files. Also, the namespace within the generated macro file
is reset to the default namespace<span class="footnote"><br>[This procedure
is called in section <a href="#call-end-of-compilation">[call-end-of-compilation]</a>]<br></span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>  {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> at-end-of-compilation
<span style="color: #000000">    2:</span>    [<span style="color: #FF0000">(</span>display
<span style="color: #000000">    3:</span>      <span style="color: #FF0000">"</span>
<span style="color: #000000">    4:</span> <span style="color: #FF0000">     (##namespace (</span><span style="color: #CC33CC">\"\"</span><span style="color: #FF0000">))"</span>
<span style="color: #000000">    5:</span>      libbug-macros-file<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span>force-output libbug-headers-file<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>     <span style="color: #FF0000">(</span>close-output-port libbug-headers-file<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>     <span style="color: #FF0000">(</span>force-output libbug-macros-file<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>     <span style="color: #FF0000">(</span>close-output-port libbug-macros-file<span style="color: #FF0000">)</span>]}
<span style="color: #000000">   10:</span>  }</tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="endOfLinkAgainstLibbug">1.5. libbug-private#write-and-eval</h3>
<div class="paragraph"><p>Now that those files are open, namespaces will be written
to "libbug#.scm" and macro definitions to "libbug-macros.scm".  However, the
code shouldn&#8217;t have be to duplicated for each context, as was done for
the previous three macros.</p></div>
<div class="paragraph"><p>Create a macro named "write-and-eval" which will write the
unevaluated form plus a newline to the
file, and then return the form so that the compiler actually evaluate
it<span class="footnote"><br>[any procedure which is namespaced to "libbug-private" is
not exported to the namespace file nor the macro file]<br></span>.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {##define-macro libbug-private#write-and-eval
<span style="color: #000000">    2:</span>   [|port form|
<span style="color: #000000">    3:</span>    <span style="color: #FF0000">(</span>eval `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    4:</span>             <span style="color: #FF0000">(</span>write ',form ,port<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>             <span style="color: #FF0000">(</span>newline ,port<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    6:</span>    form]}</tt></pre></div></div>
<div class="paragraph"><p>"write-and-eval" writes the form to a file, and evaluates the
form only in the run-time context.  For namespaces in libbug, namespaces
should be valid at
compile-time too.</p></div>
</div>
<div class="sect2">
<h3 id="_libbug_private_namespace">1.6. libbug-private#namespace</h3>
<div class="paragraph"><p>Namespaces for procedures in libbug need to be available at
compile-time, run-time, and in the namespace file
for inclusion in projects which link to libbug.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {##define-macro libbug-private#namespace
<span style="color: #000000">    2:</span>   [|#!rest to-namespace|
<span style="color: #000000">    3:</span>    {<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    4:</span>      <span style="color: #FF0000">(</span>eval `{##namespace <span style="color: #FF0000">(</span><span style="color: #FF0000">"bug#"</span> ,@to-namespace<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>      `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    6:</span>         {libbug-private#write-and-eval
<span style="color: #000000">    7:</span>          libbug-headers-file
<span style="color: #000000">    8:</span>          {##namespace <span style="color: #FF0000">(</span><span style="color: #FF0000">"bug#"</span> ,@to-namespace<span style="color: #FF0000">)</span>}}}}]}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_if">1.7. if</h3>
<div class="paragraph" id="langif"><p>In the following, a new version of "if" is defined named
"bug#if", where
"bug#if" takes two zero-argument procedures, treating them
as Church Booleans.  bug#if was first used and described
in section <a href="#langiffirstuse">[langiffirstuse]</a>.</p></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {libbug-private#namespace <span style="font-weight: bold"><span style="color: #0000FF">if</span></span>}
<span style="color: #000000">    2:</span> {libbug-private#write-and-eval
<span style="color: #000000">    3:</span>  libbug-macros-file
<span style="color: #000000">    4:</span>  {at-both-times
<span style="color: #000000">    5:</span>   {##define-macro <span style="font-weight: bold"><span style="color: #0000FF">if</span></span>
<span style="color: #000000">    6:</span>     [|pred ifTrue ifFalse|
<span style="color: #000000">    7:</span>      {##<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>list? ifTrue<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                 <span style="color: #FF0000">(</span>list? ifFalse<span style="color: #FF0000">)</span>
<span style="color: #000000">    9:</span>                 <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>null? ifTrue<span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>                 <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="color: #FF0000">(</span>null? ifFalse<span style="color: #FF0000">))</span>
<span style="color: #000000">   11:</span>                 <span style="color: #FF0000">(</span>equal? '<span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> <span style="color: #FF0000">(</span>car ifTrue<span style="color: #FF0000">))</span>
<span style="color: #000000">   12:</span>                 <span style="color: #FF0000">(</span>equal? '<span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> <span style="color: #FF0000">(</span>car ifFalse<span style="color: #FF0000">))</span>}
<span style="color: #000000">   13:</span>            <span style="color: #FF0000">(</span>list '##<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> pred
<span style="color: #000000">   14:</span>                  `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span> ,@<span style="color: #FF0000">(</span>cddr ifTrue<span style="color: #FF0000">)</span>}
<span style="color: #000000">   15:</span>                  `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span> ,@<span style="color: #FF0000">(</span>cddr ifFalse<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">   16:</span>            <span style="color: #FF0000">(</span>error <span style="color: #FF0000">"bug#if requires two lambda expressions"</span><span style="color: #FF0000">)</span>}]}}}</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 7, "if" is called.  In Gambit&#8217;s system of namespacing, "'
is prefixed to a variable name to specify to use the global namespace for
that variable.
"bug#if" is built on Gambit&#8217;s implementation of "if", but since
line 1 set the namespace of "if" to "bug#if", "##if" must be
used.
</p>
</li>
<li>
<p>
On lines 7-12, check that the caller of "bug#if" is passing
lambdas, i.e. has not forgotten that "if" is namespaced to "bug".
</p>
</li>
<li>
<p>
On line 16, if the caller of "bug#if" has not passed lambdas,
error at compile-time.
</p>
</li>
<li>
<p>
On line 13-15, evaluate the body of the appropriate lambda, depending
on whether the predicate is true or false.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_unit_test">1.8. unit-test</h3>
<div class="paragraph"><p></p></div>
<div class="paragraph"><p>Given that the reader now knows how to evaluate at compile-time, implementing
a macro to execute tests at compile-time is trivial.</p></div>
<div class="ulist"><ul>
<li>
<p>
Make a macro called "unit-test", which takes
an unevaluated list of tests.
</p>
</li>
<li>
<p>
"eval" the tests at compile-time.
If any test evaluates to false, force the compiler to exit in error, producing
an appropriate error message.  If all of the tests pass, the Gambit compiler
continues compiling subsequent definitions.
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {libbug-private#namespace unit-test}
<span style="color: #000000">    2:</span> {libbug-private#write-and-eval
<span style="color: #000000">    3:</span>  libbug-macros-file
<span style="color: #000000">    4:</span>  {##define-macro unit-test
<span style="color: #000000">    5:</span>    [|#!rest tests|
<span style="color: #000000">    6:</span>     <span style="color: #FF0000">(</span>eval
<span style="color: #000000">    7:</span>      `<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> ,@tests}
<span style="color: #000000">    8:</span>           [''noop]
<span style="color: #000000">    9:</span>           [<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">for-each</span></span> pp '<span style="color: #FF0000">(</span><span style="color: #FF0000">"Test Failed"</span> ,@tests<span style="color: #FF0000">))</span>
<span style="color: #000000">   10:</span>            <span style="color: #FF0000">(</span>error <span style="color: #FF0000">"Tests Failed"</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">))</span>]}}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_libbug_private_define">1.9. libbug-private#define</h3>
<div class="paragraph"><p>"libbug-private#define" is the main procedure-defining procedure used
throughout libbug.  "libbug-private#define" takes a variable name and
a value to be stored in the variable.</p></div>
<div class="paragraph" id="libbugdefine"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {##define-macro
<span style="color: #000000">    2:</span>   libbug-private#<span style="font-weight: bold"><span style="color: #0000FF">define</span></span>
<span style="color: #000000">    3:</span>   [|name body|
<span style="color: #000000">    4:</span>    `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    5:</span>       {libbug-private#namespace ,name}
<span style="color: #000000">    6:</span>       {at-both-times
<span style="color: #000000">    7:</span>        {##<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> ,name ,body}}}]}</tt></pre></div></div>
<div class="paragraph"><p>"libbug-private#define" defines the procedure/data both at both compile-time
and run-time, and exports the namespace mapping to the appropriate file.
"libbug-private#define" itself is not exported to the macros file.</p></div>
<div class="paragraph"><p>On line 6-7, the definition occurs at both compile-time and run-time,
ensuring that the procedure is available for evaluation of tests during compile-time.</p></div>
</div>
<div class="sect2">
<h3 id="_libbug_private_define_macro">1.10. libbug-private#define-macro</h3>
<div class="paragraph"><p>Like "libbug-private#define" is built upon "define",
"libbug-private#define-macro" is built upon "define-macro".
"libbug-private#define-macro"
ensures that the macro is available both at
run-time and at compile-time. Macros do not get compiled into
libraries however, so for other projects to use them they must be exported
to file.</p></div>
<div class="paragraph"><p>The steps will be as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
Write the macro to file
</p>
</li>
<li>
<p>
Write the macro-expander to file
</p>
</li>
<li>
<p>
Define the macro-expander within libbug
</p>
</li>
<li>
<p>
Define the macro.
</p>
</li>
</ul></div>
<div class="paragraph" id="libbugdefinemacro"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {##define-macro libbug-private#define-macro
<span style="color: #000000">    2:</span>   [|name lambda-value|</tt></pre></div></div>
<div class="sect3">
<h4 id="_write_the_macro_to_file">1.10.1. Write the Macro to File</h4>
<div class="listingblock">
<a id="writemacrotofile"></a>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>    <span style="color: #FF0000">(</span>write
<span style="color: #000000">    2:</span>     `{at-both-times</tt></pre></div></div>
<div class="sect4">
<h5 id="_macro_definition">Macro Definition</h5>
<div class="paragraph"><p>The macro definition written to file will be imported as
text by other projects
which may have different namespace mappings than libbug.
To ensure that the macro works correctly in other contexts, the
appropriate namespace
mappings must be loaded for the definition of this macro definition.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>       {##define-macro
<span style="color: #000000">    2:</span>         ,name
<span style="color: #000000">    3:</span>         {<span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> ,<span style="color: #FF0000">(</span>cadr lambda-value<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>           ,<span style="color: #FF0000">(</span>list 'quasiquote
<span style="color: #000000">    5:</span>                  `{##<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">()</span>
<span style="color: #000000">    6:</span>                     <span style="color: #FF0000">(</span>##include <span style="color: #FF0000">"~~lib/gambit#.scm"</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>                     <span style="color: #FF0000">(</span>##include ,bug-configuration#libbugsharp<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>                     ,<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> {<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="color: #FF0000">(</span>pair? <span style="color: #FF0000">(</span>caddr lambda-value<span style="color: #FF0000">))</span>
<span style="color: #000000">    9:</span>                               <span style="color: #FF0000">(</span>equal? 'quasiquote
<span style="color: #000000">   10:</span>                                       <span style="color: #FF0000">(</span>caaddr lambda-value<span style="color: #FF0000">))</span>}
<span style="color: #000000">   11:</span>                          [<span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cdaddr lambda-value<span style="color: #FF0000">))</span>]
<span style="color: #000000">   12:</span>                          [<span style="color: #FF0000">(</span>append <span style="color: #FF0000">(</span>list 'unquote<span style="color: #FF0000">)</span>
<span style="color: #000000">   13:</span>                                   <span style="color: #FF0000">(</span>cddr lambda-value<span style="color: #FF0000">))</span>]<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>}}</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 3, the lambda value written to file shall have the same
argument list as the argument list passed to "libbug-private#define-macro"
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>   &gt; <span style="color: #FF0000">(</span>cadr '[|foo bar| <span style="color: #FF0000">(</span>quasiquote <span style="color: #993399">5</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
   <span style="color: #FF0000">(</span>foo bar<span style="color: #FF0000">)</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 4, the unevaluated form in argument "lambda-value" may
or may not be quasiquoted.  Either way, write a quasiquoted form
to the file.  In the case that the "lambda-value" argument was not
actually intended to be quasiquoted, unquote the lambda&#8217;s body (which is
done on line 12-13), thereby negating the quasi-quoting from line 4.
</p>
</li>
<li>
<p>
On lines 4-5, rather than nesting quasiquotes, use the technique
of replacing a would-be nested quasiquote with ",(list 'quasiquote `(&#8230;)".
This makes the code more readable &lt;<a href="#paip">[paip]</a>&gt;.  Should the reader
be interested in learning more about nested quasiquotes, Appendix C
of &lt;<a href="#cl">[cl]</a>&gt; is a great reference.
</p>
</li>
<li>
<p>
On lines 5-7, ensure that the currently unevaluated form will be
evaluated using libbug&#8217;s namespaces.
Line 5 create a bounded
context for namespace mapping.  Line 6 sets standard Gambit namespace
mappings, line 7 sets libbug&#8217;s mappings.
</p>
</li>
<li>
<p>
On line 8-10, check to see if the unevaluated form is quasiquoted.
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>   &gt; <span style="color: #FF0000">(</span>caaddr '[|foo bar| <span style="color: #FF0000">(</span>quasiquote <span style="color: #993399">5</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)</span>
   quasiquote</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 11, since it is quasiquoted, grab the content of the
list minus the quasiquoting.
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>   &gt; <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cdaddr '[|foo bar| <span style="color: #FF0000">(</span>quasiquote <span style="color: #993399">5</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">))</span>
   <span style="color: #993399">5</span></tt></pre></div></div>
<div class="paragraph"><p>Remember that this value gets wrapped in a quasiquote from line 5</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>   &gt; <span style="color: #FF0000">(</span>list 'quasiquote <span style="color: #FF0000">(</span>car <span style="color: #FF0000">(</span>cdaddr '[|foo bar|
                                        <span style="color: #FF0000">(</span>quasiquote <span style="color: #993399">5</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)))</span>
   `<span style="color: #993399">5</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 12-13, since this is not a quasiquoted form, just grab
the form, and "unquote" it.
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>   &gt; <span style="color: #FF0000">(</span>append <span style="color: #FF0000">(</span>list 'unquote<span style="color: #FF0000">)</span> <span style="color: #FF0000">(</span>cddr '[|foo bar| <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">))</span>
   ,<span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Remember, this value gets wrapped in a quasiquote from line 4</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>   &gt; <span style="color: #FF0000">(</span>list 'quasiquote <span style="color: #FF0000">(</span>append <span style="color: #FF0000">(</span>list 'unquote<span style="color: #FF0000">)</span>
                               <span style="color: #FF0000">(</span>cddr '[|foo bar|
                                         <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)))</span>
   `,<span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>
   &gt; <span style="color: #FF0000">(</span>eval <span style="color: #FF0000">(</span>list 'quasiquote <span style="color: #FF0000">(</span>append <span style="color: #FF0000">(</span>list 'unquote<span style="color: #FF0000">)</span>
                                     <span style="color: #FF0000">(</span>cddr '[|foo bar|
                                               <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">5</span><span style="color: #FF0000">)</span>]<span style="color: #FF0000">)))</span>
   <span style="color: #993399">10</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_define_a_macro_expander">Define a Macro-Expander</h5>
<div class="paragraph"><p>In order to be able to test the macro-expansions effectively, a programmer
needs to be able to access the code generated from the macro as a data structure.
For each macro defined, create a new macro with the same name suffixed with "-expand",
whose body is the same procedure as
"lambda-value"s body, but the result of evaluating that body is "quoted".
In this new procedure&#8217;s local environment, define "gensym"
so that tests may be written<span class="footnote"><br>["##gensym" by definition
creates a unique symbol which the programmer can not directly input, making testing of the macro-expansion
impossible.
Thus, the problem is solved by locally defining a new "gensym" procedure.]<br></span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>       {##define-macro
<span style="color: #000000">    2:</span>         ,<span style="color: #FF0000">(</span>string-&gt;symbol <span style="color: #FF0000">(</span>string-append <span style="color: #FF0000">(</span>symbol-&gt;string name<span style="color: #FF0000">)</span>
<span style="color: #000000">    3:</span>                                         <span style="color: #FF0000">"-expand"</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    4:</span>         {<span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> ,<span style="color: #FF0000">(</span>cadr lambda-value<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>           {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>gensym {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>gensym-count <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>                           [{set! gensym-count
<span style="color: #000000">    7:</span>                                  <span style="color: #FF0000">(</span>+ <span style="color: #993399">1</span> gensym-count<span style="color: #FF0000">)</span>}
<span style="color: #000000">    8:</span>                            <span style="color: #FF0000">(</span>string-&gt;symbol
<span style="color: #000000">    9:</span>                             <span style="color: #FF0000">(</span>string-append
<span style="color: #000000">   10:</span>                              <span style="color: #FF0000">"gensymed-var"</span>
<span style="color: #000000">   11:</span>                              <span style="color: #FF0000">(</span>number-&gt;string gensym-count<span style="color: #FF0000">)))</span>]}<span style="color: #FF0000">))</span>
<span style="color: #000000">   12:</span>             <span style="color: #FF0000">(</span>list 'quote ,@<span style="color: #FF0000">(</span>cddr lambda-value<span style="color: #FF0000">))</span>}}}}</tt></pre></div></div>
<div class="paragraph"><p>Finish writing the macro to file which was started in section <a href="#writemacrotofile">[writemacrotofile]</a>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>     libbug-macros-file<span style="color: #FF0000">)</span>
<span style="color: #000000">    2:</span>    <span style="color: #FF0000">(</span>newline libbug-macros-file<span style="color: #FF0000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_define_macro_and_run_tests_within_libbug">1.10.2. Define Macro and Run Tests Within Libbug</h4>
<div class="paragraph"><p>The macro has been exported to a file for use by projects which link against libbug,
but it must also be defined during compilation.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>    `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span></tt></pre></div></div>
<div class="paragraph"><p>Namespace the procedure and the expander.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>       {libbug-private#namespace ,name}
<span style="color: #000000">    2:</span>       {libbug-private#namespace ,<span style="color: #FF0000">(</span>string-&gt;symbol
<span style="color: #000000">    3:</span>                                   <span style="color: #FF0000">(</span>string-append <span style="color: #FF0000">(</span>symbol-&gt;string name<span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>                                                  <span style="color: #FF0000">"-expand"</span><span style="color: #FF0000">))</span>}</tt></pre></div></div>
<div class="paragraph"><p>Create the expander similarly to the previous section.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>       {at-both-times
<span style="color: #000000">    2:</span>        {##define-macro
<span style="color: #000000">    3:</span>          ,<span style="color: #FF0000">(</span>string-&gt;symbol
<span style="color: #000000">    4:</span>            <span style="color: #FF0000">(</span>string-append <span style="color: #FF0000">(</span>symbol-&gt;string name<span style="color: #FF0000">)</span>
<span style="color: #000000">    5:</span>                           <span style="color: #FF0000">"-expand"</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    6:</span>          {<span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> ,<span style="color: #FF0000">(</span>cadr lambda-value<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>            {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>gensym {<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>gensym-count <span style="color: #993399">0</span><span style="color: #FF0000">))</span>
<span style="color: #000000">    8:</span>                            [{set! gensym-count
<span style="color: #000000">    9:</span>                                   <span style="color: #FF0000">(</span>+ <span style="color: #993399">1</span> gensym-count<span style="color: #FF0000">)</span>}
<span style="color: #000000">   10:</span>                             <span style="color: #FF0000">(</span>string-&gt;symbol
<span style="color: #000000">   11:</span>                              <span style="color: #FF0000">(</span>string-append
<span style="color: #000000">   12:</span>                               <span style="color: #FF0000">"gensymed-var"</span>
<span style="color: #000000">   13:</span>                               <span style="color: #FF0000">(</span>number-&gt;string gensym-count<span style="color: #FF0000">)))</span>]}<span style="color: #FF0000">))</span>
<span style="color: #000000">   14:</span>              <span style="color: #FF0000">(</span>list 'quote ,@<span style="color: #FF0000">(</span>cddr lambda-value<span style="color: #FF0000">))</span>}}}}</tt></pre></div></div>
<div class="paragraph"><p>Define the macro.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>       {at-both-times
<span style="color: #000000">    2:</span>        {##define-macro
<span style="color: #000000">    3:</span>          ,name
<span style="color: #000000">    4:</span>          ,lambda-value}}}]}
<span style="color: #000000">    5:</span> </tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_macroexpand_1">1.11. macroexpand-1</h3>
<div class="paragraph"><p>"macroexpand-1" is syntactic sugar which allows the programmer to test macro-expansion by writing</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">(</span>equal? {macroexpand-1 {aif <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">10</span><span style="color: #FF0000">)</span>
                           <span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>}}
      '{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>bug#it <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">10</span><span style="color: #FF0000">)))</span>
         <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> bug#it
             [<span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>]
             [<span style="color: #009900">#f</span>]<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span></tt></pre></div></div>
<div class="paragraph"><p>instead of</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">(</span>equal? {aif-expand <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">10</span><span style="color: #FF0000">)</span>
                   <span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">))</span>}
      '{<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #FF0000">((</span>bug#it <span style="color: #FF0000">(</span>+ <span style="color: #993399">5</span> <span style="color: #993399">10</span><span style="color: #FF0000">)))</span>
         <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> bug#it
             [<span style="color: #FF0000">(</span>* <span style="color: #993399">2</span> bug#it<span style="color: #FF0000">)</span>]
             [<span style="color: #009900">#f</span>]<span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span></tt></pre></div></div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {libbug-private#define-macro
<span style="color: #000000">    2:</span>  macroexpand-1
<span style="color: #000000">    3:</span>  [|form|
<span style="color: #000000">    4:</span>   {<span style="font-weight: bold"><span style="color: #0000FF">let*</span></span> <span style="color: #FF0000">((</span>m <span style="color: #FF0000">(</span>car form<span style="color: #FF0000">))</span>
<span style="color: #000000">    5:</span>          <span style="color: #FF0000">(</span>the-expander <span style="color: #FF0000">(</span>string-&gt;symbol
<span style="color: #000000">    6:</span>                         <span style="color: #FF0000">(</span>string-append <span style="color: #FF0000">(</span>symbol-&gt;string m<span style="color: #FF0000">)</span>
<span style="color: #000000">    7:</span>                                        <span style="color: #FF0000">"-expand"</span><span style="color: #FF0000">))))</span>
<span style="color: #000000">    8:</span>     `<span style="color: #FF0000">(</span>,the-expander ,@<span style="color: #FF0000">(</span>cdr form<span style="color: #FF0000">))</span>}]}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_libbug_private_define_structure">1.12. libbug-private#define-structure</h3>
<div class="paragraph" id="definestructure"><p></p></div>
<div class="paragraph"><p>Like "define-structure", but additionally writes the namespaces
to file<span class="footnote"><br>[In the following, "define-structure" is defined at
compile-time, because Gambit does not define "##define-structure" at compile-time.]<br></span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> {at-compile-time
<span style="color: #000000">    2:</span>  {##define-macro ##define-structure
<span style="color: #000000">    3:</span>    [|#!rest args| `{define-structure ,@args}]}}
<span style="color: #000000">    4:</span> {##define-macro
<span style="color: #000000">    5:</span>   libbug-private#define-structure
<span style="color: #000000">    6:</span>   [|name #!rest members|
<span style="color: #000000">    7:</span>    `{<span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
<span style="color: #000000">    8:</span>       {libbug-private#namespace
<span style="color: #000000">    9:</span>        ,<span style="color: #FF0000">(</span>string-&gt;symbol
<span style="color: #000000">   10:</span>          <span style="color: #FF0000">(</span>string-append <span style="color: #FF0000">"make-"</span>
<span style="color: #000000">   11:</span>                         <span style="color: #FF0000">(</span>symbol-&gt;string name<span style="color: #FF0000">)))</span>
<span style="color: #000000">   12:</span>        ,<span style="color: #FF0000">(</span>string-&gt;symbol
<span style="color: #000000">   13:</span>          <span style="color: #FF0000">(</span>string-append <span style="color: #FF0000">(</span>symbol-&gt;string name<span style="color: #FF0000">)</span>
<span style="color: #000000">   14:</span>                         <span style="color: #FF0000">"?"</span><span style="color: #FF0000">))</span>
<span style="color: #000000">   15:</span>        ,@<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|m|
<span style="color: #000000">   16:</span>                <span style="color: #FF0000">(</span>string-&gt;symbol
<span style="color: #000000">   17:</span>                 <span style="color: #FF0000">(</span>string-append <span style="color: #FF0000">(</span>symbol-&gt;string name<span style="color: #FF0000">)</span>
<span style="color: #000000">   18:</span>                                <span style="color: #FF0000">"-"</span>
<span style="color: #000000">   19:</span>                                <span style="color: #FF0000">(</span>symbol-&gt;string m<span style="color: #FF0000">)))</span>]
<span style="color: #000000">   20:</span>               members<span style="color: #FF0000">)</span>
<span style="color: #000000">   21:</span>        ,@<span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">map</span></span> [|m|
<span style="color: #000000">   22:</span>                <span style="color: #FF0000">(</span>string-&gt;symbol
<span style="color: #000000">   23:</span>                 <span style="color: #FF0000">(</span>string-append <span style="color: #FF0000">(</span>symbol-&gt;string name<span style="color: #FF0000">)</span>
<span style="color: #000000">   24:</span>                                <span style="color: #FF0000">"-"</span>
<span style="color: #000000">   25:</span>                                <span style="color: #FF0000">(</span>symbol-&gt;string m<span style="color: #FF0000">)</span>
<span style="color: #000000">   26:</span>                                <span style="color: #FF0000">"-set!"</span><span style="color: #FF0000">))</span>]
<span style="color: #000000">   27:</span>               members<span style="color: #FF0000">)</span>}
<span style="color: #000000">   28:</span>       {at-both-times
<span style="color: #000000">   29:</span>        {##namespace <span style="color: #FF0000">(</span><span style="color: #FF0000">""</span>
<span style="color: #000000">   30:</span>                      <span style="font-weight: bold"><span style="color: #0000FF">define</span></span>
<span style="color: #000000">   31:</span>                      define-structure
<span style="color: #000000">   32:</span>                      <span style="color: #FF0000">)</span>}
<span style="color: #000000">   33:</span>        {define-structure ,name ,@members}
<span style="color: #000000">   34:</span>        {##namespace <span style="color: #FF0000">(</span><span style="color: #FF0000">"libbug-private#"</span>
<span style="color: #000000">   35:</span>                      <span style="font-weight: bold"><span style="color: #0000FF">define</span></span>
<span style="color: #000000">   36:</span>                      <span style="color: #FF0000">)</span>}
<span style="color: #000000">   37:</span>        {##namespace <span style="color: #FF0000">(</span><span style="color: #FF0000">"bug#"</span>
<span style="color: #000000">   38:</span>                      define-structure
<span style="color: #000000">   39:</span>                      <span style="color: #FF0000">)</span>}}}]}</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compile_time_language">2. Appendix A: Compile-Time Language</h2>
<div class="sectionbody">
<div class="paragraph" id="appendix1"><p>This appendix<span class="footnote"><br>[Examples in the appendix will have boxes
and line numbers around the code, but they are not part of libbug.]<br></span>
provides a quick tour of computer language which is interpreted
by the compiler but which is absent in the generated machine
code.  Examples are provided in
well-known languages to illustrate that
most compilers are also interpreters for a subset of the language.  This
appendix provides a baseline demonstration of compile-time computation
so that the reader may contrast these languages' capabilities with libbug&#8217;s.
But first, let&#8217;s discuss what is meant by the words "language","compiler", and
"interpreter".</p></div>
<div class="paragraph"><p>In "Introduction to Automata Theory, Languages, and Computation", Hopcroft,
Motwani, and Ullman define language as "A set of strings all of which are chosen
from some &#931;<sup>*</sup>, where &#931; is a particular alphabet, is called
a language" &lt;<a href="#hmu2001">[hmu2001]</a>&gt;.</p></div>
<div class="paragraph"><p>Plainly, that means that an "alphabet" is a set of characters (for instance, ASCII), and
that a computer "language" is defined as all of the possible sequences of characters
from that alphabet which are able to be compiled successfully.</p></div>
<div class="paragraph"><p>An "interpreter" is a computer program which takes an instance of a specific
computer language as input,
and immediately executes the instructions.  A "compiler" is a computer program
which also takes an instance of a specific computer language as input,
but rather than immediately executing the input language, instead the compiler
translates the input language
into another computer language (typically machine code), which is then output to a file
for interpretation<span class="footnote"><br>[the Central Processing Unit (CPU) can be viewed as an
interpreter which takes machine code as its input]<br></span> at a later time.</p></div>
<div class="paragraph"><p>In practice though, the distinction is not binary.  Most compilers do not exclusively
translate from an input language
to an output language; instead, they also interpret a subset of the input
language as part of the compilation process.  So what
types of computations can be performed by this subset of language, and how do
they vary in expressive power?</p></div>
<div class="sect2">
<h3 id="_c">2.1. C</h3>
<div class="paragraph"><p>Consider the following C code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> <span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdio.h&gt;</span>
<span style="color: #000000">    2:</span> <span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">square</span></span><span style="color: #990000">(</span>x<span style="color: #990000">)</span> <span style="color: #990000">((</span>x<span style="color: #990000">)</span> <span style="color: #990000">*</span> <span style="color: #990000">(</span>x<span style="color: #990000">))</span>
<span style="color: #000000">    3:</span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">fact</span></span><span style="color: #990000">(</span><span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> n<span style="color: #990000">);</span>
<span style="color: #000000">    4:</span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">main</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> argc<span style="color: #990000">,</span> <span style="color: #009900">char</span><span style="color: #990000">*</span> argv<span style="color: #990000">[])</span><span style="color: #FF0000">{</span>
<span style="color: #000000">    5:</span> <span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> DEBUG
<span style="color: #000000">    6:</span>   <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Debug - argc = %d</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> argc<span style="color: #990000">);</span>
<span style="color: #000000">    7:</span> <span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<span style="color: #000000">    8:</span>  <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"%d</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span><span style="font-weight: bold"><span style="color: #000000">square</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">fact</span></span><span style="color: #990000">(</span>argc<span style="color: #990000">)));</span>
<span style="color: #000000">    9:</span>   <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<span style="color: #000000">   10:</span> <span style="color: #FF0000">}</span>
<span style="color: #000000">   11:</span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">fact</span></span><span style="color: #990000">(</span><span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> n<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
<span style="color: #000000">   12:</span>   <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> n <span style="color: #990000">==</span> <span style="color: #993399">0</span>
<span style="color: #000000">   13:</span>     <span style="color: #990000">?</span> <span style="color: #993399">1</span>
<span style="color: #000000">   14:</span>     <span style="color: #990000">:</span> n <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">fact</span></span><span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
<span style="color: #000000">   15:</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 1, the #include preprocessor command
is language to be interpreted by the compiler,
instructing the compiler to
read the file "stdio.h"
from the filesystem and to splice the content
into the current C file.  The #include command
itself has no representation in the generated machine code, although the contents
of the included file may.
</p>
</li>
<li>
<p>
Line 2 defines a C macro. A C macro is a procedure definition which
is to be interpreted by the compiler instead of being translated
into the output language.
A C macro takes a text
string as input and transforms it into a new text string as output.
This expansion happens before the compiler does anything
else.  For example, using GCC as a compiler, if you run the C preprocessor
"cpp" on the above C code, you&#8217;ll see that
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>   <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"%d</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span><span style="font-weight: bold"><span style="color: #000000">square</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">fact</span></span><span style="color: #990000">(</span>argc<span style="color: #990000">)));</span></tt></pre></div></div>
<div class="paragraph"><p>expands into</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>   <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"%d</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,((</span><span style="font-weight: bold"><span style="color: #000000">fact</span></span><span style="color: #990000">(</span>argc<span style="color: #990000">))</span> <span style="color: #990000">*</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">fact</span></span><span style="color: #990000">(</span>argc<span style="color: #990000">))));</span></tt></pre></div></div>
<div class="paragraph"><p>before compilation.</p></div>
<div class="paragraph"><p>-Line 3 defines a procedure prototype so that
the compiler knows the argument types and the return type for a procedure not
yet defined called "fact".
It is language interpreted by the compiler to determine the types for the procedure
call to "fact" on line 8.</p></div>
<div class="paragraph"><p>-Lines 4 through 10 are a procedure definition which will be
translated into instructions in the generated machine code.  Line 5 however, is language
to be interpreted by the compiler, referencing a variable which is defined
only during compile-time, to detemine whether or not line 6 should be
compiled.</p></div>
</div>
<div class="sect2">
<h3 id="_c_43_43">2.2. C&#43;&#43;</h3>
<div class="paragraph"><p>C&#43;&#43; inherits C&#8217;s macros, but with the additional introduction
of templates, its compile-time language
incidentally became Turing complete;  meaning that
anything that can be
calculated by a computer can be calculated using template expansion
at compile-time.  That&#8217;s great!  So how does a programmer use this new
expressive power?</p></div>
<div class="paragraph"><p>The following is an example of calculating the factorial of
3; using C&#43;&#43; procedures for run-time calulation, and C&#43;&#43;'s templates for compile-time
calculation.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span> <span style="font-weight: bold"><span style="color: #000080"> #include</span></span> <span style="color: #FF0000">&lt;iostream&gt;</span>
<span style="color: #000000">    2:</span>  <span style="font-weight: bold"><span style="color: #0000FF">template</span></span> <span style="color: #990000">&lt;</span><span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> n<span style="color: #990000">&gt;</span>
<span style="color: #000000">    3:</span>  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">factorial</span> <span style="color: #FF0000">{</span>
<span style="color: #000000">    4:</span>      <span style="font-weight: bold"><span style="color: #0000FF">enum</span></span> <span style="color: #FF0000">{</span> value <span style="color: #990000">=</span> n <span style="color: #990000">*</span> factorial<span style="color: #990000">&lt;</span>n <span style="color: #990000">-</span> <span style="color: #993399">1</span><span style="color: #990000">&gt;::</span>value <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #000000">    5:</span>  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #000000">    6:</span>  <span style="font-weight: bold"><span style="color: #0000FF">template</span></span> <span style="color: #990000">&lt;&gt;</span>
<span style="color: #000000">    7:</span>  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">factorial</span><span style="color: #990000">&lt;</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span> <span style="color: #FF0000">{</span>
<span style="color: #000000">    8:</span>      <span style="font-weight: bold"><span style="color: #0000FF">enum</span></span> <span style="color: #FF0000">{</span> value <span style="color: #990000">=</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #000000">    9:</span>  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #000000">   10:</span>  <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">fact</span></span><span style="color: #990000">(</span><span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> n<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
<span style="color: #000000">   11:</span>    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> n <span style="color: #990000">==</span> <span style="color: #993399">0</span>
<span style="color: #000000">   12:</span>      <span style="color: #990000">?</span> <span style="color: #993399">1</span>
<span style="color: #000000">   13:</span>      <span style="color: #990000">:</span> n <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">fact</span></span><span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
<span style="color: #000000">   14:</span>  <span style="color: #FF0000">}</span>
<span style="color: #000000">   15:</span>  <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">main</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> argc<span style="color: #990000">,</span> <span style="color: #009900">char</span><span style="color: #990000">*</span> argv<span style="color: #990000">[])</span><span style="color: #FF0000">{</span>
<span style="color: #000000">   16:</span>    std<span style="color: #990000">::</span>cout <span style="color: #990000">&lt;&lt;</span> factorial<span style="color: #990000">&lt;</span><span style="color: #993399">3</span><span style="color: #990000">&gt;::</span>value <span style="color: #990000">&lt;&lt;</span> std<span style="color: #990000">::</span>endl<span style="color: #990000">;</span>
<span style="color: #000000">   17:</span>    std<span style="color: #990000">::</span>cout <span style="color: #990000">&lt;&lt;</span> <span style="font-weight: bold"><span style="color: #000000">fact</span></span><span style="color: #990000">(</span><span style="color: #993399">3</span><span style="color: #990000">)</span> <span style="color: #990000">&lt;&lt;</span> std<span style="color: #990000">::</span>endl<span style="color: #990000">;</span>
<span style="color: #000000">   18:</span>    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<span style="color: #000000">   19:</span>  <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>-Lines 10-14 are the run-time calculation of "fact", identical
to the previous version in C.</p></div>
<div class="paragraph"><p>-Lines 2-9 are the
template code for the compile-time calculation of "factorial".  Notice
that the language constructs used are drastically different than the
run-time constructs.</p></div>
<div class="paragraph"><p>-On line 16, "factorial&lt;3&gt;::value" is
language to be interpreted
by the compiler via template expansions.  Template expansions
conditionally match patterns based on types (or values in the case
of integers).  For iteration, templates expand recursively instead of using loops.
In this case,  "factorial&lt;3&gt;::value" expands to
"3 * factorial&lt;3 - 1&gt;::value".  The compiler
does the subtraction during compile-time,
so "factorial&lt;3&gt;::value" expands to
"3 * factorial&lt;2&gt;::value".
This recursion terminates on "factorial&lt;0&gt;::value"
on line 7<span class="footnote"><br>[Even though
the base case of "factorial&lt;0&gt;" is lexically specified
after the more general
case of "factorial&lt; n&gt;", templates expand the most
specific case first.  So the compiler will terminate.]<br></span>.</p></div>
<div class="paragraph"><p>-On line 17, a run-time call to "fact", defined on line 10, is declared.</p></div>
<div class="sect3">
<h4 id="_disassembling_the_object_file">2.2.1. Disassembling the Object File</h4>
<div class="paragraph"><p>The drastic difference in the generated code can be observed by using "objdump -D".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>  400850: be 06 00 00 00   mov    $0x6,%esi
<span style="color: #000000">    2:</span>  400855: bf c0 0d 60 00   mov    $0x600dc0,%edi
<span style="color: #000000">    3:</span>  40085a: e8 41 fe ff ff   callq  4006a0 &lt;_ZNSolsEi@plt&gt;
<span style="color: #000000">    4:</span>  .......
<span style="color: #000000">    5:</span>  .......
<span style="color: #000000">    6:</span>  .......
<span style="color: #000000">    7:</span>  40086c: bf 03 00 00 00   mov    $0x3,%edi
<span style="color: #000000">    8:</span>  400871: e8 a0 ff ff ff   callq  400816 &lt;_Z4facti&gt;
<span style="color: #000000">    9:</span>  400876: 89 c6            mov    %eax,%esi
<span style="color: #000000">   10:</span>  400878: bf c0 0d 60 00   mov    $0x600dc0,%edi
<span style="color: #000000">   11:</span>  40087d: e8 1e fe ff ff   callq  4006a0 &lt;_ZNSolsEi@plt&gt;</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
The instructions at memory locations 400850 through 40085a correspond to the
printing of the compile-time expanded call to factorial&lt;3&gt;::value.
The immediate value 6 is loaded into the "esi" register; then the following
two lines call the printing routine<span class="footnote"><br>[at least I assume, because
I don&#8217;t completely understand how C&#43;&#43; name-mangling works]<br></span>.
</p>
</li>
<li>
<p>
The instructions at locations 40086c through 40087d correspond to the
printing of the run-time calculation to "fact(3)".  The immediate value 3
is loaded into the "edi" register, fact is invoked, the result of
calling fact is moved from the "eax" register to the "esi" register, and then
printing routine is called.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The compile-time computation worked as expected!</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_libbug">2.3. libbug</h3>
<div class="paragraph"><p>Like C&#43;&#43;'s compile-time language, libbug&#8217;s is Turing complete.  But libbug&#8217;s compile-time
language is the exact same language as the run-time language!</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>  {at-both-times
<span style="color: #000000">    2:</span>   {<span style="font-weight: bold"><span style="color: #0000FF">define</span></span> fact
<span style="color: #000000">    3:</span>     [|n| <span style="color: #FF0000">(</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">(</span>= n <span style="color: #993399">0</span><span style="color: #FF0000">)</span>
<span style="color: #000000">    4:</span>              [<span style="color: #993399">1</span>]
<span style="color: #000000">    5:</span>              [<span style="color: #FF0000">(</span>* n <span style="color: #FF0000">(</span>fact <span style="color: #FF0000">(</span>- n <span style="color: #993399">1</span><span style="color: #FF0000">)))</span>]<span style="color: #FF0000">)</span>]}}
<span style="color: #000000">    6:</span>
<span style="color: #000000">    7:</span>  <span style="color: #FF0000">(</span>pp {at-compile-time-expand <span style="color: #FF0000">(</span>fact <span style="color: #993399">3</span><span style="color: #FF0000">)</span>}<span style="color: #FF0000">)</span>
<span style="color: #000000">    8:</span>  <span style="color: #FF0000">(</span>pp <span style="color: #FF0000">(</span>fact <span style="color: #993399">3</span><span style="color: #FF0000">))</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
On line 1, the "at-both-times" macro is invoked, taking the unevaluated
definition of "fact" as
as argument, interpreting it at compile-time, and compiling it for use at runtime.
</p>
</li>
<li>
<p>
On lines 2-5, the definition of the "fact".
</p>
</li>
<li>
<p>
On line 7, "at-compile-time-expand" is a macro which takes unevaluated code,
evaluates it to a new form which is then compiled by the compiler.  At compile-time the code
will expand to "(pp 6)".
</p>
</li>
<li>
<p>
On line 8, the run-time calculation of "(fact 3)".
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_inspecting_the_gambit_vm_bytecode">2.3.1. Inspecting the Gambit VM Bytecode</h4>
<div class="paragraph"><p>By compiling the Scheme source to the "gvm" intermediate
representation, the previously stated behavior can be verified.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">    1:</span>   r1 = '6
<span style="color: #000000">    2:</span>   r0 = #4
<span style="color: #000000">    3:</span>   jump/safe fs=4 global[pp] nargs=1
<span style="color: #000000">    4:</span> #4 fs=4 return-point
<span style="color: #000000">    5:</span>   r1 = '3
<span style="color: #000000">    6:</span>   r0 = #5
<span style="color: #000000">    7:</span>   jump/safe fs=4 global[fact] nargs=1
<span style="color: #000000">    8:</span> #5 fs=4 return-point
<span style="color: #000000">    9:</span>   r0 = frame[1]
<span style="color: #000000">   10:</span>   jump/poll fs=4 #6
<span style="color: #000000">   11:</span> #6 fs=4
<span style="color: #000000">   12:</span>   jump/safe fs=0 global[pp] nargs=1</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Lines 1-4 correspond to "(pp {at-compile-time-expand (fact 3)})".  The precomputed
value of "(fact 3)" is 6, which is directly stored into a GVM register, and
then the "pp" routine is called to print it.
</p>
</li>
<li>
<p>
Lines 5-12 correspond to "(pp (fact 3))".  3 is stored in a GVM register, "fact"
is called, the result of which is passed to "pp".
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_comparison_of_power">2.4. Comparison of Power</h3>
<div class="paragraph"><p>Although the compile-time languages both of C&#43;&#43; and of libbug are Turing complete,
they vary in actual real-world programming power.  The language used
for compile-time calculation of "fact" in C&#43;&#43; is a drastically different language than
the one used for run-time.  Although not fully demonstrated in this book,
C&#43;&#43; template metaprogramming relies exclusively on recursion for repetition (it has no
looping construct), it has no mutable state, and it lacks the ability to do input/output
(I/O) <span class="footnote"><br>[For the masochist who wants to know more about the C&#43;&#43;'s compile-time language, I recommend &lt;<a href="#ctm">[ctm]</a>&gt;]<br></span></p></div>
<div class="paragraph"><p>In contrast, the compile-time
language in libbug is the exact same language as the one that the compiler
is compiling, complete with state and I/O!  How can that power be used?
This book is the beginning of an answer.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_acknowledgments">3. Appendix B: Acknowledgments</h2>
<div class="sectionbody">
<div class="paragraph"><p>Thanks to Dr. Marc Feeley, for Gambit Scheme, for his mailing list postings
which inspired the foundations of this book, and for reviewing this
book.  Thanks to Adam from the Gambit mailing lists for reviewing the book,
as well as his suggestion for naming convention standards.</p></div>
<div class="paragraph"><p>Thanks to Dr. John McCarthy for Lisp.</p></div>
<div class="paragraph"><p>Thanks to Dr. Gerald Sussman and Dr. Guy Steele Jr for Scheme.</p></div>
<div class="paragraph"><p>Thanks to Dr. Paul Graham for "On Lisp", not only for the excellent macros,
but also for demonstrating why writing well matters.</p></div>
<div class="paragraph"><p>Thanks to Dr. Donald Knuth for TeX, and thanks to all contributors to
LaTeX.</p></div>
<div class="paragraph"><p>Thanks to Dr. Alan Kay for Smalltalk, the first language I loved.  Lisp may be the best high-level language, but Smalltalk is the best high-level environment.</p></div>
<div class="paragraph"><p>And most importantly, thanks to my wife Teresa, for everything.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_related_work">4. Appendix C: Related Work</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
Jonathan Blow. <a href="https://www.youtube.com/watch?v=UTqZNujQOlA">https://www.youtube.com/watch?v=UTqZNujQOlA</a>
</p>
</li>
<li>
<p>
"Compile-time Unit Testing",
Aron Barath and Zoltan Porkolab, Eotvos Lorand University,
<a href="http://ceur-ws.org/Vol-1375/SQAMIA2015\_Paper1.pdf">http://ceur-ws.org/Vol-1375/SQAMIA2015\_Paper1.pdf</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_bibliography">5. Bibliography</h2>
<div class="sectionbody">
<div class="ulist bibliography"><ul>
<li>
<p>
<a id="sicp"></a>[sicp] Abelon, Harold, Gerald Jay Sussman, and Julie Sussman.
  <em>Structure and Interpretation of Computer Programs</em>,
  The MIT Press, Massachusetts,
  Second Edition,
  1996.
</p>
</li>
<li>
<p>
<a id="ctm"></a>[ctm]
  Abrahams, David and Aleksey Gurtovoy
  <em>C&#43;&#43; Template Metaprogramming</em>,
  Addison Wesley
  2004.
</p>
</li>
<li>
<p>
<a id="calculi"></a>[calculi]
  Church, Alonzo
  <em>The Calculi of Lambda-Conversion</em>,
  Princeton University Press, New Jersey,
  Second Printing,
  1951.
</p>
</li>
<li>
<p>
<a id="schemeprogramminglanguage"></a>[schemeprogramminglanguage]
  Dybvig, R. Kent.
  <em>The Scheme Programming Language</em>,
  The MIT Press, Massachusetts,
  Third Edition,
  2003.
</p>
</li>
<li>
<p>
<a id="evalduringmacroexpansion"></a>[evalduringmacroexpansion]
  Feeley, Marc. <a href="https://mercure.iro.umontreal.ca/pipermail/gambit-list/2012-April/005917.html">https://mercure.iro.umontreal.ca/pipermail/gambit-list/2012-April/005917.html</a>, 2012
</p>
</li>
<li>
<p>
<a id="littleschemer"></a>[littleschemer]
  Friedman, Daniel P., and Matthias Felleisen
  <em>The Scheme Programming Language</em>,
  The MIT Press, Massachusetts,
  Fourth Edition,
  1996.
</p>
</li>
<li>
<p>
<a id="onlisp"></a>[onlisp]
  Graham, Paul.
  <em>On Lisp</em>,
  Prentice Hall, New Jersey,
  1994.
</p>
</li>
<li>
<p>
<a id="ansicl"></a>[ansicl]
  Graham, Paul.
  <em>ANSI Common Lisp</em>,
  Prentice Hall, New Jersey,
  1996.
</p>
</li>
<li>
<p>
<a id="ss"></a>[ss]
  Harvey, Brian and Matthew Wright.
  <em>Simply Scheme - Introducing Computer Science</em>,
  The MIT Press, Massachusetts,
  Second Edition,
  2001.
</p>
</li>
<li>
<p>
<a id="hmu2001"></a>[hmu2001]
  Hopcroft, John E., Rajeev Motwani, and Jeffrey D. Ullman.
  <em>Introduction to Automata Theory, Languages, and Computation</em>,
  Addison Wesley, Massachusetts,
  Second Edition,
  2001.
</p>
</li>
<li>
<p>
<a id="setf"></a>[setf]
  Kiselyov, Oleg. <a href="http://okmij.org/ftp/Scheme/setf.txt">http://okmij.org/ftp/Scheme/setf.txt</a> , 1998.
</p>
</li>
<li>
<p>
<a id="taocp"></a>[taocp]
  Knuth, Donald E.
  <em>The Art Of Computer Programming, Volume 1</em>,
  Addison Wesley, Massachusetts,
  Third Edition,
  1997.
</p>
</li>
<li>
<p>
<a id="paip"></a>[paip]
  Norvig, Peter
  <em>Paradigms of Artificial Intelligence Programming: Case Studies in Common Lisp</em>,
  San Francisco, CA
  1992.
</p>
</li>
<li>
<p>
<a id="tapl"></a>[tapl]
  Pierce, Benjamin C.
  <em>Types and Programming Languages</em>,
  The MIT Press
  Cambridge, Massachusetts
  2002.
</p>
</li>
<li>
<p>
<a id="crypto"></a>[crypto]
  Stallings, William
  <em>Cryptography and Network Security</em>,
  Pearson Education, Upper Saddle River, New Jersey,
  Third Edition,
  2002.
</p>
</li>
<li>
<p>
<a id="cl"></a>[cl]
  Steele Jr, Guy L.
  <em>Common Lisp the Language</em>,
  Digital Press,
  1990.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_example_index">6. Example Index</h2>
<div class="sectionbody">
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated
 2018-06-10 13:55:43 EST
</div>
</div>
</body>
</html>
